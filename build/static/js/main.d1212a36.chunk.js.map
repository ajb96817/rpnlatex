{"version":3,"sources":["Keymap.js","Models.js","Actions.js","App.js","serviceWorkerRegistration.js","index.js"],"names":["EditorKeymap","base","\"","files","keymap","help","stack","config","config_math_alignment","config_stack","config_theme","config_zoom","accumulate","delimiters","custom_delimiters","operator","hyperbolic","inverse","inverse_hyperbolic","squared","squared_hyperbolic","integral_limits","derivative","infix","relational","symbol","decoration","color","array","editor","script","calligraphic","lowercase_greek","uppercase_greek","Keymap","this","bindings","KeybindingTable","mode","key","mode_map","test","Settings","current_keymap","selected_theme","last_opened_filename","popup_mode","layout","default_layout","zoom_factor","stack_rightalign_math","document_rightalign_math","stack_side","stack_split","stack_panel_elt","document_panel_elt","popup_panel_elt","style","display","root_elt","document","getElementById","percentage","Math","round","pow","fontSize","_split_rectangle","x","y","w","h","stack_bounds","document_bounds","_apply_bounds","bounds","side","split_percent","w1","w2","h1","h2","elt","left","top","width","height","serialized_string","JSON","stringify","to_json","localStorage","setItem","json","saved_keys","forEach","getItem","from_json","parse","s","LatexEmitter","tokens","last_token_type","text","token_type","length","push","expr","emit_latex","force_braces","grouped","fn","old_tokens","old_last_token_type","join","emit_token","last_token","_is_latex_identifier_char","charAt","ch","command_name","command_options","startsWith","command","slice","envname","AppState","_default_stack","Document","is_dirty","item","MarkdownItem","Stack","app_state","format","UndoStack","state_stack","max_stack_depth","undo_count","initial_app_state","state","same_as","DocumentStorage","open_request","database","onsuccess","indexedDB","on_open_success","open","onupgradeneeded","handle_upgrade_database","bind","handle_open_success","onerror","handle_open_error","event","result","oldVersion","build_initial_schema","createObjectStore","keyPath","onversionchange","close","alert","readwrite","transaction","filename","replaceAll","trim","request","create_transaction","objectStore","get","serialized_json","metadata_json","filesize","description","stack_item_count","depth","document_item_count","items","timestamp","Date","put","oncomplete","onabort","delete","getAll","row","ts_value","onrowfetched","onfinished","cursor","openCursor","c","target","value","continue","ImportExportState","document_storage","import_count","failed_count","error_message","download_url","import_result_string","file_list_needs_update","onstatechange","date","getFullYear","toString","toLocaleString","month","toLowerCase","getDate","padStart","new_state","zip","JSZip","fetch_all_documents","add_document_json_to_zip","start_compressing","change_state","file","generateAsync","type","then","content_blob","finished_compressing","URL","revokeObjectURL","clear_download_url","createObjectURL","zipfile","reader","FileReader","addEventListener","process_uploaded_data","readAsArrayBuffer","data","loadAsync","promises","endsWith","async","content","import_file","name","Promise","all","parsed","e","save_state","FileManagerState","file_list","selected_filename","current_filename","unavailable","field","ascending","sort","a","b","a_value","b_value","basename","replace","n","candidate","some","offset","new_filename","f","index","new_index","Expr","emitter","finished_string","expr_type","json_keys","json_key","obj","undefined","map","to_latex","found","visit","old_expr","new_expr","CommandExpr","_list","operand_exprs","options","PrefixExpr","_expr","base_expr","prefix_expr","InfixExpr","operator_expr","left_expr","right_expr","DeferExpr","TextExpr","SequenceExpr","exprs","DelimiterExpr","left_type","right_type","middle_type","inner_exprs","SubscriptSuperscriptExpr","subscript_expr","superscript_expr","ArrayExpr","array_type","row_count","column_count","_list2d","element_exprs","AccumulatorExpr","accumulator_type","json_array","expr_json","row_exprs","right","concat","combine_pair","combine_exprs","indexOf","operand_expr","grouped_expr","substitute_expr","op_expr","operand_count","op","operator_text","text_or_command","needs_autoparenthesization","parenthesize","t","make_cell","new_element_exprs","inserted_row_exprs","i","splice","_transpose_cell","cell_expr","begin_environment","row_index","row_separator","col_index","align_separator","end_environment","split_mode","_split_expr","alpha_regex","_latex_escape","replacements","match","_to_display_expr","is_empty","Item","serial","next_serial","prefix","serial_number","item_type","ExprItem","tag_expr","source_text","string","latex","to_text","rendered_html","render_markdown","marked","check","underflow","_unchecked_pop","check_exprs","type_error","new_stack","pop_exprs","parseInt","every","is_matrix","Error","push_all","push_all_exprs","object_type","item_json","selection_index","new_item","selected_item","delete_selection","move_selection_by","insert_item","InputContext","app_component","settings","new_mode","new_document","files_changed","file_saved","notification_text","perform_undo_or_redo","minieditor","active","peek","effective_mode","lookup_binding","last_keypress","process_command","commands","split","piece","token","process_command_batch","parameters","handler_function","new_app_state","message","error_flash_stack","dom_element","classList","remove","offsetWidth","add","error_flash_element","elt_ids","elt_id","child_expr","is_superscript","autoparenthesize","_build_subscript_superscript","push_expr","make_subscript_superscript","new_prime_expr","new_superscript_expr","is_prime_command","switch_to_mode","pop","pop_positive_integer","item_count","new_stack_2","reverse","amount_string","amount","shift_selection_by","error_flash_document","file_manager_state","do_save_file_as","notify","save","request_file_list","window","prompt","sanitize_filename","do_save_file","start_loading_filename","generate_unused_filename","do_toggle_popup","offset_string","find_adjacent_filename","confirm","delete_state","arg","do_insert_markdown","do_edit_stack_top","inserted_text","edited_item","_insert_text_into_minieditor","editor_elt","ref","current","setRangeText","selectionStart","selectionEnd","focus","execCommand","old_item","from_string","do_insert","case_type","convert_fn","toUpperCase","opname","arity_string","arity","popped_exprs","result_expr","funcname","superscript_text","arg_expr","hat_op","inner_expr","colorname","accumulate_type","delimiter_type","middle","_finish_custom_delimiters","d","overset_op","infix_expr","stacked_expr","new_op_expr","concat_mode","left_item","right_item","new_text","original_expr","substitution_expr","defer_expr","find_defer","is_valid_character","with_extra_character","do_finish_text_input","without_last_character","textstyle","finished_expr","expr_count_string","expr_count","arg_count_string","arg_count","command_expr","mode_string","scrollTop","help_scroll_top","apply_layout_to_dom","config_option","clear_all_flashes","matrix_type","matrix_expr","pop_matrices","m1","m2","new_array","array_expr","split_rows","dissolved_exprs","with_ellipses","transposed","align_type","split_elements","separator_text","final_separator_text","infix_operator_expr","new_stack_3","tagged_item","tag_item","clipboard_item","screen_percentage_string","screen_percentage","container","selected_elts","getElementsByClassName","selected_elt","top_scrolltop","offsetTop","bottom_scrolltop","offsetHeight","clientHeight","ratio","new_scrolltop","percentage_string","panel_elt","exported_text","navigator","clipboard","writeText","$e","React","createElement","App","props","load_from_local_storage","import_export_state","input_context","undo_stack","clear","import_export_state_changed","handleKeyDown","handleBeforeUnload","handleVisibilityChange","open_database","on_open_database","setState","fetch_file_list","file_list_request_finished","file_list_request_error","sort_file_list","load_state","file_load_finished","file_load_error","error","stack_panel_ref","document_panel_ref","popup_panel_ref","removeEventListener","createRef","id","className","ModeIndicatorComponent","StackItemsComponent","DocumentComponent","PopupPanelComponent","altKey","metaKey","_keyname_from_event","handle_key","was_handled","preventDefault","scratch","manage_undo_state","state_updates","shiftKey","ctrlKey","undo_state","redo_state","push_state","Component","indicator_item","colon","minieditor_active","minieditor_index","item_components","MiniEditorComponent","textarea_ref","ItemComponent","selected","item_ref","react_key","class_names","subcomponents","is_selected","selected_item_ref","top_is_selected","class_name","selection_indicator","ensure_selection_visible","extra_space","onInput","handleOnInput","spellCheck","textarea","initial_text","FileManagerComponent","show_import_export","file_input_ref","render_file_table","render_shortcuts","render_export_import_section","textual_state","href","onClick","start_exporting","download_available","export_filename","generate_download_filename","download","handle_file_upload","fontWeight","colSpan","_render_file_list_row","floor","toLocaleDateString","toLocaleTimeString","keyhelp_elements","spec","keyname","helptext","file_input_elt","start_importing","tag_ref","dangerouslySetInnerHTML","__html","node","_render_with_katex","children","getElementsByTagName","codespan","latex_code","textContent","display_mode","katex","render","throwOnError","displayMode","fleqn","trust","msg","innerHTML","refs","help_content","subcomponent","KeymapTableComponent","help_source_elt","help_dest_elt","_render_help_latex","parentNode","removeChild","appendChild","help_elt","code_elt","render_rows","sections","get_sorted_mode_names","rows_for_mode","modes","Object","keys","entries","row_for_mode_and_key","command_elt","isLocalhost","Boolean","location","hostname","registerValidSW","swUrl","serviceWorker","register","registration","onupdatefound","installingWorker","installing","controller","console","log","onUpdate","onSuccess","catch","ReactDOM","process","origin","fetch","headers","response","contentType","status","ready","unregister","reload","checkValidServiceWorker","serviceWorkerRegistration"],"mappings":"6RA4oBeA,EA3oBM,CACjBC,KAAM,CAET,UAAW,cACX,IAAK,kBACL,IAAK,aACL,IAAK,WACL,IAAK,cACL,IAAK,WACL,IAAK,eAGL,SAAU,qBACV,SAAU,wBACV,SAAU,uBACV,SAAU,uBACV,SAAU,uBACV,SAAU,OACV,SAAU,oBACV,SAAU,qDACV,SAAU,kBACV,SAAU,wBACV,SAAU,YACV,SAAU,uBACV,SAAU,WACV,SAAU,gEACV,SAAU,iBACV,SAAU,YACV,SAAU,cACV,SAAU,uBACV,SAAU,OACV,SAAU,OACV,SAAU,YACV,SAAU,UAGV,cAAe,iBACf,IAAK,0BACL,IAAK,kBACL,IAAK,+BACL,IAAK,wBACL,IAAK,wBACL,IAAK,sBACL,IAAK,iBACL,IAAK,iBACL,IAAK,qBAGL,QAAW,+BACX,gBAAiB,8BACjB,UAAa,+BACb,kBAAmB,8BACnB,OAAU,+BACV,SAAY,+BACZ,KAAQ,mCACR,IAAO,mCAGP,IAAO,aACP,MAAS,YACT,UAAa,MACb,IAAK,cACL,IAAK,cACL,IAAK,kBACL,IAAK,aACL,IAAK,kBACL,IAAK,mBACL,IAAK,uBACL,IAAK,uBACL,IAAK,oBACL,IAAK,cACL,IAAK,gBACL,EAAK,kBACL,KAAM,mBACN,IAAK,aACL,EAAK,cACL,IAAK,oBACLC,IAAM,iBAGHC,MAAO,CACV,QAAW,qBAEX,EAAK,uBACL,EAAK,iBACL,MAAS,qBACT,EAAK,YACL,EAAK,eACL,QAAW,0BACX,UAAa,0BAGVC,OAAQ,CACX,QAAW,yBACX,UAAa,wBACb,QAAW,uBAGRC,KAAM,CACT,QAAW,yBACX,UAAa,wBACb,QAAW,qBAIRC,MAAO,CACV,EAAK,oBACL,EAAK,MACL,EAAK,kBACL,EAAK,mBACL,EAAK,wBACL,EAAK,uBACL,EAAK,uBACL,EAAK,MACL,EAAK,OACL,EAAK,uBACL,EAAK,MACL,EAAK,OACL,EAAK,QACL,EAAK,YACL,EAAK,cACL,EAAK,OACL,EAAK,cACL,MAAS,MACT,IAAO,OACP,IAAK,OACL,IAAK,MACL,IAAK,0BACL,IAAK,2BAGL,EAAK,qBACL,EAAK,uBAIFC,OAAQ,CAGX,EAAK,6BACL,EAAK,sBACL,EAAK,oBACL,EAAK,oBACL,EAAK,mBAEL,EAAK,cAGFC,sBAAuB,CAC1B,EAAK,oCACL,EAAK,kCAGFC,aAAc,CACjB,EAAK,uBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,IAAK,yBAEL,UAAa,yBACb,WAAc,0BACd,QAAW,wBACX,UAAa,4BAGVC,aAAc,CACjB,EAAK,uBACL,EAAK,oBACL,EAAK,oBACL,EAAK,qBAGFC,YAAa,CAChB,EAAK,uBACL,IAAK,uBACL,IAAK,wBAIFC,WAAY,CACf,MAAS,oBACT,cAAe,0BACf,OAAU,MACV,UAAa,uBACb,QAAW,qBAIRC,WAAY,CACf,EAAK,6BACL,EAAK,6BACL,EAAK,+BACL,EAAK,+BACL,EAAK,wCACL,EAAK,wCACL,EAAK,6BACL,EAAK,uCACL,EAAK,6BACL,EAAK,6BACL,EAAK,sBACL,EAAK,sBACL,IAAK,2BACL,IAAK,+BACL,IAAK,iBACL,IAAK,iBACL,IAAK,+EACL,IAAK,sBAIFC,kBAAmB,CACtB,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,2BACL,EAAK,4BACL,EAAK,4BACL,EAAK,4BACL,EAAK,4BACL,EAAK,gCACL,EAAK,gCACL,EAAK,0BACL,IAAK,4BACL,IAAK,4BACL,IAAK,qBACL,IAAK,qBACL,IAAK,qBACL,IAAK,qBACL,IAAK,uBACL,IAAK,uBACL,IAAK,qBACL,IAAK,qBACL,KAAM,+BACN,IAAK,sBAIFC,SAAU,CACb,EAAK,gDACL,EAAK,eACL,EAAK,mBACL,EAAK,mBACL,EAAK,mBACL,EAAK,qBACL,EAAK,qBACL,EAAK,kBACL,EAAK,qBACL,EAAK,qDACL,EAAK,qBACL,EAAK,qBACL,EAAK,wBACL,EAAK,wBACL,EAAK,kBACL,EAAK,uBACL,EAAK,mEACL,EAAK,qBACL,EAAK,qBACL,EAAK,oBACL,EAAK,qBACL,EAAK,gEACL,EAAK,2BACL,EAAK,iBACL,EAAK,gBACL,EAAK,mBACL,EAAK,qBACL,EAAK,qBACL,EAAK,qBACL,EAAK,qBACL,EAAK,mEACL,EAAK,mEACL,EAAK,qEACL,EAAK,sGACL,IAAK,YACL,IAAK,kBACL,KAAM,mBACN,IAAK,0DACL,IAAK,0DACL,IAAK,eACL,IAAK,mBACL,MAAS,wDAINC,WAAY,CACf,EAAK,sBACL,EAAK,sBACL,EAAK,sBACL,EAAK,sBACL,EAAK,sBACL,EAAK,uBAEFC,QAAS,CACZ,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,2BAEFC,mBAAoB,CACvB,EAAK,yBACL,EAAK,yBACL,EAAK,yBACL,EAAK,yBACL,EAAK,yBACL,EAAK,0BAEFC,QAAS,CACZ,EAAK,uBACL,EAAK,uBACL,EAAK,uBACL,EAAK,uBACL,EAAK,uBACL,EAAK,uBACL,EAAK,2BAEFC,mBAAoB,CACvB,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,wBACL,EAAK,yBAIFC,gBAAiB,CACpB,EAAK,wEACL,EAAK,sEACL,EAAK,qEACL,EAAK,2DACL,EAAK,+DACL,EAAK,uEAIFC,WAAY,CAEf,EAAK,sGAEL,EAAK,iJAEL,EAAK,iFAEL,EAAK,8HAEL,EAAK,oFAEL,EAAK,gIAEL,EAAK,+DAEL,EAAK,2GAEL,EAAK,2KAEL,EAAK,8LAEL,EAAK,2CAEL,EAAK,kEAEL,EAAK,6DAEL,EAAK,kEAIFC,MAAO,CACV,EAAK,cACL,EAAK,iBACL,EAAK,cACL,EAAK,mBACL,EAAK,eACL,EAAK,6EACL,EAAK,mBACL,EAAK,iBACL,EAAK,aACL,EAAK,eACL,EAAK,mBACL,EAAK,eACL,EAAK,aACL,EAAK,YACL,EAAK,aACL,EAAK,cACL,EAAK,oBACL,EAAK,cACL,EAAK,gBACL,EAAK,gBACL,EAAK,iBACL,IAAK,mBACL,IAAK,mBACL,IAAK,0BACL,IAAK,qBACL,IAAK,iBACL,IAAK,gBACL,IAAK,eACL,IAAK,UACL,IAAK,aACL,IAAK,UACL,IAAK,qBACL,IAAK,eACL,IAAK,UACL,KAAM,qBACN,IAAK,WAIFC,WAAY,CACf,EAAK,iBACL,EAAK,eACL,EAAK,gBACL,EAAK,cACL,EAAK,UACL,EAAK,aACL,EAAK,aACL,EAAK,gBACL,EAAK,UACL,EAAK,aACL,EAAK,aACL,EAAK,iBACL,EAAK,UACL,EAAK,mBACL,EAAK,iBACL,IAAK,UACL,IAAK,UACL,IAAK,UACL,IAAK,aACL,IAAK,aACL,IAAK,mBACL,IAAK,cACL,IAAK,iBAIFC,OAAQ,CACX,EAAK,sBACL,EAAK,YACL,EAAK,sDACL,EAAK,6CACL,EAAK,iBACL,EAAK,kBACL,EAAK,gBACL,EAAK,kBACL,EAAK,mBACL,EAAK,kBACL,EAAK,kBACL,EAAK,eACL,EAAK,gBACL,EAAK,eACL,EAAK,cACL,EAAK,gBACL,EAAK,gBACL,EAAK,cACL,EAAK,WACL,EAAK,eACL,EAAK,oBACL,EAAK,oBACL,EAAK,kBACL,EAAK,eACL,EAAK,iBACL,EAAK,gBACL,EAAK,iBACL,IAAK,gBACL,IAAK,iBACL,IAAK,WACL,IAAK,WACL,IAAK,gBACL,IAAK,WACL,IAAK,sBACL,IAAK,WACL,IAAK,WACL,IAAK,WACL,IAAK,mBACL,IAAK,WACL,IAAK,WACL,IAAK,eACL,IAAK,UACL,QAAW,mBACX,UAAa,sBAIVC,WAAY,CACf,EAAK,wBACL,EAAK,0BACL,EAAK,kBACL,EAAK,aACL,EAAK,8BACL,EAAK,+BACL,EAAK,gBACL,EAAK,qBACL,EAAK,mBACL,EAAK,oBACL,EAAK,gBACL,EAAK,oBACL,EAAK,oBACL,EAAK,8BACL,EAAK,kBACL,EAAK,cACL,EAAK,eACL,EAAK,oBACL,EAAK,0BACL,EAAK,cACL,EAAK,kBACL,EAAK,kBACL,EAAK,cACL,EAAK,qBACL,EAAK,kBACL,EAAK,kBACL,EAAK,eACL,EAAK,kBACL,EAAK,sBACL,EAAK,iBACL,EAAK,gBACL,IAAK,eACLxB,IAAM,gBACN,IAAK,oBACL,IAAK,yBACL,IAAK,uBACL,IAAK,kBACL,IAAK,sBACL,IAAK,WACL,IAAK,WACL,IAAK,iBACL,IAAK,kBACL,KAAM,mBACN,EAAK,sBAIFyB,MAAO,CACV,EAAK,aACL,EAAK,cACL,EAAK,aACL,EAAK,cACL,EAAK,eACL,EAAK,eACL,EAAK,YACL,EAAK,cAIFC,MAAO,CACV,EAAK,sBACL,EAAK,oBACL,EAAK,qBACL,EAAK,kBACL,EAAK,8DACL,EAAK,yBACL,EAAK,uBACL,EAAK,iBACL,EAAK,0BACL,EAAK,qDACL,EAAK,eACL,EAAK,mBACL,EAAK,2BACL,EAAK,2BACL,IAAK,iBACL,IAAK,eACL,IAAK,kBACL,IAAK,sDACL,IAAK,0BACL,IAAK,2DACL,MAAS,iBACT,IAAK,2BACL,IAAK,2BACL,IAAK,4BAGFC,OAAQ,CACX,IAAO,iBACP,cAAe,iBAEf,kBAAmB,0BACnB,OAAU,kBAGPC,OAAQ,CACX,UAAW,qEACX,IAAK,cAGFC,aAAc,CACjB,UAAW,qEACX,IAAK,cAIFC,gBAAiB,CACpB,EAAK,iBAAsB,EAAK,gBAChC,EAAK,eAAsB,EAAK,iBAChC,EAAK,mBAAsB,EAAK,eAChC,EAAK,iBAAsB,EAAK,eAChC,EAAK,gBAAsB,EAAK,kBAChC,EAAK,iBAAsB,EAAK,kBAChC,EAAK,cAAsB,EAAK,cAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,oBAAsB,EAAK,eAChC,EAAK,iBAAsB,EAAK,eAChC,EAAK,mBAAsB,EAAK,iBAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,eAAsB,EAAK,gBAEhC,IAAK,mBAGFC,gBAAiB,CACpB,EAAK,iBAAsB,EAAK,sBAChC,EAAK,eAAsB,EAAK,iBAChC,EAAK,kBAAsB,EAAK,iBAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,oBAAsB,EAAK,kBAChC,EAAK,iBAAsB,EAAK,oBAChC,EAAK,mBAAsB,EAAK,iBAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,eACL,EAAK,iBAGL,EAAK,iBAAsB,EAAK,sBAChC,EAAK,eAAsB,EAAK,iBAChC,EAAK,kBAAsB,EAAK,iBAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,oBAAsB,EAAK,kBAChC,EAAK,iBAAsB,EAAK,oBAChC,EAAK,mBAAsB,EAAK,iBAChC,EAAK,iBAAsB,EAAK,cAChC,EAAK,eACL,EAAK,iBAEL,IAAK,Y,kCChoBAC,E,WACF,aAAe,oBACXC,KAAKC,SAAWC,E,kDAGpB,SAAeC,EAAMC,GACjB,IAAMC,EAAWL,KAAKC,SAASE,GAC/B,OAAIE,EACDA,EAASD,GAAaC,EAASD,GAC/BC,EAAS,YAAc,aAAaC,KAAKF,GAAaC,EAAS,WAC/DA,EAAS,YAAc,UAAUC,KAAKF,GAAaC,EAAS,WAC5DA,EAAS,YAAc,gBAAgBC,KAAKF,GAAaC,EAAS,WAClEA,EAAQ,QAAoBA,EAAQ,QAClC,SAATF,GAA4B,WAATA,EACX,KAEA,SATiB,S,KAcvBI,E,WAeF,aAAe,oBACXP,KAAKQ,eAAiB,IAAIT,EAC1BC,KAAKS,eAAiB,UACtBT,KAAKU,qBAAuB,KACnCV,KAAKW,WAAa,KAClBX,KAAKY,OAASZ,KAAKa,iB,kDAGhB,WACH,MAAO,CACHC,YAAa,EACbC,uBAAuB,EACvBC,0BAA0B,EAC1BC,WAAY,OACZC,YAAa,M,iCAId,SAAoBC,EAAiBC,EAAoBC,GAC5D,IAAMT,EAASZ,KAAKY,OAGpBS,EAAgBC,MAAMC,QAAUvB,KAAKW,WAAa,QAAU,OAG5D,IAAMa,EAAWC,SAASC,eAAe,QACnCC,EAAaC,KAAKC,MAAM,IAAID,KAAKE,IAAI,KAAMlB,EAAOE,aAAe,IACvEU,EAASF,MAAMS,SAAWJ,EAAa,IAGvC,MAAsC3B,KAAKgC,iBACvC,CAACC,EAAG,EAAGC,EAAG,EAAGC,EAAG,IAAKC,EAAG,KAAMxB,EAAOK,WAAYL,EAAOM,aAD5D,mBAAKmB,EAAL,KAAmBC,EAAnB,KAGAtC,KAAKuC,cAAcpB,EAAiBkB,GACpCrC,KAAKuC,cAAcnB,EAAoBkB,K,8BAKpC,SAAiBE,EAAQC,EAAMC,GAClC,IAAMC,EAAKf,KAAKC,MAAMa,EAAcF,EAAOL,EAAE,KACvCS,EAAKJ,EAAOL,EAAIQ,EAChBE,EAAKjB,KAAKC,MAAMa,EAAcF,EAAOJ,EAAE,KACvCU,EAAKN,EAAOJ,EAAIS,EACtB,OAAOJ,GACP,IAAK,OACD,MAAO,CACV,CAACR,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAGC,EAAGQ,EAAIP,EAAGI,EAAOJ,GAC5C,CAACH,EAAGO,EAAOP,EAAEU,EAAIT,EAAGM,EAAON,EAAGC,EAAGS,EAAIR,EAAGI,EAAOJ,IAEhD,IAAK,QACD,MAAO,CACV,CAACH,EAAGO,EAAOP,EAAEW,EAAIV,EAAGM,EAAON,EAAGC,EAAGQ,EAAIP,EAAGI,EAAOJ,GAC/C,CAACH,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAGC,EAAGS,EAAIR,EAAGI,EAAOJ,IAE7C,IAAK,MACD,MAAO,CACV,CAACH,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAGC,EAAGK,EAAOL,EAAGC,EAAGS,GAC3C,CAACZ,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAEW,EAAIV,EAAGK,EAAOL,EAAGC,EAAGU,IAE/C,IAAK,SACD,MAAO,CACV,CAACb,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAEY,EAAIX,EAAGK,EAAOL,EAAGC,EAAGS,GAC9C,CAACZ,EAAGO,EAAOP,EAAGC,EAAGM,EAAON,EAAGC,EAAGK,EAAOL,EAAGC,EAAGU,IAE5C,QACI,MAAO,CAACN,EAAQA,M,2BAIjB,SAAcO,EAAKP,GACtBO,EAAIzB,MAAM0B,KAAOR,EAAOP,EAAI,IAC5Bc,EAAIzB,MAAM2B,IAAMT,EAAON,EAAI,IAC3Ba,EAAIzB,MAAM4B,MAAQV,EAAOL,EAAI,IAC7BY,EAAIzB,MAAM6B,OAASX,EAAOJ,EAAI,M,kBAG3B,WACI,IAAMgB,EAAoBC,KAAKC,UAAUtD,KAAKuD,WAC9CC,aAAaC,QAAQ,WAAYL,K,qBAGrC,WAAW,IAAD,OACFM,EAAO,GAEX,OADAnD,EAASoD,WAAWC,SAAQ,SAAAxD,GAASsD,EAAKtD,GAAO,EAAKA,MAC/CsD,K,sCAnGX,WACI,IAAMN,EAAoBI,aAAaK,QAAQ,YAC/C,OAAGT,EACQ7C,EAASuD,UAAUT,KAAKU,MAAMX,IAE9B,IAAI7C,I,uBAGnB,SAAiBmD,GACb,IAAIM,EAAI,IAAIzD,EAEZ,OADAA,EAASoD,WAAWC,SAAQ,SAAAxD,GAAS4D,EAAE5D,GAAOsD,EAAKtD,MAC5C4D,M,KA4FfzD,EAASoD,WAAa,CAClB,iBAAkB,uBAAwB,aAAc,U,IAKtDM,E,WACF,aAAe,oBAClBjE,KAAKkE,OAAS,GACdlE,KAAKmE,gBAAkB,K,8CAGpB,SAAWC,EAAMC,GACjBD,EAAKE,OAAS,IACbtE,KAAKkE,OAAOK,KAAKH,GACjBpE,KAAKmE,gBAAkBE,K,kBAIxB,SAAKG,GAAQA,EAAKC,WAAWzE,Q,0BAE7B,SAAawE,EAAME,GAAe,IAAD,OAAE1E,KAAK2E,SAAS,kBAAM,EAAKH,KAAKA,KAAQE,K,qBAEzE,SAAQE,EAAIF,GACf,MAAwC,CAAC1E,KAAKkE,OAAQlE,KAAKmE,iBAAtDU,EAAL,KAAiBC,EAAjB,KAD6B,EAES,CAAC,GAAI,MAA1C9E,KAAKkE,OAFuB,KAEflE,KAAKmE,gBAFU,KAI7BS,IAEA,MAAkC,CAAC5E,KAAKkE,OAAQlE,KAAKmE,iBAA9CD,EAAP,KAAeC,EAAf,KACAnE,KAAKkE,OAASW,EACd7E,KAAKmE,gBAAkBW,EAMH,UAAjBJ,GAA8C,IAAlBR,EAAOI,QAAgBJ,EAAOI,OAAS,GAClEtE,KAAKoE,KAAK,KACVpE,KAAKoE,KAAKF,EAAOa,KAAK,KACtB/E,KAAKoE,KAAK,MAGa,SAApBD,EACkB,IAArBD,EAAO,GAAGI,OACTtE,KAAKoE,KAAKF,EAAO,KAEjBlE,KAAKoE,KAAK,KACVpE,KAAKoE,KAAKF,EAAO,IACjBlE,KAAKoE,KAAK,MAGc,mBAAjBM,GACX1E,KAAKoE,KAAK,KACVpE,KAAKgF,WAAWd,EAAO,GAAI,WAC3BlE,KAAKoE,KAAK,MAGVpE,KAAKgF,WAAWd,EAAO,GAAI,a,kBAKzB,SAAKE,GACR,GAA4B,YAAzBpE,KAAKmE,gBAA+B,CAGnC,IAAMc,EAAajF,KAAKkE,OAAOlE,KAAKkE,OAAOI,OAAO,GAC/CtE,KAAKkF,0BAA0BD,EAAWE,OAAOF,EAAWX,OAAO,KAClEtE,KAAKkF,0BAA0Bd,EAAKe,OAAO,KAClDnF,KAAKgF,WAAW,IAAK,QAEtBhF,KAAKgF,WAAWZ,EAAM,U,uCAGnB,SAA0BgB,GAC7B,MAAO,aAAa9E,KAAK8E,K,qBAItB,SAAQC,EAAcC,GACtBA,IACCD,EAAeA,EAAe,IAAMC,EAAkB,KAC1DtF,KAAKgF,WAAW,KAAOK,EAAc,a,6BAIlC,SAAgBjB,GAChBA,EAAKmB,WAAW,MACfvF,KAAKwF,QAAQpB,EAAKqB,MAAM,IAExBzF,KAAKoE,KAAKA,K,+BAGX,SAAkBsB,GAAW1F,KAAKoE,KAAK,WAAasB,EAAU,S,6BAE9D,SAAgBA,GAAW1F,KAAKoE,KAAK,WAAasB,EAAU,S,6BAE5D,WAAoB1F,KAAKoE,KAAK,S,2BAG9B,WAGHpE,KAAKoE,KAAK,mB,6BAIP,WAAoB,OAAOpE,KAAKkE,OAAOa,KAAK,Q,KAK1CY,E,WAQF,WAAYxH,EAAOsD,GAAW,oBAC1BzB,KAAK7B,MAAQA,GAAS6B,KAAK4F,iBAC3B5F,KAAKyB,SAAWA,GAAY,IAAIoE,EAAS,GAAI,GACpD7F,KAAK8F,UAAW,E,kDAGb,WACH,IAAMC,EAAO,IAAIC,EAAa,yDAC9B,OAAO,IAAIC,EAAM,CAACF,M,qBAGf,SAAQG,GAGJ,OAAOlG,KAAK7B,QAAU+H,EAAU/H,OAAS6B,KAAKyB,WAAayE,EAAUzE,W,qBAGzE,WACI,MAAO,CACHtD,MAAO6B,KAAK7B,MAAMoF,UAClB9B,SAAUzB,KAAKyB,SAAS8B,UAC/B4C,OAAQ,M,wBA5BT,SAAiBzC,GACb,OAAO,IAAIiC,EACPM,EAAMnC,UAAUJ,EAAKvF,OACrB0H,EAAS/B,UAAUJ,EAAKjC,e,KA+B9B2E,E,WACF,aAAe,oBAEXpG,KAAKqG,YAAc,GAGnBrG,KAAKsG,gBAAkB,IAIvBtG,KAAKuG,WAAa,E,yCAGtB,SAAMC,GACFxG,KAAKqG,YAAc,CAACG,GACpBxG,KAAKuG,WAAa,I,wBAGtB,SAAWE,GAEP,OAAGzG,KAAKqG,YAAY/B,OAAStE,KAAKuG,YAC/BvG,KAAKqG,YAAYrG,KAAKqG,YAAY/B,OAAStE,KAAKuG,WAAa,GAAGG,QAAQD,GAChE,MAERzG,KAAKuG,WAAa,IAGjBvG,KAAKqG,YAAcrG,KAAKqG,YAAYZ,MAAM,EAAGzF,KAAKqG,YAAY/B,OAAStE,KAAKuG,YAC5EvG,KAAKuG,WAAa,GAGtBvG,KAAKqG,YAAY9B,KAAKkC,GAGnBzG,KAAKqG,YAAY/B,OAAStE,KAAKsG,kBAC9BtG,KAAKqG,YAAcrG,KAAKqG,YAAYZ,MAAMzF,KAAKqG,YAAY/B,OAAStE,KAAKsG,kBAEtEG,K,wBAGX,WACI,OAAGzG,KAAKqG,YAAY/B,OAAO,EAAItE,KAAKuG,YAChCvG,KAAKuG,aACEvG,KAAKqG,YAAYrG,KAAKqG,YAAY/B,OAAStE,KAAKuG,WAAa,IAE5D,O,wBAGhB,WACI,OAAGvG,KAAKuG,WAAa,GACjBvG,KAAKuG,aACEvG,KAAKqG,YAAYrG,KAAKqG,YAAY/B,OAAStE,KAAKuG,WAAa,IAE5D,S,KAKdI,E,WACF,aAAe,oBAClB3G,KAAK4G,aAAe,KACpB5G,KAAK6G,SAAW,K,iDAGb,SAAcC,GACbC,YACJ/G,KAAKgH,gBAAkBF,EACvB9G,KAAK4G,aAAeG,UAAUE,KAAK,WAAY,GAC/CjH,KAAK4G,aAAaM,gBAAkBlH,KAAKmH,wBAAwBC,KAAKpH,MACtEA,KAAK4G,aAAaE,UAAY9G,KAAKqH,oBAAoBD,KAAKpH,MAC5DA,KAAK4G,aAAaU,QAAUtH,KAAKuH,kBAAkBH,KAAKpH,S,qCAGrD,SAAwBwH,GAE3B,OADAxH,KAAK6G,SAAW7G,KAAK4G,aAAaa,OAC3BD,EAAME,YACb,KAAK,EAAG1H,KAAK2H,0B,kCAKV,WACH3H,KAAK6G,SAASe,kBAAkB,YAAa,CAACC,QAAS,aACvD7H,KAAK6G,SAASe,kBAAkB,qBAAsB,CAACC,QAAS,e,+BAG7D,SAAkBL,GAErBxH,KAAK4G,aAAe,O,iCAGjB,SAAoBY,GACvBxH,KAAK6G,SAAW7G,KAAK4G,aAAaa,OAClCzH,KAAK4G,aAAe,KACpB5G,KAAK6G,SAASiB,gBAAkB,WAC5B9H,KAAK6G,SAASkB,QACd/H,KAAK6G,SAAW,KAChBmB,MAAM,2DAEPhI,KAAKgH,iBAAiBhH,KAAKgH,oB,gCAG3B,SAAmBiB,GACtB,OAAOjI,KAAK6G,SAASqB,YACjB,CAAC,YAAa,sBACdD,EAAY,YAAc,c,+BAG3B,SAAkBE,GACd,IAAMvD,EAAKuD,EAASC,WAAW,kBAAmB,IAAIC,OACtD,OAAsB,IAAdzD,EAAGN,QAAgBM,EAAGN,OAAS,IAAO,KAAOM,I,wBAGzD,SAAWuD,EAAUrB,EAAWQ,GACnC,IAAItH,KAAK6G,SAAU,OAAOS,IAC1B,IAEIgB,EAFctI,KAAKuI,oBAAmB,GACTC,YAAY,aAChBC,IAAIN,GACjCG,EAAQxB,UAAY,WAIhB,GADawB,EAAQb,OACZ,CACZ,IAAMvB,EAAYP,EAAS7B,UAAUwE,EAAQb,QAC7CX,EAAUqB,EAAUjC,QAGpBoB,EAAQa,EAAU,QAEnBG,EAAQhB,QAAU,WACdA,EAAQa,EAAU,U,wBAInB,SAAWjC,EAAWiC,EAAUrB,EAAWQ,GAC9C,IAAItH,KAAK6G,SAAU,OAAOS,IACnB,IAAIoB,EAAkBxC,EAAU3C,UACvCmF,EAAgBP,SAAWA,EAK3B,IAEMQ,EAAgB,CAClBR,SAAUA,EACVS,SAJavF,KAAKC,UAAUoF,GAAiBpE,OAK7CuE,YAAa,GACbC,iBAAkB5C,EAAU/H,MAAM4K,QAClCC,oBAAqB9C,EAAUzE,SAASwH,MAAM3E,OAC9C4E,UAAW,IAAIC,MAGfjB,EAAclI,KAAKuI,oBAAmB,GAC1CL,EAAYM,YAAY,aAAaY,IAAIV,GACzCR,EAAYM,YAAY,sBAAsBY,IAAIT,GAC/C7B,IAAWoB,EAAYmB,WAAavC,GACpCQ,IAASY,EAAYoB,QAAUhC,K,0BAG/B,SAAaa,EAAUrB,EAAWQ,GACrC,IAAItH,KAAK6G,SAAU,OAAOS,IAC1B,IAAIY,EAAclI,KAAKuI,oBAAmB,GAC1CL,EAAYM,YAAY,aAAae,OAAOpB,GAC5CD,EAAYM,YAAY,sBAAsBe,OAAOpB,GAClDrB,IAAWoB,EAAYmB,WAAavC,GACpCQ,IAASY,EAAYoB,QAAUhC,K,6BAG/B,SAAgBR,EAAWQ,GAC9B,IAAItH,KAAK6G,SAAU,OAAOS,IAC1B,IACIgB,EADctI,KAAKuI,oBAAmB,GAChBC,YAAY,sBAAsBgB,SAC5DlB,EAAQxB,UAAY,WAChBwB,EAAQb,OAAO7D,SAAQ,SAAA6F,GAE1B,IAAMC,EAAWP,KAAKpF,MAAM0F,EAAIP,WAChCO,EAAIP,UAAYQ,EAAW,IAAIP,KAAKO,GAAY,QAE7C5C,EAAUwB,EAAQb,SAEtBa,EAAQhB,QAAUA,I,iCAKf,SAAoBqC,EAAcC,EAAYtC,GACjD,IAAItH,KAAK6G,SAAU,OAAOS,IAC1B,IACIuC,EADc7J,KAAKuI,oBAAmB,GACjBC,YAAY,aAAasB,aAClDD,EAAO/C,UAAY,SAACU,GAChB,IAAMuC,EAAIvC,EAAMwC,OAAOvC,OACpBsC,GACNJ,EAAaI,EAAEE,OACfF,EAAEG,YAGFN,KAEDC,EAAOvC,QAAUA,M,KAMZ6C,E,WACF,aAAe,oBAQlBnK,KAAKyG,MAAQ,OAEbzG,KAAKoK,iBAAmB,KAGxBpK,KAAKqK,aAAe,EAGpBrK,KAAKsK,aAAe,EACpBtK,KAAKuK,cAAgB,KAGrBvK,KAAKwK,aAAe,KAGpBxK,KAAKyK,qBAAuB,KAG5BzK,KAAK0K,wBAAyB,EAG9B1K,KAAK2K,cAAgB,K,iDAIlB,WACH,OAAO3K,KAAKyG,OACZ,IAAK,OAAQ,OAAOzG,KAAKwK,aAAe,iBAAmB,6BAC3D,IAAK,QAAS,MAAO,UAAYxK,KAAKuK,cACtC,IAAK,UAAW,MAAO,wBACvB,IAAK,UAAW,MAAO,uBACvB,IAAK,YAAa,MAAO,oBACzB,IAAK,YAAa,MAAO,wBAA0BvK,KAAKqK,aAAe,UACvE,QAAS,MAAO,S,gCAIb,WACH,MAAsB,SAAfrK,KAAKyG,OAAoBzG,KAAKwK,e,wCAGlC,WACH,IAAMI,EAAO,IAAIzB,KACjB,MAAO,CACH,YAAayB,EAAKC,cAAcC,WAAY,IAC5CF,EAAKG,eAAe,UAAW,CAACC,MAAO,UAAUC,cACjD,IAAKL,EAAKM,UAAUJ,WAAWK,SAAS,EAAG,KAAM,QACnDpG,KAAK,M,0BAGJ,SAAaqG,GAChBpL,KAAKyG,MAAQ2E,EACVpL,KAAK2K,eACJ3K,KAAK2K,cAAc3K,Q,6BAGpB,WAAmB,IAAD,OACjBoK,EAAmBpK,KAAKoK,iBAC5BpK,KAAKqL,IAAM,IAAIC,IACflB,EAAiBmB,qBACb,SAAC9B,GAAD,OAAS,EAAK+B,yBAAyB/B,MACvC,kBAAM,EAAKgC,uBACX,WACH,EAAKlB,cAAgB,0CACrB,EAAKmB,aAAa,YAEnB1L,KAAK0L,aAAa,a,sCAGf,SAAyBhI,GAC5B1D,KAAKqL,IAAIM,KAAKjI,EAAKyE,SAAW,QAAS9E,KAAKC,UAAUI,M,+BAGnD,WAAqB,IAAD,OACvB1D,KAAK0L,aAAa,WAClB1L,KAAKqL,IAAIO,cAAc,CAACC,KAAM,SAASC,MAAK,SAAAC,GACxC,EAAKC,qBAAqBD,Q,gCAI3B,WACA/L,KAAKwK,eACJyB,IAAIC,gBAAgBlM,KAAKwK,cACzBxK,KAAKwK,aAAe,Q,kCAIrB,SAAqBuB,GACxB/L,KAAKmM,qBACLnM,KAAKwK,aAAeyB,IAAIG,gBAAgBL,GACxC/L,KAAKqL,IAAM,KACXrL,KAAK0L,aAAa,U,6BAIf,SAAgBW,GAAU,IAAD,OAG5B,GAFArM,KAAKmM,qBACLnM,KAAKyK,qBAAuB,KACR,oBAAjB4B,EAAQR,KAAX,CAIA7L,KAAK0L,aAAa,aAClB,IAAIY,EAAS,IAAIC,WACjBD,EAAOE,iBACH,QACA,SAAAhF,GAAK,OAAI,EAAKiF,sBAAsBjF,EAAMwC,OAAOvC,WACrD6E,EAAOI,kBAAkBL,QARrBrE,MAAM,wC,mCAWP,SAAsB2E,GAAO,IAAD,OAC/B3M,KAAKqK,aAAe,EACpBrK,KAAKuK,cAAgB,KACrBvK,KAAK0L,aAAa,aAClBJ,IAAMsB,UAAUD,GAAMb,MAAK,SAAAO,GACvB,IAAIQ,EAAW,GADmB,WAE1B1E,GACX,IAAMwD,EAAOU,EAAQrO,MAAMmK,GACxBA,EAAS2E,SAAS,SACjBD,EAAStI,KACZoH,EAAKoB,MAAM,UAAUjB,MACjB,SAAAkB,GAAO,OAAI,EAAKC,YAAYtB,EAAKuB,KAAKzH,MAAM,EAAGkG,EAAKuB,KAAK5I,OAAO,GAAI0I,QAGrE,EAAKzC,cAAgB,gCAAkCpC,EACvD,EAAKmC,iBATN,IAAI,IAAInC,KAAYkE,EAAQrO,MAAQ,EAA5BmK,GAYRgF,QAAQC,IAAIP,GAAUf,MACzB,WACO,EAAKxB,aAAe,EAC1B,EAAKG,qBAAuB,uBAAyB,EAAKF,cAE1D,EAAKE,qBAAuB,yBAA2B,EAAKJ,aAAe,aAAqC,IAAtB,EAAKA,aAAqB,GAAK,KACtH,EAAKqB,aAAa,QAClB,EAAKhB,wBAAyB,U,yBAKhC,SAAYvC,EAAU6E,GACzB,IACIK,EAAQnH,EADRkE,EAAmBpK,KAAKoK,iBAE5B,IACIiD,EAAShK,KAAKU,MAAMiJ,GACpB9G,EAAYP,EAAS7B,UAAUuJ,GACjC,MAAMC,GAGJ,OAFAtN,KAAKuK,cAAgB,uCAAyCpC,OAC9DnI,KAAKsK,eAGTF,EAAiBmD,WAAWrH,EAAWiC,GACvCnI,KAAKqK,eACLrK,KAAK0L,aAAa,iB,KAKb8B,E,WACF,WAAYC,EAAWC,EAAmBC,GAAmB,oBAChE3N,KAAKyN,UAAYA,EACjBzN,KAAK0N,kBAAoBA,EACzB1N,KAAK2N,iBAAmBA,EACxB3N,KAAK4N,aAAc,E,kDAGhB,SAAeC,EAAOC,GACzB9N,KAAKyN,UAAUM,MAAK,SAACC,EAAGC,GACpB,IAAMC,EAAUF,EAAEH,GAAQM,EAAUF,EAAEJ,GACtC,OAAQC,EAAY,GAAK,IAAII,IAAYC,EAAU,EAAKD,EAAUC,GAAW,EAAI,Q,sCAQlF,SAAyBC,GAAW,IAAD,OACtC,GAAGpO,KAAK4N,cAAgB5N,KAAKyN,UACzB,OAAOW,EACXA,EAAWA,EAASC,QAAQ,QAAS,IACrC,IAJsC,eAI9BC,GACJ,IAAMC,EAAYH,EAAW,IAAME,EACnC,IAAI,EAAKb,UAAUe,MAAK,SAAA7C,GAAI,OAAIA,EAAKxD,WAAaoG,KACrD,MAAM,CAAN,EAAOA,IAHAD,EAAI,EAAGA,EAAI,IAAMA,IAAK,CAAC,IAAD,IAAtBA,GAAsB,kCAK9B,OAAOF,EAAW,a,oCAIf,SAAuBjG,EAAUsG,GACpC,GAAGzO,KAAK4N,cAAgB5N,KAAKyN,UAAW,OAAO,KAC/C,IAAIiB,EAAe,KACfjB,EAAYzN,KAAKyN,UAWrB,OAVAA,EAAU7J,SAAQ,SAAC+K,EAAGC,GAClB,GAAGD,EAAExG,WAAaA,EAAU,CAC/B,IAAI0G,EAAYD,EAAMH,EACnBI,EAAY,IAAGA,EAAY,GAC3BA,GAAapB,EAAUnJ,SAAQuK,EAAYpB,EAAUnJ,OAAO,GAC/DoK,EAAejB,EAAUoB,GAAW1G,cAGjCuG,GAAgBjB,EAAUnJ,OAAS,IACnCoK,EAAejB,EAAU,GAAGtF,UACzBuG,M,KAKFI,E,yFAsEF,WAAc,MAAO,Q,sBAErB,WACH,IAAIC,EAAU,IAAI9K,EAElB,OADAjE,KAAKyE,WAAWsK,GACTA,EAAQC,oB,wBAGZ,SAAWD,GAAWA,EAAQ3K,KAAK,a,uBAGnC,WAAc,MAAO,K,qBAGrB,WAAW,IAAD,OACFV,EAAO,CAAEuL,UAAWjP,KAAKiP,aAiB7B,OAhBAjP,KAAKkP,YAAYtL,SAAQ,SAAAuL,GACrB,IACIlF,EADEmF,EAAM,EAAKD,GAGblF,EADO,OAARmF,QAAwBC,IAARD,EACP,KACY,kBAATA,GAAqBA,aAAeN,EACvCM,EAAI7L,UACQ,kBAAT6L,EAGHA,EAAIE,KAAI,SAAAvM,GAAG,OAAIA,EAAIQ,aAGnB6L,EACZ1L,EAAKyL,GAAYlF,KAEdvG,I,qBAGX,WAAY,MAAO,OAAS1D,KAAKuP,WAAa,S,mBAK9C,SAAM3K,GAAMA,EAAG5E,Q,wBAGf,WACH,IAAIwP,EAAQ,KAKZ,OAJAxP,KAAKyP,OAAM,SAAAjL,GACiB,UAArBA,EAAKyK,aAA4BO,IACvCA,EAAQhL,MAEFgL,I,6BAIJ,SAAgBE,EAAUC,GAC7B,OAAG3P,OAAS0P,EACDC,EAEA3P,Q,wBA9HR,SAAiB0D,GACb,OAAOA,EAAKuL,WACZ,IAAK,UACD,OAAO,IAAIW,EAAYlM,EAAK2B,aAAcrF,KAAK6P,MAAMnM,EAAKoM,eAAgBpM,EAAKqM,SAC1F,IAAK,SACD,OAAO,IAAIC,EAAWhQ,KAAKiQ,MAAMvM,EAAKwM,WAAYlQ,KAAKiQ,MAAMvM,EAAKyM,cAC/D,IAAK,QACD,OAAO,IAAIC,EAAUpQ,KAAKiQ,MAAMvM,EAAK2M,eAAgBrQ,KAAKiQ,MAAMvM,EAAK4M,WAAYtQ,KAAKiQ,MAAMvM,EAAK6M,aAC5G,IAAK,QACD,OAAO,IAAIC,EACR,IAAK,OACD,OAAO,IAAIC,EAAS/M,EAAKU,MAC7B,IAAK,WACD,OAAO,IAAIsM,EAAa1Q,KAAK6P,MAAMnM,EAAKiN,QAC5C,IAAK,YACD,OAAO,IAAIC,EAAclN,EAAKmN,UAAWnN,EAAKoN,WAAYpN,EAAKqN,YAAa/Q,KAAK6P,MAAMnM,EAAKsN,cAChG,IAAK,uBACD,OAAO,IAAIC,EAAyBjR,KAAKiQ,MAAMvM,EAAKwM,WAAYlQ,KAAKiQ,MAAMvM,EAAKwN,gBAAiBlR,KAAKiQ,MAAMvM,EAAKyN,mBAC5H,IAAK,QACD,OAAO,IAAIC,EAAU1N,EAAK2N,WAAY3N,EAAK4N,UAAW5N,EAAK6N,aAAcvR,KAAKwR,QAAQ9N,EAAK+N,gBACxF,IAAK,cACD,OAAO,IAAIC,EAAgBhO,EAAKiO,iBAAkBjO,EAAKU,MAC3D,QACI,OAAO,IAAIqM,EAAS,qBAAuB/M,EAAKuL,c,mBAKxD,SAAavL,GAAQ,OAAOA,EAAOoL,EAAKhL,UAAUJ,GAAQ,O,mBAC1D,SAAakO,GAAc,OAAOA,EAAWtC,KAAI,SAAAuC,GAAS,OAAI/C,EAAKhL,UAAU+N,Q,qBAC7E,SAAeD,GAAc,OAAOA,EAAWtC,KAAI,SAAAwC,GAAS,OAAIhD,EAAKe,MAAMiC,Q,0BAI3E,SAAoB9O,EAAM+O,GACtB,IAAMlB,EAAY7N,EAAKiM,YAAa6B,EAAaiB,EAAM9C,YACvD,MAAiB,aAAd4B,GAA2C,aAAfC,EACpB,IAAIJ,EAAa1N,EAAK2N,MAAMqB,OAAOD,EAAMpB,QAC9B,SAAdE,GAAuC,SAAfC,EACrB,IAAIL,EAASzN,EAAKoB,KAAO2N,EAAM3N,MACpB,aAAdyM,GAA2C,SAAfC,GACoB,SAAhD9N,EAAK2N,MAAM3N,EAAK2N,MAAMrM,OAAO,GAAG2K,YAE7B,IAAIyB,EACP1N,EAAK2N,MAAMlL,MAAM,GAAI,GAAGuM,OAAO,CAC3B,IAAIvB,EAASzN,EAAK2N,MAAM3N,EAAK2N,MAAMrM,OAAO,GAAGF,KAAO2N,EAAM3N,SAGhD,SAAdyM,GAAuC,SAAfC,GACO,SAA/BiB,EAAMpB,MAAM,GAAG1B,YAEZ,IAAIyB,EACP,CAAC,IAAID,EAASzN,EAAKoB,KAAO2N,EAAMpB,MAAM,GAAGvM,OACvC4N,OAAOD,EAAMpB,MAAMlL,MAAM,KAGxB,IAAIiL,EAAa,CAAC1N,EAAM+O,M,2BAIvC,SAAqBpB,GACxB,OAAOA,EAAMrM,QACb,KAAK,EAAG,OAAO,KACf,KAAK,EAAG,OAAOqM,EAAM,GACrB,KAAK,EAAG,OAAO7B,EAAKmD,aAAatB,EAAM,GAAIA,EAAM,IACjD,QAAS,OAAO7B,EAAKmD,aAAatB,EAAM,GAAI7B,EAAKoD,cAAcvB,EAAMlL,MAAM,U,KAmEtEmK,E,kDAOF,WAAYvK,EAAcyK,EAAeC,GAAU,IAAD,EAE9C,GAF8C,oBAC9C,eACG1K,EAAayH,SAAS,KAAM,CAC3B,IAAM8B,EAAQvJ,EAAa8M,QAAQ,KACnC,EAAK9M,aAAeA,EAAaI,MAAM,EAAGmJ,GAC1C,EAAKmB,QAAU1K,EAAaI,MAAMmJ,EAAM,EAAGvJ,EAAaf,OAAO,QAG/D,EAAKe,aAAeA,EACpB,EAAK0K,aAAsBV,IAAZU,EAAwB,KAAOA,EATJ,OAWrD,EAAKD,cAAgBA,GAAiB,GAXe,E,iDAclD,WAAkB,OAAO9P,KAAK8P,cAAcxL,S,uBAC5C,WAAc,MAAO,Y,uBACrB,WAAc,MAAO,CAAC,eAAgB,gBAAiB,a,wBAEvD,SAAWyK,GACdA,EAAQvJ,QAAQxF,KAAKqF,aAAcrF,KAAK+P,SAExC/P,KAAK8P,cAAclM,SAAQ,SAAAwO,GAAY,OAAIrD,EAAQsD,aAAaD,EAAc,c,mBAG3E,SAAMxN,GACTA,EAAG5E,MACHA,KAAK8P,cAAclM,SAAQ,SAAAwO,GAAY,OAAIA,EAAa3C,MAAM7K,Q,6BAG3D,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIC,EACP5P,KAAKqF,aACLrF,KAAK8P,cAAcR,KAAI,SAAA8C,GAAY,OAAIA,EAAaE,gBAAgB5C,EAAUC,MAC9E3P,KAAK+P,a,GAzCgBjB,GAmDpBkB,E,kDACF,WAAYE,EAAWC,GAAc,IAAD,8BACvC,gBACKD,UAAYA,EACjB,EAAKC,YAAcA,EAHoB,E,6CAMpC,WAAc,MAAO,W,uBAErB,WAAc,MAAO,CAAC,YAAa,iB,wBAEnC,SAAWpB,GACdA,EAAQvK,KAAKxE,KAAKmQ,aAClBpB,EAAQvK,KAAKxE,KAAKkQ,a,mBAGf,SAAMtL,GACT5E,KAAKmQ,YAAYV,MAAM7K,GACvBA,EAAG5E,MACHA,KAAKkQ,UAAUT,MAAM7K,K,6BAGlB,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIK,EACPhQ,KAAKkQ,UAAUoC,gBAAgB5C,EAAUC,GACzC3P,KAAKmQ,YAAYmC,gBAAgB5C,EAAUC,Q,GA1BvBb,GAoCnBsB,E,kDACF,WAAYC,EAAeC,EAAWC,GAAa,IAAD,8BAC9C,gBACKF,cAAgBA,EACrB,EAAKC,UAAYA,EACjB,EAAKC,WAAaA,EAJ4B,E,6CAOlD,WAAc,MAAO,U,uBAErB,WAAc,MAAO,CAAC,gBAAiB,YAAa,gB,2BAIpD,WACI,IAAMgC,EAAUvS,KAAKqQ,cACrB,MAA2B,YAAxBkC,EAAQtD,aAAyD,IAA5BsD,EAAQC,gBACrCD,EAAQlN,aACa,SAAxBkN,EAAQtD,YACLsD,EAAQnO,KAER,O,wCAKf,WACI,IAAMqO,EAAKzS,KAAK0S,gBAChB,OAAOD,IAAc,MAAPA,GAAqB,MAAPA,K,wBAGhC,SAAW1D,GACX/O,KAAKsQ,WAAWvB,EAAQvK,KAAKxE,KAAKsQ,WACrCvB,EAAQvK,KAAKxE,KAAKqQ,eACRrQ,KAAKuQ,YAAYxB,EAAQvK,KAAKxE,KAAKuQ,c,mBAG1C,SAAM3L,GACN5E,KAAKsQ,WAAWtQ,KAAKsQ,UAAUb,MAAM7K,GACxCA,EAAG5E,MACAA,KAAKuQ,YAAYvQ,KAAKuQ,WAAWd,MAAM7K,K,6BAGvC,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIS,EACPpQ,KAAKqQ,cAAciC,gBAAgB5C,EAAUC,GAC7C3P,KAAKsQ,UAAUgC,gBAAgB5C,EAAUC,GACzC3P,KAAKuQ,WAAW+B,gBAAgB5C,EAAUC,Q,GAhDvBb,GAsDlB0B,E,+JACF,WAAc,MAAO,U,uBACrB,WAAc,MAAO,K,wBAErB,SAAWzB,GAId,IAAMvK,EAAO,IAAIoL,EAAY,YAAa,CAAC,IAAIa,EAAS,cAAe,IAAIb,EAAY,gBACvFb,EAAQvK,KAAKA,O,GATUsK,GAelB2B,E,kDACF,WAAYrM,GAAO,IAAD,8BACd,gBACKA,KAAOA,EAFE,E,6CAKlB,WAAc,MAAO,S,uBACrB,WAAc,MAAO,CAAC,U,wBAEtB,SAAW2K,GAAWA,EAAQ3K,KAAKpE,KAAKoE,U,GATrB0K,GAejB4B,E,kDACF,WAAYC,GAAQ,IAAD,8BACf,gBACKA,MAAQA,EAFE,E,6CAKnB,WAAc,MAAO,a,uBACrB,WAAc,MAAO,CAAC,W,wBAEtB,SAAW5B,GACd/O,KAAK2Q,MAAM/M,SAAQ,SAAAY,GAAI,OAAIuK,EAAQvK,KAAKA,Q,mBAGrC,SAAMI,GACTA,EAAG5E,MACHA,KAAK2Q,MAAM/M,SAAQ,SAAAY,GAAI,OAAIA,EAAKiL,MAAM7K,Q,6BAGnC,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIe,EACP1Q,KAAK2Q,MAAMrB,KAAI,SAAA9K,GAAI,OAAIA,EAAK8N,gBAAgB5C,EAAUC,W,GArBhCb,GA6BrB8B,E,kDAaF,WAAYC,EAAWC,EAAYC,EAAaC,GAAc,IAAD,8BACzD,gBACKH,UAAYA,EACjB,EAAKC,WAAaA,EAClB,EAAKC,YAAcA,GAAe,KAClC,EAAKC,YAAcA,GAAe,GALuB,E,6CAQ7D,WAAc,MAAO,c,uBACrB,WAAc,MAAO,CAAC,YAAa,aAAc,cAAe,iB,wBAEhE,SAAWjC,GAAU,IAAD,OACvBA,EAAQvJ,QAAQ,QAChBuJ,EAAQ4D,gBAAgB3S,KAAK6Q,WAC7B7Q,KAAKgR,YAAYpN,SAAQ,SAACY,EAAMoK,GACzBA,EAAQ,IACdG,EAAQvJ,QAAQ,UAChBuJ,EAAQ4D,gBAAgB,EAAK5B,aAAe,MAEzChC,EAAQvK,KAAKA,MAEjBuK,EAAQvJ,QAAQ,SAChBuJ,EAAQ4D,gBAAgB3S,KAAK8Q,c,mBAG1B,SAAMlM,GACTA,EAAG5E,MACHA,KAAKgR,YAAYpN,SAAQ,SAAAY,GAAI,OAAIA,EAAKiL,MAAM7K,Q,6BAGzC,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIiB,EACP5Q,KAAK6Q,UAAW7Q,KAAK8Q,WAAY9Q,KAAK+Q,YACtC/Q,KAAKgR,YAAY1B,KAAI,SAAA9K,GAAI,OAAIA,EAAK8N,gBAAgB5C,EAAUC,U,2BA9C7D,SAAoBnL,GAChB,OAAO,IAAIoM,EAAc,IAAK,IAAK,KAAM,CAACpM,M,8BAI9C,SAAwBA,GACpB,MAAwB,UAArBA,EAAKyK,aAA2BzK,EAAKoO,6BAC7BhC,EAAciC,aAAarO,GAE3BA,M,GAVSsK,GAsDtBmC,E,kDACF,WAAYf,EAAWgB,EAAgBC,GAAmB,IAAD,8BACrD,gBACKjB,UAAYA,EACjB,EAAKgB,eAAiBA,EACtB,EAAKC,iBAAmBA,EAJ6B,E,6CAOzD,WAAc,MAAO,yB,uBACrB,WAAc,MAAO,CAAC,YAAa,iBAAkB,sB,wBAErD,SAAWpC,GAIoB,YAA/B/O,KAAKkQ,UAAUjB,YACdF,EAAQvK,KAAKxE,KAAKkQ,WAElBnB,EAAQsD,aAAarS,KAAKkQ,WAC3BlQ,KAAKkR,iBACJnC,EAAQ3K,KAAK,KAIb2K,EAAQsD,aAAarS,KAAKkR,eAAgB,mBAE3ClR,KAAKmR,mBACJpC,EAAQ3K,KAAK,KACb2K,EAAQsD,aAAarS,KAAKmR,iBAAkB,qB,mBAI7C,SAAMvM,GACTA,EAAG5E,MACHA,KAAKkQ,UAAUT,MAAM7K,GAClB5E,KAAKkR,gBAAgBlR,KAAKkR,eAAezB,MAAM7K,GAC/C5E,KAAKmR,kBAAkBnR,KAAKmR,iBAAiB1B,MAAM7K,K,6BAGnD,SAAgB8K,EAAUC,GAC7B,OAAG3P,OAAS0P,EAAiBC,EACtB,IAAIsB,EACPjR,KAAKkQ,UAAUoC,gBAAgB5C,EAAUC,GACzC3P,KAAKkR,eAAiBlR,KAAKkR,eAAeoB,gBAAgB5C,EAAUC,GAAY,KAChF3P,KAAKmR,iBAAmBnR,KAAKmR,iBAAiBmB,gBAAgB5C,EAAUC,GAAY,U,GA5ClDb,GAkDjCsC,E,kDA6BF,WAAYC,EAAYC,EAAWC,EAAcE,GAAgB,IAAD,8BACnE,gBACKJ,WAAaA,EAClB,EAAKC,UAAYA,EACjB,EAAKC,aAAeA,EACpB,EAAKE,cAAgBA,EAL8C,E,6CAQhE,WAAc,MAAO,U,uBACrB,WAAc,MAAO,CAAC,aAAc,YAAa,kB,uBAEjD,WACH,IAAMqB,EAAI9S,KAAKqR,WAEf,MAAc,YAANyB,GAAyB,YAANA,GAAyB,WAANA,GACvC,YAANA,GAAyB,YAANA,GAAyB,YAANA,I,qBAGpC,WACH,IAAIpP,EAAI,gEAGR,OAFAA,EAAK+N,cAAgBzR,KAAKyR,cAAcnC,KACpC,SAAAwC,GAAS,OAAIA,EAAUxC,KAAI,SAAA9K,GAAI,OAAIA,EAAKjB,gBACrCG,I,2BAMJ,WAAiB,IAAD,OACZ,GAAG1D,KAAKsR,WAAa,GAAKtR,KAAKuR,cAAgB,EAC3C,OAAOvR,KAQX,IAPA,IAAM+S,EAAY,SAAC/F,GAAD,OAAa,IAAIyD,EAASzD,IACxCgG,EAAoBhT,KAAKyR,cAAcnC,KAAI,SAACwC,EAAWlD,GAAZ,4BACxCkD,EAAUrM,MAAM,GAAI,IADoB,CAE3CsN,EAAqB,IAAVnE,GAAeA,IAAU,EAAK0C,UAAU,EAAK,UAAY,IACpEQ,EAAU,EAAKP,aAAa,QAE5B0B,EAAqB,CAACF,EAAU,YAC5BG,EAAI,EAAGA,EAAIlT,KAAKuR,aAAa,EAAG2B,IACpCD,EAAmB1O,KAAKwO,EAAU,KAItC,OAHAE,EAAmB1O,KAAKwO,EAAU,YAClCE,EAAmB1O,KAAKwO,EAAU,YAClCC,EAAkBG,OAAOnT,KAAKsR,UAAU,EAAG,EAAG2B,GACvC,IAAI7B,EAAUpR,KAAKqR,WAAYrR,KAAKsR,UAAU,EAAGtR,KAAKuR,aAAa,EAAGyB,K,wBAKjF,WAEI,IAFU,IAAD,OACLA,EAAoB,GADf,WAEDE,GACJF,EAAkBzO,KAAK,EAAKkN,cAAcnC,KACtC,SAAAwC,GAAS,OAAI,EAAKsB,gBAAgBtB,EAAUoB,SAF5CA,EAAI,EAAGA,EAAIlT,KAAKuR,aAAc2B,IAAtC,EAAQA,GAGR,OAAO,IAAI9B,EAAUpR,KAAKqR,WAAYrR,KAAKuR,aAAcvR,KAAKsR,UAAW0B,K,6BAK7E,SAAgBK,GACZ,GAA6B,SAA1BA,EAAUpE,YACT,OAAOoE,EAAUjP,MACjB,IAAK,UAAW,OAAO,IAAIqM,EAAS,WACpC,IAAK,UAAW,OAAO,IAAIA,EAAS,WAIxC,OAAO4C,I,wBAKX,WAAc,IAAD,OACT,OAAOrT,KAAKyR,cAAcnC,KACtB,SAAAwC,GAAS,OAAI,IAAIV,EAAU,EAAKC,WAAY,EAAG,EAAKE,aAAc,CAACO,S,wBAG3E,SAAW/C,GACdA,EAAQuE,kBAAkBtT,KAAKqR,YAC/BrR,KAAKyR,cAAc7N,SAAQ,SAACkO,EAAWyB,GAChCA,EAAY,GAAGxE,EAAQyE,gBAC1B1B,EAAUlO,SAAQ,SAACY,EAAMiP,GACzBA,EAAY,GAAG1E,EAAQ2E,kBACvBlP,GAAMuK,EAAQvK,KAAKA,SAGvBuK,EAAQ4E,gBAAgB3T,KAAKqR,c,mBAG1B,SAAMzM,GACTA,EAAG5E,MACHA,KAAKyR,cAAc7N,SACf,SAAAkO,GAAS,OAAIA,EAAUlO,SAAQ,SAAAY,GAAI,OAAIA,EAAKiL,MAAM7K,W,6BAGnD,SAAgB8K,EAAUC,GAC7B,GAAG3P,OAAS0P,EAAU,OAAOC,EAC7B,IAAMqD,EAAoBhT,KAAKyR,cAAcnC,KACzC,SAAAwC,GAAS,OAAIA,EAAUxC,KAC1B,SAAA9K,GAAI,OAAIA,EAAK8N,gBAAgB5C,EAAUC,SACxC,OAAO,IAAIyB,EAAUpR,KAAKqR,WAAYrR,KAAKsR,UAAWtR,KAAKuR,aAAcyB,M,6BA3HtE,SAAsBrC,EAAOiD,GAChC,OAAOjD,EAAMrB,KAAI,SAAA9K,GAAI,OAAI4M,EAAUyC,YAAYrP,EAAMoP,Q,yBAIlD,SAAmBpP,EAAMoP,GACrB,OAAOA,GACP,IAAK,OACD,MAAO,CAACpP,GACZ,IAAK,QACD,MAAwB,UAArBA,EAAKyK,YACG,CAACzK,EAAK8L,UAAW,IAAIF,EAAU5L,EAAK6L,cAAe,KAAM7L,EAAK+L,aAE9D,CAAC/L,EAAM,MACtB,IAAK,QACD,MAAwB,UAArBA,EAAKyK,aAAoD,MAAzBzK,EAAKkO,gBAC7B,CAAClO,EAAK8L,UAAW9L,EAAK+L,YAEtB,CAAC/L,EAAM,MACtB,QACI,MAAO,CAACA,Q,GAzBIsK,GAyIlB4C,E,kDACF,WAAYC,EAAkBvN,GAAO,IAAD,8BAChC,gBACKuN,iBAAmBA,EACxB,EAAKvN,KAAOA,EAHoB,E,6CAMpC,WAAc,MAAO,gB,uBACrB,WAAc,MAAO,CAAC,mBAAoB,U,kCAE1C,SAAqB2F,GACjB,OAAO,IAAI2H,EAAgB1R,KAAK2R,iBAAkB3R,KAAKoE,KAAO2F,K,oCAGlE,WACI,OAAO,IAAI2H,EAAgB1R,KAAK2R,iBAAkB3R,KAAKoE,KAAKqB,MAAM,GAAI,M,gCAG1E,SAAmBL,GACf,GAA6B,UAA1BpF,KAAK2R,iBAA8B,CAGzC,IAAMmC,EAAc,aACpB,OAAwB,IAArB9T,KAAKoE,KAAKE,QAA8B,IAAdc,EAAGd,UAEH,IAArBtE,KAAKoE,KAAKE,SAAiBwP,EAAYxT,KAAKN,KAAKoE,QAGrD0P,EAAYxT,KAAK8E,GAKd,OAAqB,IAAdA,EAAGd,S,sBAIlB,WAAa,OAA4B,IAArBtE,KAAKoE,KAAKE,S,2BAI9B,WACI,IAAMF,EAAOpE,KAAKoE,KAAKiE,OACvB,GAAmB,IAAhBjE,EAAKE,OAAc,OAAO,KAC7B,OAAOtE,KAAK2R,kBACZ,IAAK,QAAS,OAAO,IAAI/B,EAAYxL,GACrC,IAAK,OAAQ,OAAO,IAAIqM,EAASzQ,KAAK+T,cAAc3P,IACpD,QAAS,OAAO,Q,2BAKpB,SAAcA,GACjB,IAAM4P,EAAe,CACjB,EAAK,MACL,IAAK,UACL,IAAK,MACL,IAAK,UACL,IAAK,cACL,IAAK,MACL,EAAK,MACL,IAAK,MACL,IAAK,MACL,IAAK,MACL,IAAK,MACL,IAAK,QACL,KAAM,eAEV,OAAO5P,EAAKgE,WAAW,qBAAqB,SAAA6L,GAAK,OAAID,EAAaC,Q,wBAG/D,SAAWlF,GACdA,EAAQvK,KAAKxE,KAAKkU,sB,8BAIf,WACH,OAAOlU,KAAK2R,kBACZ,IAAK,QACD,OAAO,IAAIjB,EAAa,CAC3B,IAAId,EAAY,aAChB,IAAIA,EAAY,SAAU,CACtB5P,KAAKmU,WAAa,IAAIvE,EAAY,aAAe,IAAIa,EAASzQ,KAAK+T,cAAc/T,KAAKoE,WAE3F,IAAK,OACD,OAAO,IAAIwL,EAAY,QAAS,CACnC,IAAIc,EAAa,CACb,IAAId,EAAY,WAAY,CAAC,IAAIa,EAAS,OAC1CzQ,KAAKmU,WAAa,IAAIvE,EAAY,KAAO,IAAIa,EAASzQ,KAAK+T,cAAc/T,KAAKoE,WAEnF,QACI,OAAO,IAAIqM,EAAS,Y,GA3FK3B,GAkGxBsF,E,WAkCF,aAAe,oBACXpU,KAAKqU,OAASD,EAAKE,c,6CAGvB,SAAUC,GAAU,OAAOA,EAAS,IAAMvU,KAAKqU,S,uBAG/C,WAAc,MAAO,Q,qBACrB,WAAY,MAAO,K,qBACnB,WAAY,MAAO,S,0BArCnB,WAAuB,OAAOD,EAAKI,kB,uBAEnC,SAAiB9Q,GACb,OAAOA,EAAK+Q,WACZ,IAAK,OAAQ,OAAO,IAAIC,EAC3B5F,EAAKhL,UAAUJ,EAAKc,MACpBd,EAAKiR,SAAW7F,EAAKhL,UAAUJ,EAAKiR,UAAY,MAC7C,IAAK,WACR,OAAO,IAAI3O,EAAatC,EAAKkR,aAC1B,QACH,OAAO,IAAI5O,EAAa,qBAAuBtC,EAAK+Q,c,yBAOrD,SAAmBI,GAGf,IAFAA,GAAUA,GAAU,IAAIxM,QAEd9C,WAAW,OAASsP,EAAOpP,MAAM,GAAGqH,SAAS,MAAO,CAC1D,IAAMgI,EAAQD,EAAOpP,MAAM,GAAI,GAC/B,OAAO,IAAIiP,EAAS,IAAIjE,EAASqE,IAGjC,OAAO,IAAI9O,EAAa6O,O,KAgBpCT,EAAKI,cAAgB,E,IAIfE,E,kDAEF,WAAYlQ,EAAMmQ,GAAW,IAAD,8BACxB,gBACKnQ,KAAOA,EACnB,EAAKmQ,SAAWA,EAHe,E,6CAM5B,WAAc,MAAO,S,qBAErB,WACH,IAAIjR,EAAO,CAAC+Q,UAAW,OAAQjQ,KAAMxE,KAAKwE,KAAKjB,WAE/C,OADGvD,KAAK2U,WAAUjR,EAAKiR,SAAW3U,KAAK2U,SAASpR,WACzCG,I,qBAGJ,WAAY,OAAO1D,KAAKwE,KAAKuQ,c,GAhBVX,GAqBjBpO,E,kDACF,WAAY4O,GAAc,IAAD,8BACrB,gBACKA,YAAcA,EAEnB,EAAKI,cAAgB,EAAKC,gBAAgB,EAAKL,aAJ1B,E,4CAOzB,WAAa,OAA0C,IAAnC5U,KAAK4U,YAAYvM,OAAO/D,S,6BAE5C,SAAgBsQ,GAIZ,OADPA,EAAcA,EAAYxM,WAAW,IAAK,KAC5B8M,IAAOnR,MAAM6Q,K,uBAuBxB,WAAc,MAAO,a,qBAErB,WACI,MAAO,CAACH,UAAW,WAAYG,YAAa5U,KAAK4U,e,qBAIrD,WAAY,OAAO5U,KAAK4U,gB,GA5CDR,GAkDrBnO,E,WAMF,WAAYgD,GAAQ,oBAChBjJ,KAAKiJ,MAAQA,E,yCAGjB,WAAU,OAAOjJ,KAAKiJ,MAAM3E,S,mBAC5B,SAAMgK,GAAK,OAAOtO,KAAK+I,SAAWuF,I,yBAGlC,SAAYA,GACR,IAAItO,KAAKmV,MAAM7G,GAAI,OAAO,EAC1B,IAAI,IAAI4E,EAAI,EAAGA,EAAI5E,EAAG4E,IAClB,GAAqD,SAAlDlT,KAAKiJ,MAAMjJ,KAAKiJ,MAAM3E,OAAO,EAAE4O,GAAGuB,YACjC,OAAO,EACf,OAAO,I,kBAIX,SAAKnG,GAED,OADItO,KAAKmV,MAAM,IAAInV,KAAKoV,YACjBpV,KAAKiJ,MAAMjJ,KAAKiJ,MAAM3E,OAASgK,K,iBAI1C,SAAIA,GAGA,YAFSe,IAANf,IAAiBA,EAAI,GACpBtO,KAAKmV,MAAM7G,IAAItO,KAAKoV,YACjBpV,KAAKqV,eAAe/G,K,uBAI/B,SAAUA,GACFtO,KAAKmV,MAAM7G,IAAItO,KAAKoV,YACpBpV,KAAKsV,YAAYhH,IAAItO,KAAKuV,aAC9B,MAA8BvV,KAAKqV,eAAe/G,GAAlD,iBAAOkH,EAAP,KAAqBvM,EAArB,WACA,MAAM,CAAEuM,GAAR,mBAAsBvM,EAAMqG,KAAI,SAAAvJ,GAAI,OAAIA,EAAKvB,Y,kCAIjD,WACI,MAA0BxE,KAAKyV,UAAU,GAAzC,mBAAOD,EAAP,KAAkBhR,EAAlB,KACA,GAAwB,SAArBA,EAAKyK,YAAwB,CAC5B,IAAMhF,EAAQyL,SAASlR,EAAKJ,MAC5B,GAAG6F,GAAS,EAAG,MAAO,CAACuL,EAAWvL,GAEtCjK,KAAKuV,e,0BAGT,SAAajH,GAChB,MAA8BtO,KAAKyV,UAAUnH,GAA7C,iBAAOkH,EAAP,KAAqB7E,EAArB,WACA,GAAGA,EAAMgF,OAAM,SAAAnR,GAAI,MAAyB,UAArBA,EAAKyK,aAA2BzK,EAAKoR,eACxD,MAAM,CAAEJ,GAAR,mBAAsB7E,IAEtB3Q,KAAKuV,e,4BAGN,SAAejH,GACX,MAAO,CAAC,IAAIrI,EAAMjG,KAAKiJ,MAAMxD,MAAM,GAAI6I,KAAK0D,OAAOhS,KAAKiJ,MAAMxD,OAAO6I,M,sBAGzE,SAASrF,GACL,IAAIA,EAAM0M,OAAM,SAAA5P,GAAI,OAAIA,aAAgBqO,KACpC,MAAM,IAAIyB,MAAM,mCACpB,OAAO,IAAI5P,EAAMjG,KAAKiJ,MAAM+I,OAAO/I,M,4BAGvC,SAAe0H,GAAS,OAAO3Q,KAAK8V,SAASnF,EAAMrB,KAAI,SAAA9K,GAAI,OAAI,IAAIkQ,EAASlQ,S,kBAC5E,SAAKuB,GAAQ,OAAO/F,KAAK8V,SAAS,CAAC/P,M,uBACnC,SAAUvB,GAAQ,OAAOxE,KAAK+V,eAAe,CAACvR,M,uBAE9C,WAAc,MAAM,IAAIqR,MAAM,qB,wBAC9B,WAAe,MAAM,IAAIA,MAAM,sB,qBAE/B,WACI,MAAO,CACHG,YAAa,QACb/M,MAAOjJ,KAAKiJ,MAAMqG,KAAI,SAAAvJ,GAAI,OAAIA,EAAKxC,iB,wBAhF3C,SAAiBG,GAEb,OAAO,IAAIuC,EADGvC,EAAKuF,MAAMqG,KAAI,SAAA2G,GAAS,OAAI7B,EAAKtQ,UAAUmS,W,KAqF3DpQ,E,WAQF,WAAYoD,EAAOiN,GAAkB,oBACjClW,KAAKiJ,MAAQA,GAAS,GACtBjJ,KAAKkW,gBAAkBA,E,iDAG3B,WACI,OAAGlW,KAAKkW,gBAAkB,EACflW,KAAKiJ,MAAMjJ,KAAKkW,gBAAgB,GAEhC,O,yBAKf,SAAYC,GACR,IAAMvH,EAAQ5O,KAAKkW,gBAEnB,OAAO,IAAIrQ,EADO7F,KAAKiJ,MAAMxD,MAAM,EAAGmJ,GAAOoD,OAAO,CAACmE,GAAWnW,KAAKiJ,MAAMxD,MAAMmJ,IAClDA,EAAM,K,8BAMzC,WACI,IAAMA,EAAQ5O,KAAKkW,gBACnB,OAAGtH,EAAQ,EAEA,IAAI/I,EADO7F,KAAKiJ,MAAMxD,MAAM,EAAGmJ,EAAM,GAAGoD,OAAOhS,KAAKiJ,MAAMxD,MAAMmJ,IACxCA,EAAM,GAG9B,O,+BAGf,SAAkBH,GACd,IAAII,EAAY7O,KAAKkW,gBAAkBzH,EAGvC,OAFGI,EAAY,IAAGA,EAAY,GAC3BA,EAAY7O,KAAKiJ,MAAM3E,SAAQuK,EAAY7O,KAAKiJ,MAAM3E,QAClD,IAAIuB,EAAS7F,KAAKiJ,MAAO4F,K,gCAKpC,SAAmBJ,GACf,IAAM1I,EAAO/F,KAAKoW,gBAClB,OAAIrQ,GACD/F,KAAKkW,gBAAkBzH,GAAU,GACjCzO,KAAKkW,gBAAkBzH,EAASzO,KAAKiJ,MAAM3E,OACnC,KAEPtE,KAAKqW,mBAAmBC,kBAAkB7H,GAAQ8H,YAAYxQ,K,qBAGtE,WACI,MAAO,CACHiQ,YAAa,WACb/M,MAAOjJ,KAAKiJ,MAAMqG,KAAI,SAAAvJ,GAAI,OAAIA,EAAKxC,aAC1C2S,gBAAiBlW,KAAKkW,mB,qBAIvB,WACH,OAAOlW,KAAKiJ,MAAMqG,KAAI,SAAAvJ,GAAI,OAAIA,EAAKgP,aAAWhQ,KAAK,W,wBApEhD,SAAiBrB,GACb,OAAO,IAAImC,EACdnC,EAAKuF,MAAMqG,KAAI,SAAA2G,GAAS,OAAI7B,EAAKtQ,UAAUmS,MAC3CvS,EAAKwS,iBAAmB,O,KC9cdM,E,WAzlCX,WAAYC,EAAeC,GAAW,oBACzC1W,KAAKyW,cAAgBA,EACdzW,KAAKG,KAAO,OACZH,KAAK2W,SAAW,KAChB3W,KAAK4W,aAAe,KAC3B5W,KAAK6W,eAAgB,EACrB7W,KAAK8W,YAAa,EAClB9W,KAAK0W,SAAWA,EAIhB1W,KAAK+W,kBAAoB,KASlB/W,KAAKgX,qBAAuB,KAG5BhX,KAAKiX,WAAa,CAACC,QAAQ,GAG3BlX,KAAKrB,kBAAoB,G,8CAM7B,SAAWuH,EAAW9F,GAClB,GAAW,UAARA,GAA2B,QAARA,GAAyB,YAARA,EAC1C,MAAO,EAAC,EAAO8F,GAGTA,EAAU/H,MAAM4K,QAAU,GAA6C,SAAxC7C,EAAU/H,MAAMgZ,KAAK,GAAG1C,aACV,gBAA7CvO,EAAU/H,MAAMgZ,KAAK,GAAG3S,KAAKyK,cAC5BjP,KAAKG,KAAO,cAGvB,IAAMiX,EAAiBpX,KAAK0W,SAAS/V,YAAcX,KAAKG,KAC3CqF,EAAUxF,KAAK0W,SAASlW,eAAe6W,eAAeD,EAAgBhX,GAC5E,OAAGoF,GACCxF,KAAKsX,cAAgBlX,EAEd,EAAC,EADcJ,KAAKuX,gBAAgB/R,EAASU,IACrBA,IAGxB,EAAC,EAAOA,K,6BAIvB,SAAgBV,EAASU,GAO5B,IAAMsR,EAAWhS,EAAQiS,MAAM,KAAKnI,KAChC,SAAAoI,GAAK,OAAIA,EAAMD,MAAM,KAAKnI,KAC7B,SAAAqI,GAAK,OAAIA,EAAMvP,WAAW,YAAa,WACjC,OAAOpI,KAAK4X,sBAAsBJ,EAAUtR,K,mCAKhD,SAAsBsR,EAAUtR,GAC5BlG,KAAKgX,qBAAuB,KAC5B,IAAI,IAAI9D,EAAI,EAAGA,EAAIsE,EAASlT,OAAQ4O,IAAK,CACrC,kBAAsCsE,EAAStE,IAAxC7N,EAAP,KAAwBwS,EAAxB,WACMC,EAAmB9X,KAAK,MAAQqF,GACtC,IAAIyS,EACA,OAAO,KACX,IAEI9X,KAAKkG,UAAYA,EAMjBlG,KAAK2W,SAAW,KAIhB3W,KAAK4W,aAAe,KAGlC5W,KAAK6W,eAAgB,EAIrB7W,KAAK8W,YAAa,EAElB9W,KAAK+W,kBAAoB,KAGX,IAAMvB,EAAasC,EAAiB1Q,KAAKpH,MAAvB,cAA8BkG,EAAU/H,OAAxC,mBAAkD0Z,KAChEE,EAAgB,IAAIpS,EACpB6P,GAAatP,EAAU/H,MACvB6B,KAAK4W,cAAgB1Q,EAAUzE,UAEjDsW,EAAcjS,SAAWI,EAAUJ,WAAaiS,EAAcrR,QAAQR,GACnElG,KAAK8W,aACJiB,EAAcjS,UAAW,GAC7BI,EAAY6R,EAGE/X,KAAKG,KAAOH,KAAK2W,UAAY,OAC/B,MAAMrJ,GACJ,GAAiB,oBAAdA,EAAE0K,SAA+C,qBAAd1K,EAAE0K,QAIpC,OAHAhY,KAAKiY,oBACLjY,KAAKgX,qBAAuB,KAC5BhX,KAAKG,KAAO,OACL,KAEN,MAAMmN,EA3Cf,QA+CItN,KAAKkG,UAAY,KACjBlG,KAAK4W,aAAe,MAG5B,OAAO1Q,I,4BAGX,SAAeyQ,GAClB3W,KAAK2W,SAAWA,I,iCAGb,SAAoBuB,GAChBA,EAAYC,UAAUC,OAAO,cAE7BF,EAAYG,YACZH,EAAYC,UAAUG,IAAI,gB,+BAE9B,WAAsB,OAAOtY,KAAKuY,oBAAoB9W,SAASC,eAAe,kB,kCAC9E,WAAyB,OAAO1B,KAAKuY,oBAAoB9W,SAASC,eAAe,qB,+BACjF,WAEI,IADA,IAAM8W,EAAU,CAAC,cAAe,kBACxBC,EAAS,EAAGA,EAASD,EAAQlU,OAAQmU,IAAU,CACzChX,SAASC,eAAe8W,EAAQC,IACtCN,UAAUC,OAAO,iB,oBAI7B,SAAOhU,GAAQpE,KAAK+W,kBAAoB3S,I,0CAKxC,SAA6B8L,EAAWwI,EAAYC,GAEhD,MAA6B,yBAA1BzI,EAAUjB,cACqB,OAA7BiB,EAAUgB,iBAA4ByH,GACP,OAA/BzI,EAAUiB,kBAA6BwH,GAEjC,IAAI1H,EACPf,EAAUA,UACTyI,EAAiBzI,EAAUgB,eAAiBwH,EAC5CC,EAAiBD,EAAaxI,EAAUiB,mBAK7CjB,EAAYU,EAAcgI,iBAAiB1I,GACpC,IAAIe,EACPf,EACCyI,EAAiB,KAAOD,EACxBC,EAAiBD,EAAa,S,wCAM3C,SAA2Bva,EAAOwa,GAC9B,MAA2Cxa,EAAMsX,UAAU,GAA3D,mBAAOD,EAAP,KAAkBtF,EAAlB,KAA6BwI,EAA7B,KACD/I,EAAW3P,KAAK6Y,6BAA6B3I,EAAWwI,EAAYC,GACnE,OAAOnD,EAAUsD,UAAUnJ,K,0BAG/B,SAAaxR,GAAS,OAAO6B,KAAK+Y,2BAA2B5a,GAAO,K,4BACpE,SAAeA,GAAS,OAAO6B,KAAK+Y,2BAA2B5a,GAAO,K,sBAItE,SAASA,GACZ,MAA+BA,EAAMsX,UAAU,GAA/C,mBAAOD,EAAP,KAAkBtF,EAAlB,KACM8I,EAAiB,IAAIpJ,EAAY,QAAS,IAIhD,GAA6B,yBAA1BM,EAAUjB,aAA0CiB,EAAUiB,iBAAkB,CAC/E,IAII8H,EAJEjV,EAAIkM,EAAUiB,iBACd+H,EAAmB,SAAA1U,GAAI,MACT,YAArBA,EAAKyK,aACoB,IAAzBzK,EAAKgO,iBAA+C,UAAtBhO,EAAKa,cAQlC,GALH4T,EADMC,EAAiBlV,GACA,IAAI0M,EAAa,CAAC1M,EAAGgV,IACf,aAAlBhV,EAAEiL,aAA8BjL,EAAE2M,MAAMgF,MAAMuD,GAClC,IAAIxI,EAAa1M,EAAE2M,MAAMqB,OAAO,CAACgH,KAEjC,KACK,CAC5B,IAAMrJ,EAAW,IAAIsB,EACjBf,EAAUA,UAAWA,EAAUgB,eAAgB+H,GACnD,OAAOzD,EAAUsD,UAAUnJ,IAK5B,IAAMA,EAAW3P,KAAK6Y,6BAA6B3I,EAAW8I,GAAgB,GAC9E,OAAOxD,EAAUsD,UAAUnJ,K,qBAGxB,SAAQxR,EAAOwY,GAAY3W,KAAKmZ,eAAexC,K,qBAE/C,WAAY3W,KAAKgX,qBAAuB,S,qBACxC,WAAYhX,KAAKgX,qBAAuB,S,oBAExC,SAAO7Y,GACH,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBzP,EAAlB,KACA,OAAOyP,EAAUM,SAAS,CAAC/P,EAAMA,M,oBAErC,SAAO5H,GAEH,MAAiCA,EAAMib,IAAI,GAA3C,mBAAO5D,EAAP,UACA,OAAOA,I,oBAGX,SAAOrX,GAEH,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAqBvH,GAArB,WACA,OAAOuH,EAAUjR,KAAK0J,K,qBAE1B,SAAQ9P,GACJ,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBxH,EAAlB,KAAqBC,EAArB,KACA,OAAOuH,EAAUM,SAAS,CAAC7H,EAAGD,M,qBAGlC,SAAQ7P,GACJ,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBxH,EAAlB,KAAqBC,EAArB,KACA,OAAOuH,EAAUM,SAAS,CAAC7H,EAAGD,EAAGC,M,qBAGrC,SAAQ9P,GACJ,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBxH,EAAlB,KAAqBC,EAArB,KACA,OAAOuH,EAAUM,SAAS,CAAC9H,EAAGC,EAAGD,M,oBAGrC,SAAO7P,GACH,MAA6BA,EAAMib,IAAI,GAAvC,mBAAO5D,EAAP,KAAkBxH,EAAlB,KAAqBC,EAArB,KAAwBlE,EAAxB,KACA,OAAOyL,EAAUM,SAAS,CAAC7H,EAAGlE,EAAGiE,M,sBAGrC,SAAS7P,GACL,MAA6BA,EAAMib,IAAI,GAAvC,mBAAO5D,EAAP,KAAkBxH,EAAlB,KAAqBC,EAArB,KAAwBlE,EAAxB,KACA,OAAOyL,EAAUM,SAAS,CAAC/L,EAAGiE,EAAGC,M,0BAGrC,SAAa9P,GAChB,MAAgCA,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB8D,EAAlB,KACA,EAAgC9D,EAAU4D,IAAIE,GAA9C,iBAAOC,EAAP,KAAuBtQ,EAAvB,WAEA,OADAA,EAAMuQ,UACCD,EAAYzD,SAAS7M,K,4BAEzB,SAAe9K,GAClB,MAA8BA,EAAMib,IAAIjb,EAAM4K,SAA9C,iBAAOyM,EAAP,KAAqBvM,EAArB,WAEA,OADAA,EAAMuQ,UACChE,EAAUM,SAAS7M,K,4BAEvB,WACI,OAAO,IAAIhD,EAAM,M,0CAGrB,SAA6B9H,EAAOsb,GAChC,IAAMC,EAAShE,SAAS+D,GACxBzZ,KAAK4W,aAAe5W,KAAKkG,UAAUzE,SAAS6U,kBAAkBoD,K,yCAIlE,SAA4Bvb,EAAOsb,GAC/B,IAAMC,EAAShE,SAAS+D,GAClB7C,EAAe5W,KAAKkG,UAAUzE,SAASkY,mBAAmBD,GAC7D9C,EACC5W,KAAK4W,aAAeA,EAEpB5W,KAAK4Z,yB,0BAGb,SAAazb,GAAQ,IAAD,OAEVgK,EADcnI,KAAKyW,cAAchQ,MAAMoT,mBACTlM,iBAC3C,IAAIxF,EACA,OAAOnI,KAAK8Z,gBAAgB3b,GAChC6B,KAAKyW,cAAchQ,MAAM2D,iBAAiBmD,WACtCvN,KAAKkG,UAAWiC,GAChB,WACH,EAAK4R,OAAO,UAAY5R,GACxB,EAAKuO,SAAShW,qBAAuByH,EACrC,EAAKuO,SAASsD,OACd,EAAKhD,qBAAuB,QAC5B,EAAKP,cAAcwD,uBAEhB,kBAAM,EAAKF,OAAO,gBAAkB5R,MAExCnI,KAAK8W,YAAa,I,6BAIf,SAAgB3Y,GAAQ,IAAD,OACfuQ,EAAewL,OAAOC,OAAO,gCAAiCna,KAAK0W,SAAS/I,kBAChF,GAAIe,EAAJ,CAEP,IAAItE,EAAmBpK,KAAKyW,cAAchQ,MAAM2D,iBACzCsE,EAAetE,EAAiBgQ,kBAAkB1L,GAClDtE,EAAiBmD,WACpBvN,KAAKkG,UAAWwI,GAChB,WACH,EAAKqL,OAAO,aAAerL,GAC3B,IAAImL,EAAqB,EAAKpD,cAAchQ,MAAMoT,mBAClDA,EAAmBnM,kBAAoBmM,EAAmBlM,iBAAmBe,EAC7E,EAAKgI,SAAShW,qBAAuBgO,EACrC,EAAKgI,SAASsD,OACd,EAAKhD,qBAAuB,QAC5B,EAAKP,cAAcwD,uBAEhB,kBAAM,EAAKF,OAAO,iBAAmBrL,MAEzC1O,KAAK8W,YAAa,K,mCAGf,SAAsB3Y,GACzB,IAAMuP,EAAoB1N,KAAKyW,cAAchQ,MAAMoT,mBAAmBnM,kBAC/D,IAAIA,EACP,OAAO1N,KAAK4Z,uBAIhB5Z,KAAKqa,aAAalc,GAElB6B,KAAKyW,cAAc6D,uBAAuB5M,K,+BAGvC,SAAkBvP,GACrB,IAAI0b,EAAqB7Z,KAAKyW,cAAchQ,MAAMoT,mBAC9CzP,EAAmBpK,KAAKyW,cAAchQ,MAAM2D,iBACrCsE,EAAemL,EAAmBU,yBAAyBV,EAAmBlM,kBAAoB,YAEtG,GADAe,EAAewL,OAAOC,OAAO,wCAAyCzL,GACtE,CAEP,GADOA,EAAetE,EAAiBgQ,kBAAkB1L,GAAgB,IACzE,CAMGmL,EAAmBlM,kBAElBvD,EAAiBmD,WAAWvN,KAAKkG,UAAW2T,EAAmBlM,kBAI5D,IAAIvC,EAAY,IAAIzF,EAU3B,OATO3F,KAAK4W,aAAexL,EAAU3J,SACrCoY,EAAmBnM,kBAAoBmM,EAAmBlM,iBAAmBe,EAC7E1O,KAAK0W,SAAShW,qBAAuBgO,EACrC1O,KAAK0W,SAASsD,OACPha,KAAKgX,qBAAuB,QAC5BhX,KAAK+Z,OAAO,qBAAuBrL,GAC1C1O,KAAK6W,eAAgB,EACrB7W,KAAK8W,YAAa,EAClB9W,KAAKwa,gBAAgBpP,EAAUjN,MAAO,SAC/BiN,EAAUjN,MArBb6J,MAAM,4E,qCAwBP,SAAwB7J,EAAOsc,GAC3B,IAAMhM,EAASiH,SAAS+E,GAC3BZ,EAAqB7Z,KAAKyW,cAAchQ,MAAMoT,mBAC5CnL,EAAemL,EAAmBa,uBAAuBb,EAAmBnM,kBAAmBe,GAC3FC,IACNmL,EAAmBnM,kBAAoBgB,EACvC1O,KAAK6W,eAAgB,K,qCAItB,SAAwB1Y,GAAQ,IAAD,OAC9B0b,EAAqB7Z,KAAKyW,cAAchQ,MAAMoT,mBAC9CzP,EAAmBpK,KAAKyW,cAAchQ,MAAM2D,iBAC1CjC,EAAW0R,EAAmBnM,kBACpC,IAAIvF,EAAU,OAAOnI,KAAK4Z,uBACfM,OAAOS,QAAQ,kBAAqBxS,EAAW,OAC1DiC,EAAiBwQ,aACbzS,GACA,WACH,EAAK4R,OAAO,YAAc5R,GAC1B,IAAMuG,EAAemL,EAAmBa,uBAAuBvS,EAAU,GAEzE0R,EAAmBnM,kBAAoBgB,EACvC,EAAKgI,SAAShW,qBAAuBgO,EACrC,EAAKgI,SAASsD,OACd,EAAKvD,cAAcwD,uBAEhB,kBAAM,EAAKF,OAAO,mBAAqB5R,Q,gCAIxC,SAAmBhK,EAAO0c,GACtB,MAA0B1c,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBzP,EAAlB,KAEA,OADA/F,KAAK4W,aAAe5W,KAAKkG,UAAUzE,SAAS8U,YAAYxQ,GACjDyP,I,iCAGX,SAAoBrX,EAAO0c,GACvB,IAAM9U,EAAO5H,EAAMgZ,KAAK,GACxBnX,KAAK4W,aAAe5W,KAAKkG,UAAUzE,SAAS8U,YAAYxQ,K,qCAG5D,SAAwB5H,EAAO0c,GAC3B,IAAM9U,EAAO/F,KAAKkG,UAAUzE,SAAS2U,gBACrC,GAAGrQ,EACC,OAAO5H,EAAMoG,KAAKwB,GAElB/F,KAAK4Z,yB,sCAGb,SAAyBzb,EAAO0c,GAC5B,IAAM9U,EAAO/F,KAAKkG,UAAUzE,SAAS2U,gBACrC,GAAGrQ,EAEC,OADA/F,KAAK4W,aAAe5W,KAAKkG,UAAUzE,SAAS4U,mBACrClY,EAAMoG,KAAKwB,GAGlB/F,KAAK4Z,yB,+BAGb,SAAkBzb,GACd,IACIyW,EADE7O,EAAO5H,EAAMgZ,KAAK,GAExB,OAAOpR,EAAK0O,aACZ,IAAK,WAAYG,EAAc7O,EAAK6O,YAAa,MACjD,IAAK,OAAQA,EAAc,CAAC,KAAM7O,EAAKvB,KAAK+K,WAAY,MAAMxK,KAAK,IAAK,MACxE,QAAS6P,EAAc,MAEvB5U,KAAKmZ,eAAe,UACpBnZ,KAAKiX,WAAa,CAACC,QAAQ,EAAM9S,KAAMwQ,K,8BAI3C,SAAiBzW,GACpB,IAAMqX,EAAYxV,KAAK8a,mBAAmB3c,EAAO,IAE1C,OADA6B,KAAK+a,kBAAkBvF,GAChBA,I,wCAOX,SAA2BrX,GACvB6B,KAAKmZ,eAAe,UACpB,IACI6B,EADJ,EAAuC7c,EAAMib,IAAI,GAAjD,mBAAO5D,EAAP,KAAkBzP,EAAlB,KAAwBkV,EAAxB,KAEA,OAAOlV,EAAK0O,aACZ,IAAK,WAAYuG,EAAgBjV,EAAK6O,YAAa,MACnD,IAAK,OAAQoG,EAAgB,IAAMjV,EAAKvB,KAAK+K,WAAa,IAAK,MAC/D,QAASyL,EAAgB,MAGzB,OADAhb,KAAKkb,6BAA6BF,GAC3BxF,EAAUjR,KAAK0W,K,0CAI1B,SAA6B7W,GACzB,IAAIpE,KAAKiX,WAAWC,OAAQ,OAAO,EACnC,IAAIiE,EAAanb,KAAKiX,WAAWmE,IAAIC,QACrC,QAAIF,IACDA,EAAWG,aACVH,EAAWG,aAAalX,EAAM+W,EAAWI,eAAgBJ,EAAWK,aAAc,QAGlFL,EAAWM,QACXha,SAASia,YAAY,cAAc,EAAOtX,KAEvC,K,+BAGX,SAAkBjG,GACd,GAAI6B,KAAKiX,WAAWC,OAApB,CACP,IAAIiE,EAAanb,KAAKiX,WAAWmE,IAAIC,QAC/BrO,IAAYmO,EAAaA,EAAWlR,MAAQ,OAAS,IAAI5B,OACxD,EAA8BlK,EAAMib,IAAI,GAAxC,mBAAO5D,EAAP,KAAkBmG,EAAlB,KAEA,GADA3b,KAAKiX,WAAa,CAACC,QAAQ,GACxBlK,EAAQ1I,OAAS,EAAG,CAC1B,IAAM6R,EAAW/B,EAAKwH,YAAY5O,GAGlC,MAA4B,SAAzBmJ,EAAS1B,aAAmD,SAAzBkH,EAASlH,aAC5CkH,EAASnX,KAAK+K,aAAe4G,EAAS3R,KAAK+K,WAC1CiG,EAAUjR,KAAKoX,GAEfnG,EAAUjR,KAAK6P,EAAKwH,YAAY5O,IAG7B,OAAOwI,K,+BAGf,SAAkBrX,GACd,MAA8BA,EAAMib,IAAI,GAAxC,mBAAO5D,EAAP,KAAkBmG,EAAlB,KAKA,OAJA3b,KAAKiX,WAAa,CAACC,QAAQ,GAIC,aAAzByE,EAASlH,aAA8BkH,EAASxH,WACxCqB,EAEAA,EAAUjR,KAAKoX,K,gCAG9B,SAAmBxd,EAAOiG,GAC7B,OAAOjG,EAAMoG,KAAK,IAAIyB,EAAa5B,M,uBAGhC,SAAUjG,EAAOiG,GAGb,OADPA,EAAOA,GAAQ,IACAmB,WAAW,MACRpH,EAAM2a,UAAU,IAAIlJ,EAAYxL,EAAKqB,MAAM,KAE3CtH,EAAM2a,UAAU,IAAIrI,EAASrM,M,4BAG5C,SAAejG,GAClB,OAAO6B,KAAK6b,UAAU1d,EAAO6B,KAAKsX,iB,6BAG/B,SAAgBnZ,GACnB,OAAOA,EAAM2a,UAAU,IAAItI,K,wBAMxB,SAAWrS,EAAO2d,GACrB,IAAMC,EAAa,SAAAlH,GACf,OAAOiH,GACP,IAAK,YAAa,OAAOjH,EAAOmH,cAChC,IAAK,YAAa,OAAOnH,EAAO5J,cAChC,QAAS,OAAO4J,IAGpB,EAA0B1W,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBzP,EAAlB,KACA,OAAOA,EAAK0O,aACZ,IAAK,WACD,OAAOe,EAAUjR,KAAK,IAAIyB,EAAa+V,EAAWhW,EAAK6O,eAC3D,IAAK,OACG,IAAIjF,EAIX,OAFIA,EADyB,SAA1B5J,EAAKvB,KAAKyK,YACE,IAAIwB,EAASsL,EAAWhW,EAAKvB,KAAKJ,OACjC2B,EAAKvB,KACdgR,EAAUsD,UAAUnJ,GAE5B,QACI,OAAOxR,EAAMoX,gB,yBAKd,SAAYpX,EAAO8d,GAA6B,IAArBC,EAAoB,uDAAL,IACvCC,EAAQzG,SAASwG,GAChB,EAAqC/d,EAAMsX,UAAU0G,GAArD,iBAAO3G,EAAP,KAAqB4G,EAArB,WACMC,EAAc,IAAIzM,EAAYqM,EAAQG,GAC5C,OAAO5G,EAAUsD,UAAUuD,K,+BAM/B,SAAkBle,EAAOme,EAAUC,GACtC,IACI/X,EADJ,EAA8BrG,EAAMsX,UAAU,GAA9C,mBAAOD,EAAP,KAAkBgH,EAAlB,KAIIhY,EADY,SAAb8X,GAAoC,SAAbA,EACf,IAAI1M,EAAY,eAAgB,CAAC,IAAIa,EAAS6L,KAE9C,IAAI1M,EAAY0M,QACHjN,IAArBkN,IACC/X,EAAO,IAAIyM,EAAyBzM,EAAM,KAAM,IAAIiM,EAAS8L,KACjE,IAAMF,EAAcvN,EAAKmD,aAAazN,EAAMoM,EAAcgI,iBAAiB4D,IAC3E,OAAOhH,EAAUsD,UAAUuD,K,0BAKxB,SAAale,EAAOse,GACvB,MAAwBte,EAAMsX,UAAU,GAAxC,mBAAKD,EAAL,KAAgBhR,EAAhB,KACA,GAAwB,SAArBA,EAAKyK,aACU,MAAdzK,EAAKJ,MAA8B,MAAdI,EAAKJ,MAEzB,GAAwB,YAArBI,EAAKyK,aAAsD,IAAzBzK,EAAKgO,kBACvB,eAAtBhO,EAAKa,cAAuD,WAAtBb,EAAKa,cAA4B,CACrE,IAAMqX,EAAalY,EAAKsL,cAAc,GACR,SAA3B4M,EAAWzN,aACU,MAApByN,EAAWtY,MAAoC,MAApBsY,EAAWtY,OAC7CI,EAAO,IAAIoL,EACPpL,EAAKa,aACL,CAAC,IAAIuK,EAAgC,MAApB8M,EAAWtY,KAAe,QAAU,kBARtDI,EAAO,IAAIoL,EAA0B,MAAdpL,EAAKJ,KAAe,QAAU,SAUzD,IAAMiY,EAAc,IAAIzM,EAAY6M,EAAQ,CAACjY,IAC7C,OAAOgR,EAAUsD,UAAUuD,K,sBAGxB,SAASle,EAAOwe,GACZ,MAAwBxe,EAAMsX,UAAU,GAAxC,mBAAKD,EAAL,KAAgBhR,EAAhB,KAGwB,YAArBA,EAAKyK,aACiB,cAAtBzK,EAAKa,cAAyD,IAAzBb,EAAKgO,kBACzChO,EAAOA,EAAKsL,cAAc,IAErC,IAAMH,EAAW,IAAIC,EAAY,YAAa,CAAC,IAAIa,EAASkM,GAAYnY,IACjE,OAAOgR,EAAUsD,UAAUnJ,K,2BAG/B,SAAcxR,EAAOye,GAGjB,OAFA5c,KAAKmZ,eAAe,cACpBnZ,KAAKgX,qBAAuB,WACrB7Y,EAAM2a,UAAU,IAAIpH,EAAgBkL,EAAiB,O,iCAGhE,SAAoBze,EAAO0e,GAEvB,GADA7c,KAAKmZ,eAAe,qBAChB0D,EAAJ,CAKA,GAAI7c,KAAKrB,kBAAkBqE,KAI3B,OAAIhD,KAAKrB,kBAAkBoT,OAM3B/R,KAAKrB,kBAAkBme,OAASD,EACzB7c,KAAK+c,0BAA0B5e,KANlC6B,KAAKrB,kBAAkBoT,MAAQ8K,EACK,IAAjC7c,KAAKrB,kBAAkBwd,MACfnc,KAAK+c,0BAA0B5e,QACrC,GAPL6B,KAAKrB,kBAAkBqE,KAAO6Z,OAJ9B7c,KAAKrB,kBAAoB,CAACwd,MAAO,K,uCAiBzC,SAA0Bhe,EAAO+d,GAC7Blc,KAAKmZ,eAAe,qBACpBnZ,KAAKrB,kBAAkBwd,MAAQzG,SAASwG,K,uCAG5C,SAA0B/d,GACtB6B,KAAKmZ,eAAe,QACpB,IAAM6D,EAAIhd,KAAKrB,kBACf,EAA8BR,EAAMsX,UAAUuH,EAAEb,OAAhD,iBAAO3G,EAAP,KAAqB7E,EAArB,WACMhB,EAAW,IAAIiB,EAAcoM,EAAEha,KAAMga,EAAEjL,MAAOiL,EAAEF,OAAQnM,GAE9D,OADA3Q,KAAKrB,kBAAoB,GAClB6W,EAAUsD,UAAUnJ,K,sBAI/B,SAASxR,EAAO8d,GACZ,IACI5L,EADJ,EAA2ClS,EAAMsX,UAAU,GAA3D,mBAAOD,EAAP,KAAkBlF,EAAlB,KAA6BC,EAA7B,KAMA,OAHIF,EADD4L,EAAO1W,WAAW,MACD,IAAIqK,EAAYqM,EAAOxW,MAAM,IAE7B,IAAIgL,EAASwL,GAC1BzG,EAAUsD,UAAU,IAAI1I,EAAUC,EAAeC,EAAWC,M,uBAIvE,SAAUpS,EAAO8d,GACpB,IACI5L,EADJ,EAA+BlS,EAAMsX,UAAU,GAA/C,mBAAOD,EAAP,KAAkBtF,EAAlB,KAMA,OAHWG,EADD4L,EAAO1W,WAAW,MACD,IAAIqK,EAAYqM,EAAOxW,MAAM,IAE7B,IAAIgL,EAASwL,GACjCzG,EAAUsD,UAAU,IAAI9I,EAAWE,EAAWG,M,oCAKlD,SAAuBlS,EAAO8d,GACjC,IACI5L,EADJ,EAAyClS,EAAMsX,UAAU,GAAzD,mBAAKD,EAAL,KAAgBlF,EAAhB,KAA2BC,EAA3B,KASA,MAP8B,WAA3BA,EAAWtB,aAC4B,SAAvCsB,EAAWJ,YAAYlB,aAA0D,MAAhCsB,EAAWJ,YAAY/L,MACvEiM,EAAgB,IAAII,EAAoB,MAAXwL,EAAiB,IAAM,KACpD1L,EAAaA,EAAWL,WAGxBG,EAAgB,IAAII,EAASwL,GAC1BzG,EAAUsD,UAAU,IAAI1I,EAAUC,EAAeC,EAAWC,M,yBAMhE,SAAYpS,EAAO8e,GACf,MAA8C9e,EAAMsX,UAAU,GAA9D,mBAAOD,EAAP,KAAkB0H,EAAlB,KAA8BC,EAA9B,KACA,GAA8B,UAA3BD,EAAWjO,YAAd,CAIA,IAAMmO,EAAc,IAAIxN,EAAYqN,EAAY,CAACE,EAAcD,EAAW7M,gBACpEV,EAAW,IAAIS,EAAUgN,EAAaF,EAAW5M,UAAW4M,EAAW3M,YAC7E,OAAOiF,EAAUsD,UAAUnJ,GALvB3P,KAAKiY,sB,uBAQb,c,qBAGA,c,uBAIA,SAAU9Z,EAAOkf,GACpB,MAAyClf,EAAMib,IAAI,GAAnD,mBAAK5D,EAAL,KAAgB8H,EAAhB,KAA2BC,EAA3B,KACA,GAA6B,SAA1BD,EAAU7I,aAAqD,SAA3B8I,EAAW9I,YAAwB,CACtE,IAAInE,EAAYgN,EAAU9Y,KAAM+L,EAAagN,EAAW/Y,KAC9B,qBAAhB6Y,IAGb/M,EAAYM,EAAcgI,iBAAiBtI,GAC3CC,EAAaK,EAAcgI,iBAAiBrI,IAElC,IAAMZ,EAAWb,EAAKmD,aAAa3B,EAAWC,GAC9C,OAAOiF,EAAUsD,UAAUnJ,GAEjC,GAA6B,aAA1B2N,EAAU7I,aAAyD,aAA3B8I,EAAW9I,YAA4B,CAEnF,IAAM+I,EAAWF,EAAU1I,YAAc2I,EAAW3I,YACpD,OAAOY,EAAUjR,KAAK,IAAIyB,EAAawX,IAGvC,OAAOrf,EAAMoX,e,iCAGd,SAAoBpX,GACvB,MAAoDA,EAAMsX,UAAU,GAApE,mBAAKD,EAAL,KAAgBiI,EAAhB,KAA+BC,EAA/B,KACMC,EAAaF,EAAcG,aACjC,GAAGD,EAAY,CACX,IAAMhO,EAAW8N,EAAcnL,gBAAgBqL,EAAYD,GAC3D,OAAOlI,EAAUsD,UAAUnJ,GAG3B,OAAOxR,EAAMoX,e,kCAGd,SAAqBpX,GACjB,IAEIwR,EAFEvP,EAAMJ,KAAKsX,cACjB,EAA0BnZ,EAAMsX,UAAU,GAA1C,mBAAOD,EAAP,KAAkBhR,EAAlB,KAEA,GAAwB,gBAArBA,EAAKyK,YACX,GAAGzK,EAAKqZ,mBAAmBzd,GAC9BuP,EAAWnL,EAAKsZ,qBAAqB1d,OAC7B,IAA6B,UAA1BoE,EAAKmN,kBAAwC,MAARvR,EAEhD,OAAOJ,KAAK+d,qBAAqB5f,GAGjCwR,EAAWnL,OAGDmL,EAAWnL,EAGf,OAFAxE,KAAKmZ,eAAe,cACpBnZ,KAAKgX,qBAAuB,WACrBxB,EAAUsD,UAAUnJ,K,qCAG/B,SAAwBxR,GACpB6B,KAAKmZ,eAAe,cACpBnZ,KAAKgX,qBAAuB,WAC5B,IACIrH,EADJ,EAA0BxR,EAAMsX,UAAU,GAA1C,mBAAOD,EAAP,KAAkBhR,EAAlB,KAEA,GAAwB,gBAArBA,EAAKyK,YAA+B,CACnC,GAAGzK,EAAK2P,WAGJ,OADAnU,KAAKmZ,eAAe,QACb3D,EAEX7F,EAAWnL,EAAKwZ,8BAGhBrO,EAAWnL,EACf,OAAOgR,EAAUsD,UAAUnJ,K,kCAK/B,SAAqBxR,EAAO8f,GACxB,MAA0B9f,EAAMsX,UAAU,GAA1C,mBAAOD,EAAP,KAAkBhR,EAAlB,KACA,GAAwB,gBAArBA,EAAKyK,YAA+B,CACnC,IAAIU,EAAWnL,EAAK0Z,gBAC3B,OAAIvO,GAEa,UAAdsO,IACNtO,EAAW,IAAIC,EAAY,SAAU,CAACD,KAC5B6F,EAAUsD,UAAUnJ,IAHvB6F,EAMJ,OAAOA,I,2BAMR,SAAcrX,EAAO6E,EAAM+O,EAAO+K,EAAQqB,GACtC,IAAMC,OAAoC/O,IAAtB8O,EAAmC,EAAIzI,SAASyI,GACpE,EAAoChgB,EAAMsX,UAAU2I,GAApD,iBAAO5I,EAAP,KAAqBxE,EAArB,WACMrB,EAAW,IAAIiB,EAAc5N,EAAM+O,EAAO+K,EAAQ9L,GACxD,OAAOwE,EAAUsD,UAAUnJ,K,6BAI/B,SAAgBxR,GACZ,MAAwBA,EAAMsX,UAAU,GAAxC,mBAAKD,EAAL,KAAgBhR,EAAhB,KAYA,MANiB,cAArBA,EAAKyK,aAAkD,MAAnBzK,EAAKqM,WACrB,MAApBrM,EAAKsM,YAAsBtM,EAAKwM,YAAY1M,OAAS,EACpDE,EAAO,IAAIoM,EAAc,IAAK,IAAKpM,EAAKuM,YAAavM,EAAKwM,aAC1B,cAArBxM,EAAKyK,cACTzK,EAAOoM,EAAciC,aAAarO,IAE/BgR,EAAUsD,UAAUtU,K,iCAG/B,SAAoBrG,GACvB,MAAwBA,EAAMsX,UAAU,GAAxC,mBAAKD,EAAL,KAAgBhR,EAAhB,KACA,OAAOgR,EAAUsD,UAAUlI,EAAcgI,iBAAiBpU,M,+BAIvD,SAAkBrG,EAAOkgB,GACrB,IAAMC,EAAY5I,SAAS2I,GAC3B,EAA8BlgB,EAAMsX,UAAU6I,EAAU,GAAxD,iBAAO9I,EAAP,KAAqB7E,EAArB,WACM4N,EAAe5N,EAAMA,EAAMrM,OAAO,GAAIwL,EAAgBa,EAAMlL,MAAM,EAAG6Y,GAC3E,GAAgC,YAA7BC,EAAatP,aAA8D,IAAjCsP,EAAa/L,gBACtD,OAAOgD,EAAUsD,UACb,IAAIlJ,EAAY2O,EAAalZ,aAAcyK,IAE/C9P,KAAKiY,sB,4BAIb,SAAe9Z,GACX,MAA0DA,EAAMsX,UAAU,GAA1E,mBAAOD,EAAP,KAAkBlF,EAAlB,KAA6BC,EAA7B,KAAyCF,EAAzC,KACMV,EAAW,IAAIS,EAAUC,EAAeC,EAAWC,GACzD,OAAOiF,EAAUsD,UAAUnJ,K,6BAG/B,SAAgBxR,EAAOqgB,GAG1B,GAAgC,SAA7Bxe,KAAK0W,SAAS/V,WAAuB,CACpC,IAAMoC,EAAMtB,SAASC,eAAe,eACjCqB,GAAOA,EAAI0b,YACjBze,KAAK0W,SAASgI,gBAAkB3b,EAAI0b,WAGrCze,KAAK0W,SAAS/V,WACTX,KAAK0W,SAAS/V,aAAe6d,EAAe,KAAOA,EACxDxe,KAAK0W,SAASsD,OACdha,KAAKyW,cAAckI,wB,uBAIhB,SAAUxgB,EAAOygB,EAAe3U,GACnC,IAAIyM,EAAW1W,KAAK0W,SAChB9V,EAAS8V,EAAS9V,OACtB,OAAOge,GACP,IAAK,cACD,OAAO3U,GACP,IAAK,IAAKrJ,EAAOE,YAAc,EAAG,MAClC,IAAK,IAAKF,EAAOE,cAAe,MAChC,IAAK,IAAKF,EAAOE,cAGjB,MACJ,IAAK,aACD,OAAOmJ,GACP,IAAK,kBACRrJ,EAAOI,0BAA4BJ,EAAOI,yBAC1C,MACG,IAAK,eACRJ,EAAOG,uBAAyBH,EAAOG,sBAKpC,MACJ,IAAK,aACDH,EAAOK,WAAagJ,EACpB,MACJ,IAAK,cACDrJ,EAAOM,YAAcwU,SAASzL,GAC9B,MACJ,IAAK,QACDyM,EAASjW,eAAiBwJ,EAC1B,MACJ,IAAK,eACDyM,EAAS9V,OAAS8V,EAAS7V,iBAK/B6V,EAASsD,OACTha,KAAKyW,cAAckI,sBACnB3e,KAAK6e,sB,iCAIF,SAAoB1gB,EAAO2gB,GACvB,MAAgC3gB,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB4I,EAAlB,KACA,EAAgC5I,EAAUC,UAAU2I,GAApD,iBAAO7E,EAAP,KAAuB5I,EAAvB,WACMoO,EAAc,IAAI3N,EACnB0N,GAAe,UAChB,EAAGV,EACH,CAACzN,IAEL,OAAO4I,EAAYT,UAAUiG,K,+BAMjC,SAAkB5gB,GAEd,MAA4BA,EAAM6gB,aAAa,GAA/C,mBAAOxJ,EAAP,KAAkByJ,EAAlB,KAAsBC,EAAtB,KACGD,EAAG1N,eAAiB2N,EAAG3N,cACtBiE,EAAUD,aACd,IAAM4J,EAAY,IAAI/N,EAClB8N,EAAG7N,WACH4N,EAAG3N,UAAY4N,EAAG5N,UAClB2N,EAAG1N,aACH0N,EAAGxN,cAAcO,OAAOkN,EAAGzN,gBAE/B,OAAO+D,EAAUsD,UAAUqG,K,6BAI/B,SAAgBhhB,GAEZ,MAAgCA,EAAM6gB,aAAa,GAAnD,mBAAOxJ,EAAP,KAAkB4J,EAAlB,KACA,OAAO5J,EAAUO,eAAeqJ,EAAWC,gB,gCAI/C,SAAmBlhB,GAAQ,IAAD,EAEtB,EAAiCA,EAAM6gB,aAAa,GAApD,mBAAOxJ,EAAP,KAAkBuJ,EAAlB,KACIO,GAAkB,MAAGtN,OAAH,oBAAa+M,EAAYtN,gBAC/C,OAAO+D,EAAUO,eAAeuJ,K,uCAGpC,SAA0BnhB,GACtB,MAAiCA,EAAM6gB,aAAa,GAApD,mBAAOxJ,EAAP,KAAkBuJ,EAAlB,KACA,OAAOvJ,EAAUsD,UAAUiG,EAAYQ,mB,iCAG3C,SAAoBphB,GAChB,MAAiCA,EAAM6gB,aAAa,GAApD,mBAAOxJ,EAAP,KAAkBuJ,EAAlB,KACA,OAAOvJ,EAAUsD,UAAUiG,EAAYS,gB,4BAG3C,SAAerhB,EAAOshB,GAElB,IAGI7L,EAHJ,EAAgCzV,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB4I,EAAlB,KACA,EAAgC5I,EAAUC,UAAU2I,GAApD,iBAAO7E,EAAP,KAAuB5I,EAAvB,WAGA,OAAO8O,GACP,IAAK,WAAY,IAAK,SAAU7L,EAAa,OAAQ,MACrD,IAAK,QAAS,IAAK,SAAUA,EAAa,QAAS,MACnD,QAASA,EAAa,QAG7B,IAAMnC,EAAgBL,EAAUsO,eAAe/O,EAAOiD,GAChDwL,EAAa,IAAIhO,EACnBqO,EAAYhO,EAAcnN,OAAQmN,EAAc,GAAGnN,OAAQmN,GACxD,OAAO8H,EAAYT,UAAUsG,K,2BAKjC,SAAcjhB,EAAOwhB,EAAgBC,GAIjC,IAHA,MAAgCzhB,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB4I,EAAlB,KACA,EAAgC5I,EAAUC,UAAU2I,GAApD,iBAAO7E,EAAP,KAAuB5I,EAAvB,WACInM,EAAOmM,EAAM,GACTuC,EAAI,EAAGA,EAAIkL,EAAYlL,IAAK,CACvC,IAAMlP,EAAK4b,GAAwB1M,IAAMkL,EAAW,EAAKwB,EAAuBD,EACzEnb,EAAOsK,EAAKmD,aAAazN,EAAM,IAAIiM,EAASzM,IAC5CQ,EAAOsK,EAAKmD,aAAazN,EAAMmM,EAAMuC,IAEzC,OAAOqG,EAAYT,UAAUtU,K,iCAMjC,SAAoBrG,EAAOyhB,GAC9B,MAAgCzhB,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB4I,EAAlB,KACA,EAA2C5I,EAAUC,UAAU,GAA/D,mBAAO8D,EAAP,KAAoBsG,EAApB,KACA,EAAgCtG,EAAY9D,UAAU2I,GAAtD,iBAAO0B,EAAP,KAAuBnP,EAAvB,WACInM,EAAOmM,EAAMyN,EAAW,GACzBwB,GAAwBxB,EAAa,IACpC5Z,EAAO,IAAI4L,EAAUyP,EAAqB,IAAIpP,EAASmP,GAAuBpb,IAClF,IAAI,IAAI0O,EAAIkL,EAAW,EAAGlL,GAAK,EAAGA,IAC9B1O,EAAO,IAAI4L,EAAUyP,EAAqBlP,EAAMuC,GAAI1O,GACxD,OAAOsb,EAAYhH,UAAUtU,K,+BAO1B,SAAkBrG,GACrB,MAAgCA,EAAMkb,uBAAtC,mBAAO7D,EAAP,KAAkB4I,EAAlB,KACA,EAAgC5I,EAAUC,UAAU2I,GAApD,iBAAO7E,EAAP,KACMvM,EADN,WACsBsC,KAAI,SAAA9K,GAAI,OAAIA,EAAK+K,cAAYxK,KAAK,QAClD4K,EAAW,IAAIC,EAAY,WAAY,CAAC,IAAIa,EAASzD,KAC3D,OAAOuM,EAAYT,UAAUnJ,K,0BAG1B,SAAaxR,GAChB,IAGIwW,EAHJ,EAAyCxW,EAAMib,IAAI,GAAnD,mBAAK5D,EAAL,KAAgBuK,EAAhB,KAA6BC,EAA7B,KACA,GAA+B,SAA5BD,EAAYtL,YACX,OAAOtW,EAAMoX,aAEjB,GAA4B,aAAzByK,EAASvL,YACRE,EAAW,IAAI/E,EAAY,OAAQ,CAAC,IAAIa,EAASuP,EAASpL,YAAYvM,cACrE,IAA4B,SAAzB2X,EAASvL,YAGb,OAAOtW,EAAMoX,aAFbZ,EAAWqL,EAASxb,KAGxB,OAAOgR,EAAUjR,KAAK,IAAImQ,EAASqL,EAAYvb,KAAMmQ,M,kCAGlD,SAAqBxW,GACxB,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBzP,EAAlB,KAGA,OAFA/F,KAAKyW,cAAchQ,MAAMwZ,eAAiBla,EAC1C/F,KAAK+Z,OAAO,uBACLvE,EAAUjR,KAAKwB,K,qCAGnB,SAAwB5H,GAC3B,IAAM4H,EAAO/F,KAAKyW,cAAchQ,MAAMwZ,eACtC,GAAGla,EACC,OAAO5H,EAAMoG,KAAKwB,GAElB/F,KAAKiY,sB,kCAMN,SAAqB9Z,EAAO+hB,GAC/B,IAAMC,EAAoBzK,SAASwK,GACnClgB,KAAKgX,qBAAuB,WAI5B,IAAIoJ,EAAY3e,SAASC,eAAe,sBACxC,GAAI0e,EAAJ,CACA,IAAMC,EAAgBD,EAAUE,uBAAuB,YACvD,GAA4B,IAAzBD,EAAc/b,OAAjB,CACA,IAAMic,EAAeF,EAAc,GAC7BG,EAAgBD,EAAaE,UAC7BC,EAAmBH,EAAaE,UAAYF,EAAaI,aAAeP,EAAUQ,aAClFC,EAAQV,EAAkB,IAC1BW,EAAgBlf,KAAKC,MAAM2e,GAAe,EAAEK,GAASH,EAAiBG,GAC5ET,EAAU3B,UAAYqC,M,mCAGnB,SAAsB3iB,EAAO4iB,GAChC,IAAIC,EAAYvf,SAASC,eAAe,eACxC,GAAIsf,EAAJ,CACA,IAAMrf,EAAa+T,SAASqL,GAAqB,MAAQ,IACzDC,EAAUvC,WAAa7c,KAAKC,MAAMmf,EAAUJ,aAAejf,M,wCAGxD,SAA2BxD,GAC9B,IAAM8iB,EAAgBjhB,KAAKkG,UAAUzE,SAASsT,UAC9CmM,UAAUC,UAAUC,UAAUH,GAC9BjhB,KAAK+Z,OAAO,kC,yCAGT,SAA4B5b,GAC/B,MAA0BA,EAAMib,IAAI,GAApC,mBAAO5D,EAAP,KAAkBzP,EAAlB,KACMkb,EAAgBlb,EAAKgP,UAG3B,OAFAmM,UAAUC,UAAUC,UAAUH,GAC9BjhB,KAAK+Z,OAAO,iCACLvE,EAAUjR,KAAKwB,O,KCjlCjBsb,EAAKC,IAAMC,cAGXC,E,kDACF,WAAYC,GAAQ,IAAD,sBACf,cAAMA,GAIb,IAAI/K,EAAWnW,EAASmhB,0BALF,OAOf,EAAKjb,MAAQ,CACTP,UAAW,IAAIP,EACf+Q,SAAUA,EACjBmD,mBAAoB,IAAIrM,EACxBmU,oBAAqB,IAAIxX,EACzBC,iBAAkB,IAAIzD,EACfib,cAAe,IAAIpL,EAAJ,eAAuBE,GACtCmL,WAAY,IAAIzb,EACvB6Z,eAAgB,MAEb,EAAKxZ,MAAMob,WAAWC,MAAM,EAAKrb,MAAMP,WAC9C,EAAKO,MAAMkb,oBAAoBvX,iBAAmB,EAAK3D,MAAM2D,iBAC7D,EAAK3D,MAAMkb,oBAAoBhX,cAAgB,kBAAM,EAAKoX,+BAEnD,EAAKC,cAAgB,EAAKA,cAAc5a,KAAnB,gBACrB,EAAK6a,mBAAqB,EAAKA,mBAAmB7a,KAAxB,gBACjC,EAAK8a,uBAAyB,EAAKA,uBAAuB9a,KAA5B,gBAE9B,EAAKX,MAAM2D,iBAAiB+X,cAAc,EAAKC,iBAAiBhb,KAAtB,iBAzBpB,E,oDA6BnB,WAEH,GADApH,KAAKia,oBACFja,KAAKyG,MAAMiQ,SAAShW,qBACnBV,KAAKsa,uBAAuBta,KAAKyG,MAAMiQ,SAAShW,0BAC/C,CACD,IAAImZ,EAAqB7Z,KAAKyG,MAAMoT,mBAChCnD,EAAW1W,KAAKyG,MAAMiQ,SACpBvO,EAAW,WACjB0R,EAAmBlM,iBAAmBkM,EAAmBnM,kBAAoBvF,EAC7EuO,EAAShW,qBAAuByH,EAChCuO,EAASsD,U,wCAIV,WACHha,KAAKqiB,SAAS,CAACxI,mBAAoB7Z,KAAKyG,MAAMoT,uB,yCAG3C,WACH,IAAM8H,EAAsB3hB,KAAKyG,MAAMkb,oBACvC3hB,KAAKqiB,SAAS,CAACV,oBAAqBA,IACjCA,EAAoBjX,yBACnBiX,EAAoBjX,wBAAyB,EAC7C1K,KAAKia,uB,+BAKN,WACHja,KAAKyG,MAAM2D,iBAAiBkY,gBACxBtiB,KAAKuiB,2BAA2Bnb,KAAKpH,MACrCA,KAAKwiB,wBAAwBpb,KAAKpH,S,wCAGnC,SAA2ByN,GAC9B,IAAIoM,EAAqB7Z,KAAKyG,MAAMoT,mBACpCA,EAAmBjM,aAAc,EACjCiM,EAAmBpM,UAAYA,EAC/BoM,EAAmB4I,eAAe,YAAY,GAC9CziB,KAAKqiB,SAAS,CAACxI,mBAAoBA,M,qCAGhC,WACH,IAAIA,EAAqB7Z,KAAKyG,MAAMoT,mBACpCA,EAAmBjM,aAAc,EACjC5N,KAAKqiB,SAAS,CAACxI,mBAAoBA,M,oCAGhC,SAAuB1R,GAC1BnI,KAAKyG,MAAM2D,iBAAiBsY,WACxBva,EACAnI,KAAK2iB,mBAAmBvb,KAAKpH,MAC7BA,KAAK4iB,gBAAgBxb,KAAKpH,S,gCAG3B,SAAmBmI,EAAU4P,GAChC,IAAM8B,EAAqB7Z,KAAKyG,MAAMoT,mBAChCnD,EAAW1W,KAAKyG,MAAMiQ,SAC5BmD,EAAmBnM,kBAAoBmM,EAAmBlM,iBAAmBxF,EAC7EuO,EAAShW,qBAAuByH,EAChCuO,EAASsD,OACTha,KAAKqiB,SAAS,CAACnc,UAAW6R,EAAe8B,mBAAoBA,IAC7D7Z,KAAKyG,MAAMob,WAAWC,MAAM/J,GAC5B/X,KAAKyG,MAAMmb,cAAc7H,OAAO,WAAa5R,K,6BAM1C,SAAgBA,EAAU0a,M,+BAI1B,WACH7iB,KAAK2e,sBACEzE,OAAO1N,iBAAiB,UAAWxM,KAAKgiB,eACxC9H,OAAO1N,iBAAiB,eAAgBxM,KAAKiiB,oBACpD/H,OAAO1N,iBAAiB,mBAAoBxM,KAAKkiB,wBAGjDliB,KAAKia,sB,iCAGF,WACAja,KAAK8iB,gBAAgBzH,SAAWrb,KAAK+iB,mBAAmB1H,SACxDrb,KAAKgjB,gBAAgB3H,SACpBrb,KAAKyG,MAAMiQ,SAASiI,oBACvB3e,KAAK8iB,gBAAgBzH,QAASrb,KAAK+iB,mBAAmB1H,QACtDrb,KAAKgjB,gBAAgB3H,W,kCAInB,WACInB,OAAO+I,oBAAoB,UAAWjjB,KAAKgiB,eAC3C9H,OAAO+I,oBAAoB,eAAgBjjB,KAAKiiB,oBACvD/H,OAAO+I,oBAAoB,mBAAoBjjB,KAAKkiB,0B,oBAKjD,WACI,IAAIhc,EAAYlG,KAAKyG,MAAMP,UAM3B,OAJPlG,KAAK8iB,gBAAkBxB,IAAM4B,YAC7BljB,KAAK+iB,mBAAqBzB,IAAM4B,YAChCljB,KAAKgjB,gBAAkB1B,IAAM4B,YAEf7B,EACH,MAAO,CAAC8B,GAAI,eAAgBC,UAAW,SAAWpjB,KAAKyG,MAAMiQ,SAASjW,gBACtE4gB,EAAG,MAAO,CAAC+B,UAAW,oBAAqBD,GAAI,cAAe/H,IAAKpb,KAAK8iB,iBACrEzB,EAAGgC,EAAwB,CAACnd,UAAWA,EAAW0b,cAAe5hB,KAAKyG,MAAMmb,gBAC5EP,EAAGiC,EAAqB,CAClC5M,SAAU1W,KAAKyG,MAAMiQ,SACrBvY,MAAO+H,EAAU/H,MACjByjB,cAAe5hB,KAAKyG,MAAMmb,iBAEnBP,EAAG,MAAO,CAAC+B,UAAW,uBAAwBD,GAAI,iBAAkB/H,IAAKpb,KAAK+iB,oBAClF1B,EAAG,MAAO,CAAC8B,GAAI,sBACnB9B,EAAGkC,EAAmB,CAClB7M,SAAU1W,KAAKyG,MAAMiQ,SACrBjV,SAAUyE,EAAUzE,SACpB0G,SAAUnI,KAAKyG,MAAMoT,mBAAmBlM,iBACxC7H,SAAUI,EAAUJ,aAEvBub,EAAGmC,GAAqB,CAC3B9M,SAAU1W,KAAKyG,MAAMiQ,SACrBsM,gBAAiBhjB,KAAKgjB,gBAClBrB,oBAAqB3hB,KAAKyG,MAAMkb,oBAChCvX,iBAAkBpK,KAAKyG,MAAM2D,iBAC7ByP,mBAAoB7Z,KAAKyG,MAAMoT,wB,2BAKjC,SAAcrS,GAEjB,IAAGA,EAAMic,SAAUjc,EAAMkc,QAAzB,CAEO,IAAMtjB,EAAMJ,KAAK2jB,oBAAoBnc,GACjCtB,EAAYlG,KAAKyG,MAAMP,UAC3B,EAAmClG,KAAKyG,MAAMmb,cAAcgC,WAAW1d,EAAW9F,GAAlF,mBAAKyjB,EAAL,KAAkB9L,EAAlB,KACA,GAAG8L,EAAa,CACZrc,EAAMsc,iBAEN,IAAMC,EAAU/jB,KAAKgkB,kBAAkBjM,GACpCgM,EACChM,EAAgBgM,EAEhB/jB,KAAKyG,MAAMmb,cAAc3J,oBAEpC,IAAIgM,EAAgB,CAAC/d,UAAW6R,GAC7B/X,KAAKyG,MAAMmb,cAAc/K,gBAC/B7W,KAAKia,oBACLgK,EAAcpK,mBAAqB7Z,KAAKyG,MAAMoT,oBAEpC7Z,KAAKqiB,SAAS4B,O,iCAItB,SAAoBzc,GAChB,IAAIpH,EAAMoH,EAAMpH,IAWhB,OATIA,EAAImF,WAAW,UAAoB,UAARnF,GAA2B,cAARA,IAAwBoH,EAAM0c,WAC5E9jB,EAAM,SAAWA,GAClBoH,EAAM2c,UACL/jB,EAAM,QAAUA,GAMbA,I,gCAIX,SAAmBoH,GACtB,IAAMW,EAAWnI,KAAKyG,MAAMoT,mBAAmBlM,iBAGxC,OAFGxF,GACNnI,KAAKyG,MAAM2D,iBAAiBmD,WAAWvN,KAAKyG,MAAMP,UAAWiC,GACnD,O,oCAMX,SAAuBX,GAC1BxH,KAAKqiB,SAAS,M,+BAIX,SAAkBtK,GACd,IAAI8J,EAAa7hB,KAAKyG,MAAMob,WAC5B,OAAO7hB,KAAKyG,MAAMmb,cAAc5K,sBAChC,IAAK,OAAQ,OAAO6K,EAAWuC,aAC/B,IAAK,OAAQ,OAAOvC,EAAWwC,aAC/B,IAAK,WAAY,OAAOtM,EACxB,IAAK,QAED,OADA8J,EAAWC,MAAM/J,GACVA,EACX,QAGI,OADA8J,EAAWyC,WAAWvM,GACfA,O,GAxODuJ,IAAMiD,WA+OlBlB,E,4JACF,WACH,IAAImB,OAAiBnV,EACf0H,EAAoB/W,KAAKyhB,MAAMG,cAAc7K,kBACnD,GAAGA,EAAmB,CAElB,IAAM0N,EAAQ1N,EAAkB5E,QAAQ,KAE3CqS,EADMC,GAAS,EACEpD,EACb,OAAQ,CAAC+B,UAAW,gBACpB/B,EAAG,OAAQ,GAAItK,EAAkBtR,MAAM,EAAGgf,EAAM,IAChDpD,EAAG,OAAQ,CAAC+B,UAAW,eAAgBrM,EAAkBtR,MAAMgf,EAAM,KAExDpD,EAAG,OAAQ,CAAC+B,UAAW,gBAAiBrM,OAEhB,SAAlC/W,KAAKyhB,MAAMG,cAAczhB,OACtBqkB,EAAiBnD,EAC3B,OAAQ,CAAC+B,UAAW,QACpBpjB,KAAKyhB,MAAMG,cAAczhB,KAAKiI,WAAW,IAAK,OAC/C,OAAOiZ,EAAG,MAAO,CAAC+B,UAAW,aAAcoB,O,GAnBPlD,IAAMiD,WAwBrCjB,E,4JACF,WACI,IAAI1B,EAAgB5hB,KAAKyhB,MAAMG,cACzB8C,EAAoB9C,EAAc3K,WAAWC,OAC7CyN,EAAmB3kB,KAAKyhB,MAAMtjB,MAAM8K,MAAM3E,OAAO,EACjDsgB,EAAkB5kB,KAAKyhB,MAAMtjB,MAAM8K,MAAMqG,KAAI,SAACvJ,EAAM6I,GACtD,OAAG8V,GAAqB9V,IAAU+V,GAG9B/C,EAAc3K,WAAWmE,IAAMkG,IAAM4B,YAC9B7B,EACjBwD,GAAqB,CACxBC,aAAclD,EAAc3K,WAAWmE,IACvCwG,cAAeA,EACfxhB,IAAK,gBAIeihB,EACH0D,GAAe,CACXhf,KAAMA,EACNif,UAAU,EAC/BC,SAAU3D,IAAM4B,YACK9iB,IAAK2F,EAAKmf,UAAUtW,QAIvCuW,EAAc,CAAC,eAGZ,OAFJnlB,KAAKyhB,MAAM/K,SAAS9V,OAAOG,uBAC1BokB,EAAY5gB,KAAK,mBACP8c,EAAG,MAAO,CAAC+B,UAAW+B,EAAYpgB,KAAK,MAAO6f,O,GA9B3BtD,IAAMiD,WAmClChB,E,4JACF,WAAU,IAAD,OACC9hB,EAAWzB,KAAKyhB,MAAMhgB,SACtB2jB,EAAgB3jB,EAASwH,MAAMqG,KAAI,SAACvJ,EAAM6I,GACnD,IAAIqW,EAAW3D,IAAM4B,YACRmC,EAAc5jB,EAASyU,kBAAoBtH,EAAM,EAEvD,OADJyW,IAAa,EAAKC,kBAAoBL,GAC3B5D,EACH0D,GAAe,CACXhf,KAAMA,EACNif,SAAUK,EACVJ,SAAUA,EACV7kB,IAAK2F,EAAKmf,UAAUtW,QAOvCwW,EAAc7gB,KACV8c,EAAG,MAAO,CAAC+B,UAAW,gBAAiBhjB,IAAK,mBAGhD,IAAMmlB,EAA+C,IAA7B9jB,EAASyU,gBACpBsP,EAAa,uBAAyBD,EAAkB,WAAa,IAC5Epd,GAAYnI,KAAKyhB,MAAMtZ,UAAY,QAAUnI,KAAKyhB,MAAM3b,SAAW,IAAM,IAC5Eyf,IACCvlB,KAAKslB,kBAAoBhE,IAAM4B,aAC5B,IAAMuC,EAAsBpE,EAC/B,MAAO,CACV+B,UAAWoC,EACXplB,IAAK,sBACLgb,IAAKmK,EAAkBvlB,KAAKslB,kBAAoB,MAE7CtlB,KAAKyhB,MAAMtZ,UAAYkZ,EAAG,OAAQ,GAAI,MACtCrhB,KAAKyhB,MAAMtZ,UAAYkZ,EAAG,OAAQ,CAAC+B,UAAW,YAAajb,GAC3DnI,KAAKyhB,MAAMtZ,UAAYkZ,EAAG,OAAQ,GAAI,OAGtC8D,EAAc,CAAC,kBAGZ,OAFJnlB,KAAKyhB,MAAM/K,SAAS9V,OAAOI,0BAC1BmkB,EAAY5gB,KAAK,mBACP8c,EAAG,MAAO,CAAC+B,UAAW+B,EAAYpgB,KAAK,MAClD,CAAC0gB,GAAqBzT,OAAOoT,M,gCAG7B,WACHplB,KAAK0lB,6B,sCAGF,WACH,GAAI1lB,KAAKslB,kBAAT,CACO,IAAMvf,EAAO/F,KAAKslB,kBAAkBjK,QAC3C,GAAItV,EAAJ,CACO,IAAIqa,EAAY3e,SAASC,eAAe,sBAClCikB,EAAc5f,EAAK4a,aAAa,EACnC5a,EAAK0a,UAAYL,EAAU3B,YAC1B2B,EAAU3B,UAAY1Y,EAAK0a,UAAYkF,GACxC5f,EAAK0a,UAAY1a,EAAK4a,aAAeP,EAAU3B,UAAY2B,EAAUO,eACpEP,EAAU3B,UAAY1Y,EAAK0a,UAAY1a,EAAK4a,aAAeP,EAAUO,aAAegF,S,GA3DhErE,IAAMiD,WAgEhCM,G,4JACF,WACI,OAAOxD,EAAG,WAAY,CAClB+B,UAAW,aACXwC,QAAS5lB,KAAK6lB,cAAcze,KAAKpH,MACxC8lB,WAAY,QACL1K,IAAKpb,KAAKyhB,MAAMqD,iB,2BAIxB,SAActd,GACV,IAAMwF,EAAUhN,KAAKyhB,MAAMqD,aAAazJ,QAAQpR,MAChDjK,KAAKyhB,MAAMG,cAAc3K,WAAW7S,KAAO4I,I,+BAG/C,WACI,IAAI+Y,EAAW/lB,KAAKyhB,MAAMqD,aAAazJ,QACjC2K,EAAehmB,KAAKyhB,MAAMG,cAAc3K,WAAW7S,KACtD4hB,IAAcD,EAAS9b,MAAQ+b,GAClCD,EAAStK,Y,GAnBiB6F,IAAMiD,WAwBlC0B,G,4JACF,WACH,IAAMC,GAAsBlmB,KAAKyhB,MAAM5H,mBAAmBjM,YAEnD,OADP5N,KAAKmmB,eAAiB7E,IAAM4B,YACd7B,EACH,MAAO,CAAC+B,UAAW,cAAeD,GAAI,eAC7C9B,EAAG,KAAM,GAAI,gBACNrhB,KAAKomB,oBACZpmB,KAAKqmB,mBACLH,GAAsB7E,EAAG,KAAM,GAAI,iBACnC6E,GAAsBlmB,KAAKsmB,kC,0CAI5B,WACH,IAAM3E,EAAsB3hB,KAAKyhB,MAAME,oBACnCyD,EAAgB,GAgBpB,GAdAA,EAAc7gB,KACV8c,EAAG,IAAK,GAAI,8JAEhB+D,EAAc7gB,KACV8c,EAAG,IAAK,GACLA,EAAG,SAAU,GAAIM,EAAoB4E,mBAEX,SAA9B5E,EAAoBlb,OACnB2e,EAAc7gB,KACjB8c,EAAG,IAAK,GACLA,EAAG,IAAK,CACJmF,KAAM,IACNC,QAASzmB,KAAK0mB,gBAAgBtf,KAAKpH,OACpC,oBACJ2hB,EAAoBgF,qBAAsB,CACzC,IAAMC,EAAkBjF,EAAoBkF,6BAC5CzB,EAAc7gB,KACjB8c,EAAG,IAAK,GACLA,EAAG,IAAK,CAACmF,KAAM7E,EAAoBnX,aAAcsc,SAAUF,GACxD,aAAeA,KA0BtB,MAtBiC,SAA9BjF,EAAoBlb,OACnB2e,EAAc7gB,KACjB8c,EAAG,IAAK,GACLA,EAAG,OAAQ,GAAI,qBACfA,EAAG,QAAS,CACRxV,KAAM,OACNuP,IAAKpb,KAAKmmB,iBAEd9E,EAAG,QAAS,CACRxV,KAAM,SACN5B,MAAO,SACPwc,QAASzmB,KAAK+mB,mBAAmB3f,KAAKpH,UAKb,SAA9B2hB,EAAoBlb,OAAoBkb,EAAoBlX,sBAC3D2a,EAAc7gB,KACjB8c,EAAG,IAAK,GACLA,EAAG,OAAQ,CAAC/f,MAAO,CAAC0lB,WAAY,SAAU,mBAC1C3F,EAAG,OAAQ,GAAIM,EAAoBlX,wBAEhC4W,EAAE,WAAF,GAAG,MAAO,IAAV,OAAiB+D,M,+BAGrB,WAAqB,IAAD,OACjBvL,EAAqB7Z,KAAKyhB,MAAM5H,mBACtC,OAAGA,EAAmBjM,YACXyT,EAAG,IAAK,GAAI,sKACfxH,EAAmBpM,WAAaoM,EAAmBpM,UAAUnJ,OAAS,EACnE+c,EACV,MAAO,GACPA,EAAG,QAAS,CAAC+B,UAAW,cACrB/B,EAAG,QAAS,GACTA,EAAG,KAAM,GACbA,EAAG,KAAM,CAAC+B,UAAW,YAAa,YAClC/B,EAAG,KAAM,CAAC+B,UAAW,WAAY6D,QAAS,KAAM,QAChD5F,EAAG,KAAM,CAAC+B,UAAW,YAAa6D,QAAS,KAAM,mBAChD5F,EAAG,QAAS,GACTxH,EAAmBpM,UAAU6B,KAChC,SAAC3D,EAAMiD,GAAP,OAAiB,EAAKsY,sBAAsBvb,EAAMiD,SAE9CiL,EAAmBpM,UAChB4T,EAAG,IAAK,GAAI,yBAEZA,EAAG,IAAK,GAAI,2B,mCAGpB,SAAsB1V,EAAMiD,GAC/B,IAAMiL,EAAqB7Z,KAAKyhB,MAAM5H,mBAClCsL,EAAc,GACfxZ,EAAKxD,WAAa0R,EAAmBnM,mBAAmByX,EAAY5gB,KAAK,iBACzEoH,EAAKxD,WAAa0R,EAAmBlM,kBAAkBwX,EAAY5gB,KAAK,gBAC3E,IAAM+U,EAAa3N,EAAK3C,oBAAsB2C,EAAK7C,iBACnD,OAAOuY,EACH,KAAM,CAAC+B,UAAW+B,EAAYpgB,KAAK,KAAM3E,IAAK,QAAUuL,EAAKxD,UAC7DkZ,EAAG,KAAM,CAAC+B,UAAW,YAAazX,EAAKxD,UACvCkZ,EAAG,KAAM,CAAC+B,UAAW,YAClBxhB,KAAKulB,OAAOxb,EAAK/C,SAAS,MAAM,MAAQ,OAC3CyY,EAAG,KAAM,CAAC+B,UAAW,YAClB9J,EAAa,WAA4B,IAAfA,EAAmB,GAAK,MACrD+H,EAAG,KAAM,CAAC+B,UAAW,aAAczX,EAAKzC,UAAUke,sBAClD/F,EAAG,KAAM,CAAC+B,UAAW,aAAczX,EAAKzC,UAAUme,yB,8BAGnD,WACH,IAAM1Z,EAAmB3N,KAAKyhB,MAAM5H,mBAAmBlM,iBAUjD2Z,EATa,CACf,CAAC,SAAU,sBACX,CAAC,SAAU,6BACX,CAAC,QAAS,sBACV,CAAC,IAAK,wBACN,CAAC,IAAK,0BACN,CAAC,IAAK,qBAAuB3Z,EAAoB,KAAOA,EAAmB,IAAO,KAClF,CAAC,IAAK,eAE0B2B,KAAI,SAAAiY,GACpC,kBAA4BA,EAA5B,GAAOC,EAAP,KAAgBC,EAAhB,KACA,OAAOpG,EACV,KAAM,GACNA,EAAG,OAAQ,CAAC+B,UAAW,cAAeoE,GACtCnG,EAAG,OAAQ,GAAI,IAAMoG,OAEtB,OAAOpG,EAAE,WAAF,GAAG,KAAM,CAAC+B,UAAW,gBAArB,mBAAwCkE,O,gCAG5C,SAAmB9f,GACtB,IAAMkgB,EAAiB1nB,KAAKmmB,eAAe9K,QAC3C,GAAIqM,EAAJ,CACA,IAAMja,EAAYia,EAAe1pB,MACT,IAArByP,EAAUnJ,OACTtE,KAAK2nB,gBAAgBla,EAAU,IAC3BA,EAAUnJ,OAAS,EACvB0D,MAAM,+CAENA,MAAM,2C,6BAGP,SAAgB2D,GACnB,IAAMgW,EAAsB3hB,KAAKyhB,MAAME,oBACN,SAA9BA,EAAoBlb,OACnBkb,EAAoBgG,gBAAgBhc,K,6BAGrC,WACH,IAAMgW,EAAsB3hB,KAAKyhB,MAAME,oBACN,SAA9BA,EAAoBlb,OACnBkb,EAAoB+E,sB,GApJUpF,IAAMiD,WA2JnCQ,G,4JACF,WACI,IAAIhf,EAAO/F,KAAKyhB,MAAM1b,KAClBqV,EAAMpb,KAAKyhB,MAAMwD,SACf7B,EAAYpjB,KAAKyhB,MAAMuD,SAAW,YAAc,GACtD,OAAOjf,EAAK0O,aACZ,IAAK,OACR,OAAG1O,EAAK4O,UACX3U,KAAK4nB,QAAUtG,IAAM4B,YACd7B,EACH,MAAO,CAAC+B,UAAW,aACnB/B,EAAG,MAAO,CAAC+B,UAAW,WAAYhI,IAAKpb,KAAK4nB,SAAU,IACtDvG,EAAG,MAAO,CAAC+B,UAAWA,EAAY,iBAAkBhI,IAAKA,GAAM,MAG5DiG,EACH,MAAO,CAAC+B,UAAW,aACnB/B,EAAG,MAAO,CAAC+B,UAAWA,EAAY,iBAAkBhI,IAAKA,GAAM,KAC7D,IAAK,WACD,OAAOiG,EAAG,MAAO,CACb+B,UAAWA,EAAY,WACvByE,wBAAyB,CAAEC,OAAQ/hB,EAAKiP,eACxCoG,IAAKA,IAEb,QACI,OAAOiG,EAAG,MAAO,GAAI,W,+BAI7B,WACI,IAAItb,EAAO/F,KAAKyhB,MAAM1b,KACzBgiB,EAAO/nB,KAAKyhB,MAAMwD,SAAS5J,QAC/B,GAAI0M,EACG,GAAwB,SAArBhiB,EAAK0O,YAEJzU,KAAKgoB,mBAAmBjiB,EAAKvB,KAAK+K,WAAYwY,GAAM,GACxDhiB,EAAK4O,UAAY3U,KAAK4nB,QAAQvM,SACpCrb,KAAKgoB,mBAAmBjiB,EAAK4O,SAASpF,WAAYvP,KAAK4nB,QAAQvM,SAAS,QAE7D,GAAwB,aAArBtV,EAAK0O,YAGT,IADA,IAAIwT,EAAWF,EAAKG,qBAAqB,QACjChV,EAAI,EAAGA,EAAI+U,EAAS3jB,OAAQ4O,IAAK,CACrC,IAAIiV,EAAWF,EAAS/U,GAClBkV,EAAaD,EAASE,aAAe,GAC3CroB,KAAKgoB,mBAAmBI,EAAYD,GAAU,M,gCAK1D,SAAmBC,EAAYL,EAAMO,GACf,KAAfF,GAAoC,QAAfA,IAEpBA,EAAa,qCAExB,IAEWG,IAAMC,OAChBJ,EAAYL,EACZ,CAAEU,cAAc,EAAOC,YAAaJ,EAAcK,OAAO,EAAMC,OAAO,IAEvE,MAAMtb,GAGF,IAAMub,EAAMvb,EAAExC,WACdid,EAAKe,UAAY,2BAA6BD,EAAM,c,GAjE7BvH,IAAMiD,WAuE5Bf,G,4JACF,WACHxjB,KAAK+oB,KAAO,CACR7qB,KAAMojB,IAAM4B,YACZ8F,aAAc1H,IAAM4B,aAExB,IAAMviB,EAAaX,KAAKyhB,MAAM/K,SAAS/V,WACnCsoB,EAAe,KAgBnB,MAfkB,UAAftoB,EACCsoB,EAAe5H,EAClB,MAAO,CAAC8B,GAAI,mBACZ9B,EAAG4E,GAAsB,CACrBtE,oBAAqB3hB,KAAKyhB,MAAME,oBAChCvX,iBAAkBpK,KAAKyhB,MAAMrX,iBAC7ByP,mBAAoB7Z,KAAKyhB,MAAM5H,sBAGb,WAAflZ,IACJsoB,EAAe5H,EAClB,MAAO,CAAC8B,GAAI,oBACZ9B,EAAG6H,GAAsB,CAACjrB,OAAQiC,MAG5BmhB,EACH,MAAO,CAAC8B,GAAI,cAAe/H,IAAKpb,KAAKyhB,MAAMuB,iBAC3CiG,EACA5H,EAAG,MAAO,CAAC8B,GAAI,iBAAkB/H,IAAKpb,KAAK+oB,KAAK7qB,MAC7CmjB,EAAG,MAAO,CAAC+B,UAAW,OAAQhI,IAAKpb,KAAK+oB,KAAKC,mB,+BAGjD,WACH,IAAIG,EAAkB1nB,SAASC,eAAe,YAC1C0nB,EAAgBppB,KAAK+oB,KAAKC,aAAa3N,QACxC8N,IACCA,EAAgB7nB,MAAMC,QAAU,QAChCvB,KAAKqpB,mBAAmBF,GACxBA,EAAgBG,WAAWC,YAAYJ,GACvCC,EAAcI,YAAYL,M,gCAI3B,WACH,IAAMhpB,EAAOH,KAAKyhB,MAAM/K,SAAS/V,WAC9BX,KAAK+oB,KAAK7qB,KAAKmd,UACdrb,KAAK+oB,KAAK7qB,KAAKmd,QAAQ/Z,MAAMC,QAAoB,SAATpB,EAAkB,QAAU,QAC5D,SAATA,QACwCkP,IAAxCrP,KAAKyhB,MAAM/K,SAASgI,iBACpB1e,KAAKyhB,MAAMuB,gBAAgB3H,UAE1Brb,KAAKyhB,MAAMuB,gBAAgB3H,QAAQoD,UAAYze,KAAKyhB,MAAM/K,SAASgI,gBACnE1e,KAAKyhB,MAAM/K,SAASgI,qBAAkBrP,K,gCAKvC,SAAmBoa,GAEf,IADA,IAAIxB,EAAWwB,EAASvB,qBAAqB,QACrChV,EAAI,EAAGA,EAAI+U,EAAS3jB,OAAQ4O,IAAK,CACrC,IAAIwW,EAAWzB,EAAS/U,GAClBkV,EAAasB,EAASrB,YACzBD,GACCG,IAAMC,OAAOJ,EAAYsB,EACZ,CAAEjB,cAAc,EAAOC,aAAa,S,GA9D/BpH,IAAMiD,WAoElC2E,G,4JACF,WACH,OAAO7H,EACH,QAAS,CAAC+B,UAAW,UACrB/B,EAAG,QAAS,GACTA,EAAG,KAAM,GACbA,EAAG,KAAM,CAAC+B,UAAW,QAAS,QAC9B/B,EAAG,KAAM,CAAC+B,UAAW,WAAY,OACjC/B,EAAG,KAAM,CAAC+B,UAAW,WAAY,aAChC/B,EAAG,QAAS,GAAIrhB,KAAK2pB,kB,yBAGtB,WAAe,IAAD,SAEXC,EADQ5pB,KAAK6pB,wBACIva,KAAI,SAAAnP,GAAI,OAAI,EAAK2pB,cAAc3pB,MACtD,OAAO,MAAG6R,OAAH,oBAAa4X,M,mCAGjB,WACH,IAAM3rB,EAAS+B,KAAKyhB,MAAMxjB,OACtB8rB,EAAK,YAAOC,OAAOC,KAAKhsB,IAE5B,OADA8rB,EAAMhc,OACCgc,I,2BAGJ,SAAc5pB,GAAO,IAAD,OACjB+pB,EAAUlqB,KAAKyhB,MAAMxjB,OAAOkC,GAC9B8pB,EAAI,YAAOD,OAAOC,KAAKC,IAE3B,OADAD,EAAKlc,OACEkc,EAAK3a,KAAI,SAAAlP,GAAG,OAAI,EAAK+pB,qBAAqBhqB,EAAMC,EAAK8pB,EAAQ9pB,S,kCAGjE,SAAqBD,EAAMC,EAAKoF,GACnC,IAGI4kB,EAHElF,EAAY/kB,EAAO,IAAMC,EAS/B,OAJIgqB,EADD5kB,EAAQD,WAAW,UAAYC,EAAQ2M,QAAQ,KAChCkP,EAAG,KAAM,GAAI7b,EAAQC,MAAM,EAAGD,EAAQ2M,QAAQ,OAE9CkP,EAAG,OAAQ,GAAI7b,GAE1B6b,EACH,KAAM,CAACjhB,IAAK8kB,GACZ7D,EAAG,KAAM,CAAC+B,UAAW,QAASjjB,GAC9BkhB,EAAG,KAAM,CAAC+B,UAAW,WAClB/B,EAAG,OAAQ,CAAC+B,UAAW,cAAehjB,IACzCihB,EAAG,KAAM,CAAC+B,UAAW,WAAYgH,Q,GA/CH9I,IAAMiD,WA0D1B/C,KCzuBT6I,GAAcC,QACW,cAA7BpQ,OAAOqQ,SAASC,UAEe,UAA7BtQ,OAAOqQ,SAASC,UAEhBtQ,OAAOqQ,SAASC,SAASvW,MAAM,2DAqCnC,SAASwW,GAAgBC,EAAOtsB,GAC9B8iB,UAAUyJ,cACPC,SAASF,GACT5e,MAAK,SAAC+e,GACLA,EAAaC,cAAgB,WAC3B,IAAMC,EAAmBF,EAAaG,WACd,MAApBD,IAGJA,EAAiBpgB,cAAgB,WACA,cAA3BogB,EAAiBtkB,QACfya,UAAUyJ,cAAcM,YAI1BC,QAAQC,IACN,+GAKE/sB,GAAUA,EAAOgtB,UACnBhtB,EAAOgtB,SAASP,KAMlBK,QAAQC,IAAI,sCAGR/sB,GAAUA,EAAOitB,WACnBjtB,EAAOitB,UAAUR,WAO5BS,OAAM,SAACzI,GACNqI,QAAQrI,MAAM,4CAA6CA,M,aC7EjE0I,IAAS/C,OACP,eAAC,GAAD,IACA/mB,SAASC,eAAe,SDCnB,SAAkBtD,GACvB,GAA6C,kBAAmB8iB,UAAW,CAGzE,GADkB,IAAIjV,IAAIuf,IAAwBtR,OAAOqQ,SAAS/D,MACpDiF,SAAWvR,OAAOqQ,SAASkB,OAIvC,OAGFvR,OAAO1N,iBAAiB,QAAQ,WAC9B,IAAMke,EAAK,UAAMc,IAAN,sBAEPnB,KAgEV,SAAiCK,EAAOtsB,GAEtCstB,MAAMhB,EAAO,CACXiB,QAAS,CAAE,iBAAkB,YAE5B7f,MAAK,SAAC8f,GAEL,IAAMC,EAAcD,EAASD,QAAQljB,IAAI,gBAEnB,MAApBmjB,EAASE,QACO,MAAfD,IAA8D,IAAvCA,EAAY1Z,QAAQ,cAG5C+O,UAAUyJ,cAAcoB,MAAMjgB,MAAK,SAAC+e,GAClCA,EAAamB,aAAalgB,MAAK,WAC7BoO,OAAOqQ,SAAS0B,eAKpBxB,GAAgBC,EAAOtsB,MAG1BktB,OAAM,WACLJ,QAAQC,IAAI,oEAtFVe,CAAwBxB,EAAOtsB,GAI/B8iB,UAAUyJ,cAAcoB,MAAMjgB,MAAK,WACjCof,QAAQC,IACN,+GAMJV,GAAgBC,EAAOtsB,OC1B/B+tB,K","file":"static/js/main.d1212a36.chunk.js","sourcesContent":["\nconst EditorKeymap = {\n    base: {\n\t// Self-insert keys\n\t'[alnum]': \"self_insert\",\n\t'!': \"insert !;concat\",\n\t'#': \"insert \\\\#\",\n\t'@': \"insert @\",\n\t'^': \"superscript\",\n\t'*': \"insert *\",\n\t'~': \"insert \\\\sim\",\n\n\t// Other Ctrl-based shortcuts\n\t'Ctrl+0': \"insert 0;subscript\",\n\t'Ctrl+1': \"insert -1;superscript\",\n\t'Ctrl+2': \"insert 2;superscript\",\n\t'Ctrl+3': \"insert 3;superscript\",\n\t'Ctrl+4': \"insert 4;superscript\",\n\t'Ctrl+a': \"swap\",\n\t'Ctrl+c': \"copy_to_clipboard\",\n\t'Ctrl+e': \"name exp;insert e;operator mathrm;swap;superscript\",  // exp(x) - same as [/] [e]\n\t'Ctrl+i': \"pop_to_document\",\n\t'Ctrl+j': \"extract_from_document\",\n\t'Ctrl+k': \"infix \\\\,\",\n\t'Ctrl+l': \"recenter_document 50\",\n\t'Ctrl+m': \"prefix -\",\n\t'Ctrl+o': \"name apply_fn;parenthesize;swap;operator mathopen;swap;concat\",  // same as [/] [o]\n\t'Ctrl+p': \"delimiters ( )\",\n\t'Ctrl+s': \"save_file\",\n\t'Ctrl+u': \"superscript\",\n\t'Ctrl+v': \"paste_from_clipboard\",\n\t'Ctrl+y': \"redo\",\n\t'Ctrl+z': \"undo\",\n\t'Ctrl+ ': \"infix \\\\,\",\n\t'Ctrl+,': \"infix ,\",\n\n\t// Immediate action special keys\n\t'Shift+Enter': \"edit_stack_top\",\n\t' ': \"concat autoparenthesize\",\n\t'=': \"mode relational\",\n\t'<': \"delimiters \\\\langle \\\\rangle\",\n\t'+': \"infix_plus_or_minus +\",\n\t'-': \"infix_plus_or_minus -\",\n\t']': \"operator boldsymbol\",\n\t'[': \"delimiters [ ]\",\n\t'(': \"delimiters ( )\",\n\t'{': \"delimiters \\\\{ \\\\}\",\n\n\t// Document commands\n\t'ArrowUp': \"change_document_selection -1\",\n\t'Shift+ArrowUp': \"shift_document_selection -1\",\n\t'ArrowDown': \"change_document_selection +1\",\n\t'Shift+ArrowDown': \"shift_document_selection +1\",\n\t'PageUp': \"change_document_selection -5\",  // TODO: scroll based on viewport height instead\n\t'PageDown': \"change_document_selection +5\",\n\t'Home': \"change_document_selection -10000\",\n\t'End': \"change_document_selection +10000\",\n\n\t// Prefix keys\n\t'Tab': \"mode stack\",\n\t'Enter': \"subscript\",\n\t'Backspace': \"pop\",\n\t\"`\": \"superscript\",\n\t\"'\": \"mode symbol\",\n\t'.': \"mode decoration\",\n\t',': \"mode infix\",\n\t')': \"mode delimiters\",\n\t'}': \"custom_delimiter\",\n\t';': \"mode lowercase_greek\",\n\t':': \"mode uppercase_greek\",\n\t'%': \"mode calligraphic\",\n\t'&': \"mode script\",\n\t'/': \"mode operator\",\n\t'_': \"accumulate text\",\n\t\"\\\\\": \"accumulate latex\",\n\t'|': \"mode array\",\n\t'$': \"mode config\",\n\t'?': \"toggle_popup help\",\n\t\"\\\"\": \"edit_new_item\"\n    },\n\n    files: {\n\t'default': \"toggle_popup files\",\n\t\n\t'd': \"delete_selected_file\",\n\t'n': \"start_new_file\",\n\t'Enter': \"load_selected_file\",\n\t's': \"save_file\",\n\t'S': \"save_file_as\",\n\t'ArrowUp': \"select_adjacent_file -1\",\n\t'ArrowDown': \"select_adjacent_file 1\"\n    },\n\n    keymap: {\n\t'ArrowUp': 'scroll_popup_panel -25',\n\t'ArrowDown': 'scroll_popup_panel 25',\n\t'default': \"toggle_popup keymap\"\n    },\n\n    help: {\n\t'ArrowUp': 'scroll_popup_panel -40',\n\t'ArrowDown': 'scroll_popup_panel 40',\n\t'default': \"toggle_popup help\"\n    },\n\n    // Tab prefix: stack/misc operations\n    stack: {\n\t'c': \"copy_to_clipboard\",\n\t'd': \"pop\",\n\t'i': \"pop_to_document\",\n\t'I': \"copy_to_document\",\n\t'j': \"extract_from_document\",\n\t'J': \"recall_from_document\",\n\t'l': \"recenter_document 50\",\n\t'n': \"nip\",\n\t'o': \"over\",\n\t'p': \"paste_from_clipboard\",\n\t'r': \"rot\",\n\t't': \"tuck\",\n\t'u': \"unrot\",\n\t'v': \"reverse_n\",\n\t'V': \"reverse_all\",\n\t'w': \"swap\",\n\t'X': \"clear_stack\",\n\t'Enter': \"dup\",\n\t'Tab': \"undo\",\n\t'.': \"redo\",\n\t' ': \"dup\",\n\t'!': \"export_document_as_text\",\n\t'@': \"export_stack_top_as_text\",\n\n\t// temporary\n\t'f': \"toggle_popup files\",\n\t'k': \"toggle_popup keymap\"\n    },\n\n    // $ prefix: configuration\n    config: {\n\t// 'a': \"mode config_aux\",\n\t// 'c': \"config alternate_layout\",\n\t'm': \"mode config_math_alignment\",\n\t'r': \"config reset_layout\",\n\t's': \"mode config_stack\",\n\t't': \"mode config_theme\",\n\t'z': \"mode config_zoom\",\n\n\t'$': \"insert \\\\$\"\n    },\n    // $m\n    config_math_alignment: {\n\t'd': \"config math_align toggle_document\",\n\t's': \"config math_align toggle_stack\"\n    },\n    // $s\n    config_stack: {\n\t'0': \"config stack_split 0\",\n\t'1': \"config stack_split 10\",\n\t'2': \"config stack_split 20\",\n\t'3': \"config stack_split 30\",\n\t'4': \"config stack_split 40\",\n\t'5': \"config stack_split 50\",\n\t'6': \"config stack_split 60\",\n\t'7': \"config stack_split 70\",\n\t'8': \"config stack_split 80\",\n\t'9': \"config stack_split 90\",\n\t'*': \"config stack_split 100\",\n\n\t'ArrowLeft': \"config stack_side left\",\n\t'ArrowRight': \"config stack_side right\",\n\t'ArrowUp': \"config stack_side top\",\n\t'ArrowDown': \"config stack_side bottom\"\n    },\n    // $t\n    config_theme: {\n\t'0': \"config theme default\",\n\t'1': \"config theme dawn\",\n\t'2': \"config theme dusk\",\n\t'3': \"config theme dark\"\n    },\n    // $z\n    config_zoom: {\n\t'0': \"config zoom_factor 0\",\n\t'+': \"config zoom_factor +\",\n\t'-': \"config zoom_factor -\"\n    },\n\n    // \" and \\ prefixes (text/latex accumulator)\n    accumulate: {\n\t'Enter': \"finish_text_input\",\n\t'Shift+Enter': \"finish_text_input roman\",\n\t'Escape': \"pop\",  // (cancel text input)\n\t'Backspace': \"backspace_text_input\",\n\t'default': \"append_text_input\"\n    },\n\n    // right-bracket prefix: special delimiters\n    delimiters: {\n\t'b': \"delimiters \\\\langle \\\\vert\",  //  <x| Dirac bra\n\t'c': \"delimiters \\\\lceil \\\\rceil\",\n\t'f': \"delimiters \\\\lfloor \\\\rfloor\",\n\t'g': \"delimiters \\\\lgroup \\\\rgroup\",\n\t'i': \"delimiters \\\\langle \\\\rangle \\\\vert 2\",  // <x|y>; mnemonic: [i]nner product\n\t'I': \"delimiters \\\\langle \\\\rangle \\\\vert 3\",  // <x|y|z>\n\t'k': \"delimiters \\\\vert \\\\rangle\",  // |x> Dirac ket\n\t'm': \"delimiters \\\\lmoustache \\\\rmoustache\",\n\t'n': \"delimiters \\\\lVert \\\\rVert\",  // n = Norm\n\t'N': \"delimiters \\\\lVert \\\\rVert\",  // alias for n\n\t'w': \"delimiters . \\\\vert\",  // \"where\"\n\t'W': \"delimiters . \\\\vert\",  // alias for w\n\t'|': \"delimiters \\\\vert \\\\vert\",\n\t'<': \"delimiters \\\\langle \\\\rangle\",\n\t'(': \"delimiters ( )\",\n\t'[': \"delimiters [ ]\",\n\t']': \"name doublebrackets;insert \\\\llbracket;swap;concat;insert \\\\rrbracket;concat\",\n\t'{': \"delimiters \\\\{ \\\\}\"\n    },\n\n    // right-curly-brace prefix: custom delimiter builder mode\n    custom_delimiters: {\n\t'1': \"custom_delimiter_arity 1\",\n\t'2': \"custom_delimiter_arity 2\",\n\t'3': \"custom_delimiter_arity 3\",\n\t'4': \"custom_delimiter_arity 4\",\n\t'5': \"custom_delimiter_arity 5\",\n\t'6': \"custom_delimiter_arity 6\",\n\t'7': \"custom_delimiter_arity 7\",\n\t'8': \"custom_delimiter_arity 8\",\n\t'9': \"custom_delimiter_arity 9\",\n\t'c': \"custom_delimiter \\\\lceil\",\n\t'C': \"custom_delimiter \\\\rceil\",\n\t'f': \"custom_delimiter \\\\lfloor\",\n\t'F': \"custom_delimiter \\\\rfloor\",\n\t'g': \"custom_delimiter \\\\lgroup\",\n\t'G': \"custom_delimiter \\\\rgroup\",\n\t'm': \"custom_delimiter \\\\lmoustache\",\n\t'M': \"custom_delimiter \\\\rmoustache\",\n\t'v': \"custom_delimiter \\\\Vert\",\n\t'<': \"custom_delimiter \\\\langle\",\n\t'>': \"custom_delimiter \\\\rangle\",\n\t'(': \"custom_delimiter (\",\n\t')': \"custom_delimiter )\",\n\t'[': \"custom_delimiter [\",\n\t']': \"custom_delimiter ]\",\n\t'{': \"custom_delimiter \\\\{\",\n\t'}': \"custom_delimiter \\\\}\",\n\t'.': \"custom_delimiter .\",\n\t'/': \"custom_delimiter /\",\n\t\"\\\\\": \"custom_delimiter \\\\backslash\",\n\t'|': \"custom_delimiter |\"\n    },\n\n    // forward-slash prefix: assorted functions/operators\n    operator: {\n\t'1': \"name reciprocal;insert 1;swap;operator frac 2\",\n\t'2': \"mode squared\",\n\t'a': \"apply_operator 1\",\n\t'A': \"apply_operator 2\",\n\t'b': \"operator binom 2\",\n\t'c': \"named_function cos\",\n\t'C': \"named_function csc\",\n\t'd': \"mode derivative\",\n\t'D': \"named_function det\",\n\t'e': \"name exp;insert e;operator mathrm;swap;superscript\",  // exp(x)\n\t'E': \"named_function exp\",\n\t'f': \"delimiters . . / 2\",  // NOTE: duplicates [,f]\n\t'g': \"named_function argmin\",\n\t'G': \"named_function argmax\",\n\t'h': \"mode hyperbolic\",\n\t'i': \"mode integral_limits\",\n\t'l': \"name lim;insert \\\\limits;swap;subscript;insert \\\\lim;swap;concat\",  // lim_{x}\n\t'm': \"named_function min\",\n\t'M': \"named_function max\",\n\t'n': \"named_function ln\",\n\t'N': \"named_function log\",\n\t'o': \"name apply_fn;parenthesize;swap;operator mathopen;swap;concat\",   // f x -> f(x)  \"of\"; \\mathopen closes up the spacing after 'f'\n\t'p': \"parenthesize;operator Pr\",  // Pr(x) (probability)\n\t'P': \"operator phase\",\n\t'q': \"operator sqrt\",\n\t'Q': \"operator sqrt[3]\",\n\t's': \"named_function sin\",\n\t'S': \"named_function sec\",\n\t't': \"named_function tan\",\n\t'T': \"named_function cot\",\n\t'u': \"name inf;insert \\\\limits;swap;subscript;insert \\\\inf;swap;concat\",\n\t'U': \"name sup;insert \\\\limits;swap;subscript;insert \\\\sup;swap;concat\",\n\t'v': \"name Var;parenthesize;insert Var;operator operatorname;swap;concat\",\n\t'V': \"name Cov;swap;insert ,;concat;swap;concat;parenthesize;insert Cov;operator operatorname;swap;concat\",\n\t';': \"apply_tag\",\n\t'/': \"operator frac 2\",\n\t\"\\\\\": \"operator tfrac 2\",\n\t'}': \"name underbrace;swap;operator underbrace;swap;subscript\",\n\t'{': \"name overbrace;swap;operator overbrace;swap;superscript\",\n\t'-': \"mode inverse\",\n\t\"'\": \"substitute_defer\",\n\t'Enter': \"name subsuperscript;unrot;subscript;swap;superscript\"  // apply superscript and subscript at once\n    },\n\n    // TODO: maybe make a more general way of doing these\n    hyperbolic: {\n\t's': \"named_function sinh\",\n\t'S': \"named_function sech\",\n\t'c': \"named_function cosh\",\n\t'C': \"named_function csch\",\n\t't': \"named_function tanh\",\n\t'T': \"named_function coth\"\n    },\n    inverse: {\n\t's': \"named_function sin -1\",\n\t'S': \"named_function sec -1\",\n\t'c': \"named_function cos -1\",\n\t'C': \"named_function csc -1\",\n\t't': \"named_function tan -1\",\n\t'T': \"named_function cot -1\",\n\t'h': \"mode inverse_hyperbolic\"\n    },\n    inverse_hyperbolic: {\n\t's': \"named_function sinh -1\",\n\t'S': \"named_function sech -1\",\n\t'c': \"named_function cosh -1\",\n\t'C': \"named_function csch -1\",\n\t't': \"named_function tanh -1\",\n\t'T': \"named_function coth -1\"\n    },\n    squared: {\n\t's': \"named_function sin 2\",\n\t'S': \"named_function sec 2\",\n\t'c': \"named_function cos 2\",\n\t'C': \"named_function csc 2\",\n\t't': \"named_function tan 2\",\n\t'T': \"named_function cot 2\",\n\t'h': \"mode squared_hyperbolic\"\n    },\n    squared_hyperbolic: {\n\t's': \"named_function sinh 2\",\n\t'S': \"named_function sech 2\",\n\t'c': \"named_function cosh 2\",\n\t'C': \"named_function csch 2\",\n\t't': \"named_function tanh 2\",\n\t'T': \"named_function coth 2\"\n    },\n\n    // /i prefix\n    integral_limits: {\n\t'r': \"name limits_real;insert -\\\\infty;subscript;insert \\\\infty;superscript\",  // -oo .. oo : [r]eals\n\t'n': \"name limits_negative;insert -\\\\infty;subscript;insert 0;superscript\",  // -oo .. o : [n]egative \n\t'p': \"name limits_positive;insert 0;subscript;insert \\\\infty;superscript\",  // 0..oo : [p]ositive\n\t'u': \"name limits_unit;insert 0;subscript;insert 1;superscript\",  // 0..1 : [u]nit\n\t't': \"name limits_trig;insert 0;subscript;insert 2\\\\pi;superscript\",  // 0..2pi : [t]rigonometric\n\t'T': \"name limits_sym_trig;insert -\\\\pi;subscript;insert \\\\pi;superscript\"  // -pi..pi : symmetric [T]rigonometric\n    },\n\n    // /d prefix: derivative operations\n    derivative: {\n\t// \\partial y / \\partial x\n\t'j': \"name partial_yx;insert \\\\partial;swap;concat;swap;insert \\\\partial;swap;concat;swap;operator frac 2\",\n\t// \\partial^2 y / \\partial x^2\n\t'J': \"name partial2_yx;insert 2;superscript;insert \\\\partial;swap;concat;swap;insert \\\\partial;insert 2;superscript;swap;concat;swap;operator frac 2\",\n\t// dy/dx\n\t'k': \"name dy_dx;insert d;swap;concat;swap;insert d;swap;concat;swap;operator frac 2\",\n\t// d^2(y) / dx^2\n\t'K': \"name d2_y_dx2;insert 2;superscript;insert d;swap;concat;swap;insert d;insert 2;superscript;swap;concat;swap;operator frac 2\",\n\t// \\partial / \\partial x\n\t'q': \"name partial_x;insert \\\\partial;swap;concat;insert \\\\partial;swap;operator frac 2\",\n\t// \\partial^2 / \\partial x^2\n\t'Q': \"name partial2_x2;insert 2;superscript;insert \\\\partial;swap;concat;insert \\\\partial;insert 2;superscript;swap;operator frac 2\",\n\t// d/dx\n\t'x': \"name d_dx;insert d;swap;concat;insert d;swap;operator frac 2\",\n\t// d^2 / dx^2\n\t'X': \"name d2_dx2;insert 2;superscript;insert d;swap;concat;insert d;insert 2;superscript;swap;operator frac 2\",\n\t// \\partial^2 / \\partial x\\,\\partial y\n\t'm': \"name partial2_x_y;insert \\\\partial;swap;concat;insert \\\\partial;rot;concat;swap;insert \\\\,;swap;concat;concat;insert \\\\partial;insert 2;superscript;swap;operator frac 2\",\n\t// \\partial^2 z / \\partial x\\,\\partial y\n\t'M': \"name partial2_z_x_y;insert \\\\partial;swap;concat;insert \\\\partial;rot;concat;swap;insert \\\\,;swap;concat;concat;swap;insert \\\\partial;insert 2;superscript;swap;concat;swap;operator frac 2\",\n\t// gradient\n\t'g': \"name gradient;insert \\\\nabla;swap;concat\",\n\t// divergence\n\t'd': \"name divergence;insert \\\\nabla;insert \\\\cdot;concat;swap;concat\",\n\t// curl\n\t'c': \"name curl;insert \\\\nabla;insert \\\\times;concat;swap;concat\",\n\t// Laplacian\n\t'l': \"name laplacian;insert \\\\nabla;insert 2;superscript;swap;concat\"\n    },\n\n    // comma prefix: combine two objects with an infix operation\n    infix: {\n\t'a': \"apply_infix\",\n\t'b': \"infix \\\\bullet\",\n\t'c': \"infix \\\\cap\",\n\t'd': \"infix \\\\setminus\",  // (set [d]ifference)\n\t'g': \"infix \\\\gets\",\n\t'k': \"insert \\\\,;swap;concat;swap;insert \\\\,;concat;swap;delimiters . . \\\\vert 2\",  // x | y  ([k]onditional)\n\t'l': \"infix \\\\parallel\",\n\t'm': \"infix \\\\mapsto\",\n\t'M': \"infix \\\\mp\",\n\t'o': \"infix \\\\circ\",\n\t'O': \"stackrel overset\",\n\t'p': \"infix \\\\perp\",\n\t'P': \"infix \\\\pm\",\n\t's': \"infix \\\\,\",\n\t't': \"infix \\\\to\",\n\t'u': \"infix \\\\cup\",\n\t'U': \"stackrel underset\",\n\t'v': \"infix \\\\vee\",\n\t'w': \"infix \\\\wedge\",\n\t'x': \"infix \\\\times\",\n\t'X': \"infix \\\\otimes\",\n\t'[': \"infix \\\\llcorner\",  // right-contraction\n\t']': \"infix \\\\lrcorner\",  // left-contraction\n\t'|': \"delimiters . . \\\\vert 2\",  // \"infix |\",\n\t'=': \"infix \\\\Rightarrow\",\n\t'-': \"infix \\\\ominus\",\n\t'+': \"infix \\\\oplus\",\n\t'.': \"infix \\\\cdot\",\n\t',': \"infix ,\",  // comma without thinspace\n\t' ': \"infix ,\\\\,\",  // comma plus thinspace\n\t':': \"infix :\",\n\t';': \"infix semicolon\\\\:\",\n\t'%': \"infix \\\\pmod\",  // y (mod x)\n\t'*': \"infix *\",\n\t\"\\\\\": \"delimiters . . / 2\",\n\t'/': \"infix /\"\n    },\n\n    // = prefix: relational operators\n    relational: {\n\t'a': \"infix \\\\approx\",\n\t'c': \"infix \\\\cong\",  // =~  congruent\n\t'e': \"infix \\\\equiv\",\n\t'E': \"infix \\\\iff\",\n\t'g': \"infix >\",\n\t'G': \"infix \\\\gg\",\n\t'i': \"infix \\\\in\",\n\t'I': \"infix \\\\notin\",\n\t'l': \"infix <\",\n\t'L': \"infix \\\\ll\",\n\t'n': \"infix \\\\ne\",\n\t'p': \"infix \\\\propto\",\n\t'q': \"infix =\",\n\t's': \"infix \\\\subseteq\",\n\t'S': \"infix \\\\subset\",\n\t'=': \"infix =\",\n\t'<': \"infix <\",\n\t'>': \"infix >\",\n\t'[': \"infix \\\\le\",\n\t']': \"infix \\\\ge\",\n\t':': \"infix \\\\coloneqq\",\n\t'~': \"infix \\\\sim\",\n\t'|': \"infix \\\\vDash\"\n    },\n\n    // apostrophe prefix: assorted standalone math symbols\n    symbol: {\n\t'0': \"insert \\\\varnothing\",\n\t'1': \"insert -1\",\n\t'2': \"name half_display;insert 1;insert 2;operator frac 2\",  // 1/2 (display)\n\t'3': \"name half_inline;insert 1;insert 2;infix /\",  // 1/2 (inline)\n\t'8': \"insert \\\\infty\",\n\t'a': \"insert \\\\forall\",\n\t'c': \"insert \\\\cdot\",\n\t'C': \"insert \\\\bigcap\",\n\t'd': \"insert \\\\partial\",\n\t'e': \"insert \\\\exists\",\n\t'h': \"insert \\\\hslash\",\n\t'i': \"insert \\\\int\",\n\t'I': \"insert \\\\iint\",\n\t'l': \"insert \\\\ell\",\n\t'M': \"insert \\\\mp\",\n\t'o': \"insert \\\\circ\",\n\t'p': \"insert \\\\prod\",\n\t'P': \"insert \\\\pm\",\n\t'q': \"insert ?\",\n\t's': \"insert \\\\sum\",\n\t't': \"insert \\\\intercal\",\n\t'T': \"insert \\\\triangle\",\n\t'U': \"insert \\\\bigcup\",\n\t'v': \"insert \\\\vee\",\n\t'w': \"insert \\\\wedge\",\n\t'y': \"insert \\\\oint\",\n\t'Y': \"insert \\\\oiint\",\n\t'.': \"insert \\\\dots\",\n\t'>': \"insert \\\\cdots\",\n\t'-': \"insert -\",\n\t'+': \"insert +\",\n\t'*': \"insert \\\\star\",\n\t'|': \"insert |\",\n\t'=': \"insert_markdown ---\",\n\t'?': \"insert ?\",\n\t'!': \"insert !\",\n\t',': \"insert ,\",\n\t';': \"insert semicolon\",\n\t':': \"insert :\",\n\t'`': \"insert `\",\n\t\"'\": \"insert_defer\",\n\t' ': \"insert \",  // \"nothing\", e.g. when you don't want something on one side of an infix\n\t'ArrowUp': \"insert \\\\uparrow\",\n\t'ArrowDown': \"insert \\\\downarrow\"\n    },\n\n    // . prefix: expression decorators (fonts, hats, etc)\n    decoration: {\n\t'1': \"insert -1;superscript\",  // raise to -1 power\n\t'a': \"operator overrightarrow\",  // TODO: [R] maybe instead\n\t'b': \"operator mathbb\",\n\t'c': \"mode color\",\n\t'd': \"insert \\\\dagger;superscript\",\n\t'D': \"insert \\\\ddagger;superscript\",\n\t'e': \"operator bold\",  // bold roman (sort of)\n\t'f': \"prefix \\\\therefore\",\n\t'F': \"prefix \\\\because\",\n\t'g': \"operator mathring\",\n\t'h': \"apply_hat hat\",\n\t'H': \"apply_hat widehat\",\n\t'k': \"operator mathfrak\",\n\t'l': \"insert \\\\parallel;subscript\",\n\t'm': \"operator mathtt\",\n\t'M': \"prefix \\\\mp\",\n\t'o': \"operator bar\",\n\t'O': \"operator overline\",\n\t'p': \"insert \\\\perp;subscript\",\n\t'P': \"prefix \\\\pm\",\n\t'r': \"operator mathrm\",\n\t's': \"operator mathsf\",  // sans-serif\n\t't': \"prefix \\\\to\",\n\t'T': \"operator widetilde\",\n\t'u': \"apply_hat breve\",\n\t'U': \"operator utilde\",\n\t'v': \"operator vec\",\n\t'V': \"apply_hat check\",\n\t'W': \"apply_hat widecheck\",\n\t'x': \"operator boxed\",\n\t'X': \"operator sout\",  // strikeout\n\t'.': \"operator dot\",\n\t\"\\\"\": \"operator ddot\",\n\t' ': \"insert \\\\,;concat\",  // append thin space\n\t\"'\": \"autoparenthesize;prime\",\n\t'*': \"insert *;superscript\",\n\t'~': \"apply_hat tilde\",\n\t'=': \"prefix \\\\Rightarrow\",\n\t'-': \"prefix -\",\n\t'+': \"prefix +\",\n\t'`': \"operator grave\",\n\t'/': \"operator cancel\",\n\t\"\\\\\": \"operator bcancel\",\n\t'_': \"operator underline\"\n    },\n\n    // .c prefix: set colors\n    color: {\n\t'b': \"color blue\",\n\t'g': \"color green\",\n\t'h': \"color #888\",  // grey: [h]alf black\n\t'k': \"color black\",\n\t'o': \"color orange\",\n\t'p': \"color purple\",\n\t'r': \"color red\",\n\t'y': \"color #ff0\"\n    },\n\n    // | prefix: array/matrix operations\n    array: {\n\t'a': \"build_align aligned\",\n\t'c': \"build_align cases\",\n\t'C': \"build_align rcases\",\n\t'd': \"dissolve_matrix\",\n\t'e': \"name ellipsis_list;build_list ,\\\\,;insert ,\\\\,\\\\dots;concat\",\n\t'E': \"insert_matrix_ellipses\",\n\t'g': \"build_align gathered\",\n\t'k': \"build_substack\",\n\t'm': \"build_matrix_row matrix\",\n\t'p': \"name plus_list;build_list +;insert +\\\\cdots;concat\",\n\t's': \"split_matrix\",\n\t'T': \"matrix_transpose\",\n\t'v': \"build_matrix_row vmatrix\",\n\t'V': \"build_matrix_row Vmatrix\",\n\t'|': \"stack_matrices\",\n\t',': \"build_list ,\",\n\t' ': \"build_list ,\\\\,\",\n\t'.': \"name ellipsis_list_2;build_list ,\\\\, ,\\\\,\\\\dots,\\\\,\",\n\t';': \"build_list semicolon\\\\,\",\n\t'+': \"name plus_list_2;insert +;swap;build_infix_list \\\\cdots \",\n\t'Enter': \"stack_matrices\",\n\t'(': \"build_matrix_row pmatrix\",\n\t'[': \"build_matrix_row bmatrix\",\n\t'{': \"build_matrix_row Bmatrix\"\n    },\n\n    editor: {\n\t'Tab': \"finish_editing\",\n\t'Shift+Enter': \"finish_editing\",\n\t// TODO: use ArrowUp for the following when in layouts where stack is on bottom\n\t'Shift+ArrowDown': \"import_item_into_editor\",\n\t'Escape': \"cancel_editing\",\n    },\n\n    script: {\n\t'[alpha]': \"name mathscr_letter;self_insert;to_case uppercase;operator mathscr\",\n\t'&': \"insert \\\\&\"\n    },\n\n    calligraphic: {\n\t'[alpha]': \"name mathcal_letter;self_insert;to_case uppercase;operator mathcal\",\n\t'%': \"insert \\\\%\"\n    },\n\n    // ; prefix: lowercase Greek letters\n    lowercase_greek: {\n\t'a': \"insert \\\\alpha\",     'b': \"insert \\\\beta\",\n\t'c': \"insert \\\\chi\",       'd': \"insert \\\\delta\",\n\t'e': \"insert \\\\epsilon\",   'f': \"insert \\\\phi\",\n\t'g': \"insert \\\\gamma\",     'h': \"insert \\\\eta\",\n\t'i': \"insert \\\\iota\",      'j': \"insert \\\\varphi\",\n\t'k': \"insert \\\\kappa\",     'l': \"insert \\\\lambda\",\n\t'm': \"insert \\\\mu\",        'n': \"insert \\\\nu\",\n\t'o': \"insert \\\\omega\",     'p': \"insert \\\\pi\",\n\t'q': \"insert \\\\vartheta\",  'r': \"insert \\\\rho\",\n\t's': \"insert \\\\sigma\",     't': \"insert \\\\tau\",\n\t'u': \"insert \\\\upsilon\",   'v': \"insert \\\\theta\",\n\t'w': \"insert \\\\omega\",     'x': \"insert \\\\xi\",\n\t'y': \"insert \\\\psi\",       'z': \"insert \\\\zeta\",\n\n\t';': \"infix semicolon\"\n    },\n    // : prefix: uppercase Greek letters\n    uppercase_greek: {\n\t'd': \"insert \\\\Delta\",     'e': \"insert \\\\varepsilon\",\n\t'f': \"insert \\\\Phi\",       'g': \"insert \\\\Gamma\",\n\t'l': \"insert \\\\Lambda\",    'm': \"insert \\\\varpi\",\n\t'o': \"insert \\\\Omega\",     'p': \"insert \\\\Pi\",\n\t'q': \"insert \\\\vartheta\",  'r': \"insert \\\\varrho\",\n\t's': \"insert \\\\Sigma\",     't': \"insert \\\\varsigma\",\n\t'u': \"insert \\\\Upsilon\",   'v': \"insert \\\\Theta\",\n\t'w': \"insert \\\\Omega\",     'x': \"insert \\\\Xi\",\n\t'y': \"insert \\\\Psi\",\n\t'n': \"insert \\\\nabla\",  // special case\n\n\t// TODO: case-insensitive keybindings\n\t'D': \"insert \\\\Delta\",     'E': \"insert \\\\varepsilon\",\n\t'F': \"insert \\\\Phi\",       'G': \"insert \\\\Gamma\",\n\t'L': \"insert \\\\Lambda\",    'M': \"insert \\\\varpi\",\n\t'O': \"insert \\\\Omega\",     'P': \"insert \\\\Pi\",\n\t'Q': \"insert \\\\vartheta\",  'R': \"insert \\\\varrho\",\n\t'S': \"insert \\\\Sigma\",     'T': \"insert \\\\varsigma\",\n\t'U': \"insert \\\\Upsilon\",   'V': \"insert \\\\Theta\",\n\t'W': \"insert \\\\Omega\",     'X': \"insert \\\\Xi\",\n\t'Y': \"insert \\\\Psi\",\n\t'N': \"insert \\\\nabla\",\n\n\t':': \"infix :\"\n    }\n};\n\n\nexport default EditorKeymap;\n","\n\nimport KeybindingTable from './Keymap';\nimport marked from 'marked';\nimport JSZip from 'jszip';\n\n\nclass Keymap {\n    constructor() {\n        this.bindings = KeybindingTable;\n    }\n    \n    lookup_binding(mode, key) {\n        const mode_map = this.bindings[mode];\n        if(!mode_map) return null;\n        if(mode_map[key]) return mode_map[key];\n        if(mode_map['[alpha]'] && /^[a-zA-Z]$/.test(key)) return mode_map['[alpha]'];\n        if(mode_map['[digit]'] && /^[0-9]$/.test(key)) return mode_map['[digit]'];\n        if(mode_map['[alnum]'] && /^[a-zA-Z0-9]$/.test(key)) return mode_map['[alnum]'];\n        if(mode_map['default']) return mode_map['default'];\n\tif(mode === 'base' || mode === 'editor')\n\t    return null;\n\telse\n\t    return 'cancel';\n    }\n}\n\n\nclass Settings {\n    static load_from_local_storage() {\n        const serialized_string = localStorage.getItem('settings');\n        if(serialized_string)\n            return Settings.from_json(JSON.parse(serialized_string));\n        else\n            return new Settings();\n    }\n    \n    static from_json(json) {\n        let s = new Settings();\n        Settings.saved_keys.forEach(key => { s[key] = json[key]; });\n        return s;\n    }\n    \n    constructor() {\n        this.current_keymap = new Keymap();\n        this.selected_theme = 'default';\n        this.last_opened_filename = null;\n\tthis.popup_mode = null;  // null, 'help', 'files', 'keymap'\n\tthis.layout = this.default_layout();\n    }\n\n    default_layout() {\n\treturn {\n\t    zoom_factor: 0,\n\t    stack_rightalign_math: false,\n\t    document_rightalign_math: false,\n\t    stack_side: 'left',\n\t    stack_split: 50\n\t};\n    }\n\n    apply_layout_to_dom(stack_panel_elt, document_panel_elt, popup_panel_elt) {\n\tconst layout = this.layout;\n\n\t// Show or hide popup panel.\n\tpopup_panel_elt.style.display = this.popup_mode ? 'block' : 'none';\n\n\t// Set overall scale factor.\n\tconst root_elt = document.getElementById('root');\n\tconst percentage = Math.round(100*Math.pow(1.05, layout.zoom_factor || 0));\n\troot_elt.style.fontSize = percentage + '%';\n\n\t// Set up panel layout.\n\tlet [stack_bounds, document_bounds] = this._split_rectangle(\n\t    {x: 0, y: 0, w: 100, h: 100}, layout.stack_side, layout.stack_split);\n\n\tthis._apply_bounds(stack_panel_elt, stack_bounds);\n\tthis._apply_bounds(document_panel_elt, document_bounds);\n    }\n\n    // Split a parent bounding rectangle into \"primary\" and \"secondary\"\n    // subrectangles according to the given 'side' and split %.\n    _split_rectangle(bounds, side, split_percent) {\n\tconst w1 = Math.round(split_percent*bounds.w/100);\n\tconst w2 = bounds.w - w1;\n\tconst h1 = Math.round(split_percent*bounds.h/100);\n\tconst h2 = bounds.h - h1;\n\tswitch(side) {\n\tcase 'left':\n\t    return [\n\t\t{x: bounds.x, y: bounds.y, w: w1, h: bounds.h},\n\t\t{x: bounds.x+w1, y: bounds.y, w: w2, h: bounds.h}\n\t    ];\n\tcase 'right':\n\t    return [\n\t\t{x: bounds.x+w2, y: bounds.y, w: w1, h: bounds.h},\n\t\t{x: bounds.x, y: bounds.y, w: w2, h: bounds.h}\n\t    ];\n\tcase 'top':\n\t    return [\n\t\t{x: bounds.x, y: bounds.y, w: bounds.w, h: h1},\n\t\t{x: bounds.x, y: bounds.y+h1, w: bounds.w, h: h2}\n\t    ];\n\tcase 'bottom':\n\t    return [\n\t\t{x: bounds.x, y: bounds.y+h2, w: bounds.w, h: h1},\n\t\t{x: bounds.x, y: bounds.y, w: bounds.w, h: h2}\n\t    ];\n\tdefault:\n\t    return [bounds, bounds];\n\t}\n    }\n\n    _apply_bounds(elt, bounds) {\n\telt.style.left = bounds.x + '%';\n\telt.style.top = bounds.y + '%';\n\telt.style.width = bounds.w + '%';\n\telt.style.height = bounds.h + '%';\n    }\n\n    save() {\n        const serialized_string = JSON.stringify(this.to_json());\n        localStorage.setItem('settings', serialized_string);\n    }\n\n    to_json() {\n        let json = {};\n        Settings.saved_keys.forEach(key => { json[key] = this[key]; });\n        return json;\n    }\n}\n\nSettings.saved_keys = [\n    'selected_theme', 'last_opened_filename', 'popup_mode', 'layout'\n];\n\n\n// Helper for generating LaTeX strings from Expr objects.\nclass LatexEmitter {\n    constructor() {\n\tthis.tokens = [];\n\tthis.last_token_type = null;\n    }\n\n    emit_token(text, token_type) {\n\tif(text.length > 0) {\n\t    this.tokens.push(text);\n\t    this.last_token_type = token_type;\n\t}\n    }\n\n    expr(expr) { expr.emit_latex(this); }\n\n    grouped_expr(expr, force_braces) { this.grouped((() => this.expr(expr)), force_braces); }\n\n    grouped(fn, force_braces) {\n\tlet [old_tokens, old_last_token_type] = [this.tokens, this.last_token_type];\n\t[this.tokens, this.last_token_type] = [[], null];\n\n\tfn();\n\n\tconst [tokens, last_token_type] = [this.tokens, this.last_token_type];\n\tthis.tokens = old_tokens;\n\tthis.last_token_type = old_last_token_type;\n\n\t// The only real 'special' case is a group with exactly 1 token.\n\t// In that case we may be able to omit the surrounding braces if\n\t// it's a 1-character string or a single \\latexcommand.  In all other\n\t// cases the braces need to be included.\n\tif(force_braces === 'force' || tokens.length === 0 || tokens.length > 1) {\n\t    this.text('{');\n\t    this.text(tokens.join(''));\n\t    this.text('}');\n\t}\n\telse {  // tokens.length === 1 && !force_braces\n\t    if(last_token_type === 'text') {\n\t\tif(tokens[0].length === 1)\n\t\t    this.text(tokens[0]);\n\t\telse {\n\t\t    this.text('{');\n\t\t    this.text(tokens[0]);\n\t\t    this.text('}');\n\t\t}\n\t    }\n\t    else if(force_braces === 'force_commands') {\n\t\tthis.text('{');\n\t\tthis.emit_token(tokens[0], 'command');\n\t\tthis.text('}');\n\t    }\n\t    else\n\t\tthis.emit_token(tokens[0], 'command');\n\t}\n    }\n\n    // Emit 'raw' LaTeX code.\n    text(text) {\n\tif(this.last_token_type === 'command') {\n\t    // Determine if a space is needed after the last command; this depends\n\t    // on whether two non-special characters are adjacent.\n\t    const last_token = this.tokens[this.tokens.length-1];\n\t    if(this._is_latex_identifier_char(last_token.charAt(last_token.length-1)) &&\n\t       (this._is_latex_identifier_char(text.charAt(0)) /*|| text.charAt(0) === '{'*/))\n\t\tthis.emit_token(' ', 'text');\n\t}\n\tthis.emit_token(text, 'text');\n    }\n\n    _is_latex_identifier_char(ch) {\n\treturn /^[a-zA-Z]$/.test(ch);\n    }\n\n    // \\latexcommand (something that isn't a single special-character command like \\,)\n    command(command_name, command_options) {\n\tif(command_options)\n\t    command_name = command_name + '[' + command_options + ']';\n\tthis.emit_token(\"\\\\\" + command_name, 'command');\n    }\n\n    // Treated like text or a command depending on whether it starts with a backslash.\n    text_or_command(text) {\n\tif(text.startsWith(\"\\\\\"))\n\t    this.command(text.slice(1));\n\telse\n\t    this.text(text);\n    }\n\n    begin_environment(envname) { this.text(\"\\\\begin{\" + envname + \"}\\n\"); }\n\n    end_environment(envname) { this.text(\"\\n\\\\end{\" + envname + \"}\\n\"); }\n\n    align_separator() { this.text(' & '); }\n\n    // Table row separators for e.g. \\begin{matrix}\n    row_separator() {\n\t// Give a little more space between rows, for fractions.\n\t// See KaTeX \"common issues\" page.\n\tthis.text(\"\\\\\\\\[0.1em]\\n\");\n\t//this.text(\"\\\\\\\\\\n\");\n    }\n\n    finished_string() { return this.tokens.join(''); }\n}\n\n\n// Overall app state, holding the stack and document.\nclass AppState {\n    static from_json(json) {\n        return new AppState(\n            Stack.from_json(json.stack),\n            Document.from_json(json.document)\n        );\n    }\n    \n    constructor(stack, document) {\n        this.stack = stack || this._default_stack();\n        this.document = document || new Document([], 0);\n\tthis.is_dirty = false;\n    }\n\n    _default_stack() {\n\tconst item = new MarkdownItem('Welcome to the editor.  Press [**?**] to toggle help.');\n\treturn new Stack([item]);\n    }\n\n    same_as(app_state) {\n        // NOTE: AppState stuff is never modified in-place, so all that needs to be\n        // done here is check object identities.\n        return this.stack === app_state.stack && this.document === app_state.document;\n    }\n\n    to_json() {\n        return {\n            stack: this.stack.to_json(),\n            document: this.document.to_json(),\n\t    format: 1\n        };\n    }\n}\n\n\nclass UndoStack {\n    constructor() {\n        // Stack of saved AppState instances (most recent one at the end).\n        this.state_stack = [];\n\n        // Maximum size of this.state_stack\n        this.max_stack_depth = 100;\n        \n        // Number of consecutive undo operations that have been performed so far.\n        // If this is greater that zero, 'redo' operations can revert the undos.\n        this.undo_count = 0;\n    }\n\n    clear(initial_app_state) {\n        this.state_stack = [initial_app_state];\n        this.undo_count = 0;\n    }\n\n    push_state(state) {\n        // Only save state if it differs from the state we'd be undoing to.\n        if(this.state_stack.length > this.undo_count &&\n           this.state_stack[this.state_stack.length - this.undo_count - 1].same_as(state))\n            return null;\n\n        if(this.undo_count > 0) {\n            // Truncate already-undone saved states.  This means that 'redo' will no longer work\n            // until some more undos are performed.\n            this.state_stack = this.state_stack.slice(0, this.state_stack.length - this.undo_count);\n            this.undo_count = 0;\n        }\n\n        this.state_stack.push(state);\n\n        // Prevent the undo list from growing indefinitely.\n        if(this.state_stack.length > this.max_stack_depth)\n            this.state_stack = this.state_stack.slice(this.state_stack.length - this.max_stack_depth);\n\n        return state;\n    }\n\n    undo_state() {\n        if(this.state_stack.length-1 > this.undo_count) {\n            this.undo_count++;\n            return this.state_stack[this.state_stack.length - this.undo_count - 1];\n        }\n        else return null;\n    }\n\n    redo_state() {\n        if(this.undo_count > 0) {\n            this.undo_count--;\n            return this.state_stack[this.state_stack.length - this.undo_count - 1];\n        }\n        else return null;\n    }\n}\n\n\nclass DocumentStorage {\n    constructor() {\n\tthis.open_request = null;\n\tthis.database = null;\n    }\n\n    open_database(onsuccess) {\n\tif(!indexedDB) return;\n\tthis.on_open_success = onsuccess;\n\tthis.open_request = indexedDB.open('rpnlatex', 1);\n\tthis.open_request.onupgradeneeded = this.handle_upgrade_database.bind(this);\n\tthis.open_request.onsuccess = this.handle_open_success.bind(this);\n\tthis.open_request.onerror = this.handle_open_error.bind(this);\n    }\n\n    handle_upgrade_database(event) {\n\tthis.database = this.open_request.result;\n\tswitch(event.oldVersion) {\n\tcase 0: this.build_initial_schema(); break;\n\tdefault: break;\n\t}\n    }\n\n    build_initial_schema() {\n\tthis.database.createObjectStore('documents', {keyPath: 'filename'});\n\tthis.database.createObjectStore('documents_metadata', {keyPath: 'filename'});\n    }\n\n    handle_open_error(event) {\n\t//alert(\"Unable to open IndexedDB for document storage.  You will be unable to save or load documents.\\nThis may happen in Private Browsing mode on some browsers.\\nError message: \" + this.open_request.error);\n\tthis.open_request = null;\n    }\n\n    handle_open_success(event) {\n\tthis.database = this.open_request.result;\n\tthis.open_request = null;\n\tthis.database.onversionchange = function () {\n\t    this.database.close();\n\t    this.database = null;\n\t    alert('Warning: database is outdated, please reload the page.');\n\t};\n\tif(this.on_open_success) this.on_open_success();\n    }\n\n    create_transaction(readwrite) {\n\treturn this.database.transaction(\n\t    ['documents', 'documents_metadata'],\n\t    readwrite ? 'readwrite' : 'readonly');\n    }\n\n    sanitize_filename(filename) {\n        const fn = filename.replaceAll(/[^a-zA-Z0-9_ ]/g, '').trim();\n        return (fn.length === 0 || fn.length > 200) ? null : fn;\n    }\n\n    load_state(filename, onsuccess, onerror) {\n\tif(!this.database) return onerror();\n\tlet transaction = this.create_transaction(false);\n\tlet document_store = transaction.objectStore('documents');\n\tlet request = document_store.get(filename);\n\trequest.onsuccess = () => {\n\t    // NOTE: request.result will be undefined if the filename key wasn't\n\t    // found.  This still counts as a 'success'.\n\t    const json = request.result;\n\t    if(json) {\n\t\tconst app_state = AppState.from_json(request.result);\n\t\tonsuccess(filename, app_state);\n\t    }\n\t    else\n\t\tonerror(filename, '???');  // TODO\n\t};\n\trequest.onerror = () => {\n\t    onerror(filename, '???');  // TODO\n\t};\n    }\n\n    save_state(app_state, filename, onsuccess, onerror) {\n\tif(!this.database) return onerror();\n        let serialized_json = app_state.to_json();\n\tserialized_json.filename = filename;\n\n\t// Estimate the file size by serializing JSON.\n\t// IndexedDB also does this serialization itself, but there doesn't\n\t// seem to be any way to reuse that result directly.\n\tconst filesize = JSON.stringify(serialized_json).length;\n\n\tconst metadata_json = {\n\t    filename: filename,\n\t    filesize: filesize,\n\t    description: '',  // TODO\n\t    stack_item_count: app_state.stack.depth(),\n\t    document_item_count: app_state.document.items.length,\n\t    timestamp: new Date()\n\t};\n\t\n\tlet transaction = this.create_transaction(true);\n\ttransaction.objectStore('documents').put(serialized_json);\n\ttransaction.objectStore('documents_metadata').put(metadata_json);\n\tif(onsuccess) transaction.oncomplete = onsuccess;\n\tif(onerror) transaction.onabort = onerror;\n    }\n\n    delete_state(filename, onsuccess, onerror) {\n\tif(!this.database) return onerror();\n\tlet transaction = this.create_transaction(true);\n\ttransaction.objectStore('documents').delete(filename);\n\ttransaction.objectStore('documents_metadata').delete(filename);\n\tif(onsuccess) transaction.oncomplete = onsuccess;\n\tif(onerror) transaction.onabort = onerror;\n    }\n\n    fetch_file_list(onsuccess, onerror) {\n\tif(!this.database) return onerror();\n\tlet transaction = this.create_transaction(false);\n\tlet request = transaction.objectStore('documents_metadata').getAll();\n\trequest.onsuccess = () => {\n\t    request.result.forEach(row => {\n\t\t// Parse the timestamp\n\t\tconst ts_value = Date.parse(row.timestamp);\n\t\trow.timestamp = ts_value ? new Date(ts_value) : null;\n\t    });\n\t    onsuccess(request.result);\n\t};\n\trequest.onerror = onerror;\n    }\n\n    // Fetch all documents using a cursor.  'onrowfetched' is invoked once per document\n    // and then 'onfinished' is invoked at the end.\n    fetch_all_documents(onrowfetched, onfinished, onerror) {\n\tif(!this.database) return onerror();\n\tlet transaction = this.create_transaction(false);\n\tlet cursor = transaction.objectStore('documents').openCursor();\n\tcursor.onsuccess = (event) => {\n\t    const c = event.target.result;\n\t    if(c) {\n\t\tonrowfetched(c.value);\n\t\tc.continue();\n\t    }\n\t    else\n\t\tonfinished();\n\t};\n\tcursor.onerror = onerror;\n    }\n}\n\n\n// Manage state of importing/exporting zip archives.\nclass ImportExportState {\n    constructor() {\n\t// States:\n\t//   'idle' - if this.download_url is populated, an export download is ready\n\t//   'error' - export failed, this.error_message is populated\n\t//   'loading' - in the process of loading from the database cursor\n\t//   'zipping' - creation of zip file in progress\n\t//   'uploading' - user is uploading an archive zipfile\n\t//   'importing' - uploaded zipfile is being processed/imported\n\tthis.state = 'idle';\n\n\tthis.document_storage = null;  // will be initialized by AppState\n\n\t// Number of imported documents handled so far.\n\tthis.import_count = 0;\n\n\t// Number of failures noted this import (if >0, this.error_message will also be set).\n\tthis.failed_count = 0;\n\tthis.error_message = null;\n\n\t// Holds the last-generated blob download URL, if any.\n\tthis.download_url = null;\n\n\t// This will be set on a successful import.\n\tthis.import_result_string = null;\n\n\t// This will be set to true if the main file list (FileManagerState) needs to be refreshed from the DB.\n\tthis.file_list_needs_update = false;\n\n\t// This can be set to a function to monitor state changes.\n\tthis.onstatechange = null;\n    }\n\n    // TODO: -> state_description()\n    textual_state() {\n\tswitch(this.state) {\n\tcase 'idle': return this.download_url ? 'Download Ready' : 'Ready for import or export';\n\tcase 'error': return 'Error: ' + this.error_message;\n\tcase 'loading': return 'Extacting database...';\n\tcase 'zipping': return 'Compressing files...';\n\tcase 'uploading': return 'Uploading data...';\n\tcase 'importing': return 'Importing documents: ' + this.import_count + ' so far';\n\tdefault: return '???';\n\t}\n    }\n\n    download_available() {\n\treturn this.state === 'idle' && this.download_url;\n    }\n\n    generate_download_filename() {\n\tconst date = new Date();\n\treturn [\n\t    'rpnlatex_', date.getFullYear().toString(), '_',\n\t    date.toLocaleString('default', {month: 'short'}).toLowerCase(),\n\t    '_', date.getDate().toString().padStart(2, '0'), '.zip'\n\t].join('');\n    }\n\n    change_state(new_state) {\n\tthis.state = new_state;\n\tif(this.onstatechange)\n\t    this.onstatechange(this);\n    }\n    \n    start_exporting() {\n\tlet document_storage = this.document_storage;\n\tthis.zip = new JSZip();\n\tdocument_storage.fetch_all_documents(\n\t    (row) => this.add_document_json_to_zip(row),\n\t    () => this.start_compressing(),\n\t    () => {\n\t\tthis.error_message = 'Unable to export the document database.';\n\t\tthis.change_state('error');\n\t    });\n\tthis.change_state('loading');\n    }\n\n    add_document_json_to_zip(json) {\n\tthis.zip.file(json.filename + '.json', JSON.stringify(json));\n    }\n\n    start_compressing() {\n\tthis.change_state('zipping');\n\tthis.zip.generateAsync({type: 'blob'}).then(content_blob => {\n\t    this.finished_compressing(content_blob);\n\t});\n    }\n\n    clear_download_url() {\n\tif(this.download_url) {\n\t    URL.revokeObjectURL(this.download_url);\n\t    this.download_url = null;\n\t}\n    }\n\n    finished_compressing(content_blob) {\n\tthis.clear_download_url();\n\tthis.download_url = URL.createObjectURL(content_blob);\n\tthis.zip = null;\n\tthis.change_state('idle');\n    }\n\n    // zipfile is a File object from a <input type=\"file\"> element.\n    start_importing(zipfile) {\n\tthis.clear_download_url();\n\tthis.import_result_string = null;\n\tif(zipfile.type !== 'application/zip') {\n\t    alert('Import files must be zip archives.');\n\t    return;\n\t}\n\tthis.change_state('uploading');\n\tlet reader = new FileReader();\n\treader.addEventListener(\n\t    'load',\n\t    event => this.process_uploaded_data(event.target.result));\n\treader.readAsArrayBuffer(zipfile);\n    }\n\n    process_uploaded_data(data) {\n\tthis.import_count = 0;\n\tthis.error_message = null;\n\tthis.change_state('importing');\n\tJSZip.loadAsync(data).then(zipfile => {\n\t    let promises = [];\n\t    for(let filename in zipfile.files) {\n\t\tconst file = zipfile.files[filename];\n\t\tif(filename.endsWith('.json')) {\n\t\t    promises.push(\n\t\t\tfile.async('string').then(\n\t\t\t    content => this.import_file(file.name.slice(0, file.name.length-5), content)));\n\t\t}\n\t\telse {\n\t\t    this.error_message = 'Invalid filename in archive: ' + filename;\n\t\t    this.failed_count++;\n\t\t}\n\t    }\n\t    Promise.all(promises).then(\n\t\t() => {\n\t\t    if(this.failed_count > 0)\n\t\t\tthis.import_result_string = 'Errors encountered: ' + this.error_message;\n\t\t    else\n\t\t\tthis.import_result_string = 'Successfully imported ' + this.import_count + ' document' + (this.import_count === 1 ? '' : 's');\n\t\t    this.change_state('idle');\n\t\t    this.file_list_needs_update = true;\n\t\t});\n\t});\n    }\n\n    import_file(filename, content) {\n\tlet document_storage = this.document_storage;\n\tlet parsed, app_state;\n\ttry {\n\t    parsed = JSON.parse(content);\n\t    app_state = AppState.from_json(parsed);\n\t} catch(e) {\n\t    this.error_message = 'Invalid document found in zip file: ' + filename;\n\t    this.failed_count++;\n\t    return;\n\t}\n\tdocument_storage.save_state(app_state, filename);\n\tthis.import_count++;\n\tthis.change_state('importing');\n    }\n}\n\n\nclass FileManagerState {\n    constructor(file_list, selected_filename, current_filename) {\n\tthis.file_list = file_list;\n\tthis.selected_filename = selected_filename;\n\tthis.current_filename = current_filename;\n\tthis.unavailable = false;  // set to true if there's a database error\n    }\n\n    sort_file_list(field, ascending) {\n\tthis.file_list.sort((a, b) => {\n\t    const a_value = a[field], b_value = b[field];\n\t    return (ascending ? 1 : -1)*(a_value === b_value ? 0 : (a_value < b_value ? -1 : 1));\n\t});\n    }\n\n    // basename -> basename_1\n    // basename_1 -> basename_2\n    // The first available name is used, so basename_50 -> basename_2\n    // if basename_2 is available but basename_1 is taken.\n    generate_unused_filename(basename) {\n\tif(this.unavailable || !this.file_list)\n\t    return basename;\n\tbasename = basename.replace(/_\\d+$/, '')\n\tfor(let n = 1; n < 1000; n++) {\n\t    const candidate = basename + '_' + n;\n\t    if(!this.file_list.some(file => file.filename === candidate))\n\t\treturn candidate;\n\t}\n\treturn basename + '_toomany';\n    }\n\n    // For moving up or down in the list of files.\n    find_adjacent_filename(filename, offset) {\n\tif(this.unavailable || !this.file_list) return null;\n\tlet new_filename = null;\n\tlet file_list = this.file_list;\n\tfile_list.forEach((f, index) => {\n\t    if(f.filename === filename) {\n\t\tlet new_index = index+offset;\n\t\tif(new_index < 0) new_index = 0;\n\t\tif(new_index >= file_list.length) new_index = file_list.length-1;\n\t\tnew_filename = file_list[new_index].filename;\n\t    }\n\t});\n\tif(!new_filename && file_list.length > 0)\n\t    new_filename = file_list[0].filename;\n\treturn new_filename;\n    }\n}\n\n\nclass Expr {\n    static from_json(json) {\n        switch(json.expr_type) {\n        case 'command':\n            return new CommandExpr(json.command_name, this._list(json.operand_exprs), json.options);\n\tcase 'prefix':\n\t    return new PrefixExpr(this._expr(json.base_expr), this._expr(json.prefix_expr));\n        case 'infix':\n            return new InfixExpr(this._expr(json.operator_expr), this._expr(json.left_expr), this._expr(json.right_expr));\n\tcase 'defer':\n\t    return new DeferExpr();\n        case 'text':\n            return new TextExpr(json.text);\n        case 'sequence':\n            return new SequenceExpr(this._list(json.exprs));\n        case 'delimiter':\n            return new DelimiterExpr(json.left_type, json.right_type, json.middle_type, this._list(json.inner_exprs));\n        case 'subscriptsuperscript':\n            return new SubscriptSuperscriptExpr(this._expr(json.base_expr), this._expr(json.subscript_expr), this._expr(json.superscript_expr));\n\tcase 'array':\n\t    return new ArrayExpr(json.array_type, json.row_count, json.column_count, this._list2d(json.element_exprs));\n        case 'accumulator':\n            return new AccumulatorExpr(json.accumulator_type, json.text);\n        default:\n            return new TextExpr('invalid expr type ' + json.expr_type);\n        }\n    }\n\n    // Helper routines for from_json\n    static _expr(json) { return json ? Expr.from_json(json) : null; }\n    static _list(json_array) { return json_array.map(expr_json => Expr.from_json(expr_json)); }\n    static _list2d(json_array) { return json_array.map(row_exprs => Expr._list(row_exprs)); }\n    \n    // Concatenate two Exprs into one.  This will merge Sequence and Text\n    // nodes when possible, instead of creating nested SequenceExprs.\n    static combine_pair(left, right) {\n        const left_type = left.expr_type(), right_type = right.expr_type();\n        if(left_type === 'sequence' && right_type === 'sequence')\n            return new SequenceExpr(left.exprs.concat(right.exprs));\n        else if(left_type === 'text' && right_type === 'text')\n            return new TextExpr(left.text + right.text);\n        else if(left_type === 'sequence' && right_type === 'text' &&\n                left.exprs[left.exprs.length-1].expr_type() === 'text') {\n            // Left sequence ends in a Text; merge it with the new Text.\n            return new SequenceExpr(\n                left.exprs.slice(0, -1).concat([\n                    new TextExpr(left.exprs[left.exprs.length-1].text + right.text)\n                ]));\n        }\n        else if(left_type === 'text' && right_type === 'text' &&\n                right.exprs[0].expr_type() === 'text') {\n            // Right sequence starts with a Text; merge it with the new Text.\n            return new SequenceExpr(\n                [new TextExpr(left.text + right.exprs[0].text)\n                ].concat(right.exprs.slice(1)));\n        }\n        else\n            return new SequenceExpr([left, right]);\n    }\n    \n    // TODO: remove if not actually needed\n    static combine_exprs(exprs) {\n\tswitch(exprs.length) {\n\tcase 0: return null;\n\tcase 1: return exprs[0];\n\tcase 2: return Expr.combine_pair(exprs[0], exprs[1]);\n\tdefault: return Expr.combine_pair(exprs[0], Expr.combine_exprs(exprs.slice(1)));\n\t}\n    }\n    \n    expr_type() { return '???'; }\n\n    to_latex() {\n\tlet emitter = new LatexEmitter();\n\tthis.emit_latex(emitter);\n\treturn emitter.finished_string();\n    }\n\n    emit_latex(emitter) { emitter.text('INVALID'); }\n\n    // Return a list of property names on this object that should be serialized\n    json_keys() { return []; }\n\n    // Subclasses can extend this if they need special handling.\n    to_json() {\n        let json = { expr_type: this.expr_type() };\n        this.json_keys().forEach(json_key => {\n            const obj = this[json_key];\n            let value;\n            if(obj === null || obj === undefined)\n                value = null;\n            else if(typeof(obj) === 'object' && obj instanceof Expr)\n                value = obj.to_json();\n            else if(typeof(obj) === 'object') {\n                // Assume it's an Array.  It could also be a 2-dimensional array, in which case the subclasses\n\t\t// need to extend to_json() instead of relying on this default.\n                value = obj.map(elt => elt.to_json());\n            }\n            else // Strings, numbers, etc.\n                value = obj;\n            json[json_key] = value;\n        });\n        return json;\n    }\n\n    to_text() { return \"$$\\n\" + this.to_latex() + \"\\n$$\"; }\n\n    // Invoke fn once for each subexpression in this expression tree (including 'this').\n    // The visiting is performed depth-first, left-to-right, so should correspond visually\n    // to the left-to-right rendering of the expression.\n    visit(fn) { fn(this); }\n\n    // Find the first DeferExpr that exists in this expression.  Returns null if none.\n    find_defer() {\n\tlet found = null;\n\tthis.visit(expr => {\n\t    if(expr.expr_type() === 'defer' && !found)\n\t\tfound = expr;\n\t});\n\treturn found;\n    }\n\n    // Return a (possibly) new Expr with old_expr substituted for new_expr, if old_expr is present.\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr)\n\t    return new_expr;\n\telse\n\t    return this;\n    }\n}\n\n\n// Represents a \"raw\" LaTeX command such as \\sqrt plus optional operand expressions.\nclass CommandExpr extends Expr {\n    // NOTES:\n    //   - 'command_name' does not include the initial \\ character\n    //   - 'options', if provided, is a plain string that becomes \"\\command_name[options]{...}\"\n    //   - 'command_name' itself can include the options in [brackets], in which case it is\n    //     automatically split off into 'options' (this is used for keybindings).\n    //     (e.g.: command_name='sqrt[3]' -> command_name='sqrt', options='3'\n    constructor(command_name, operand_exprs, options) {\n        super();\n        if(command_name.endsWith(']')) {\n            const index = command_name.indexOf('[');\n            this.command_name = command_name.slice(0, index);\n            this.options = command_name.slice(index+1, command_name.length-1);\n        }\n        else {\n            this.command_name = command_name;\n            this.options = options === undefined ? null : options;\n        }\n\tthis.operand_exprs = operand_exprs || [];\n    }\n\n    operand_count() { return this.operand_exprs.length; }\n    expr_type() { return 'command'; }\n    json_keys() { return ['command_name', 'operand_exprs', 'options']; }\n\n    emit_latex(emitter) {\n\temitter.command(this.command_name, this.options);\n\t// Braces need to be forced around each operand, even single-letter operands.\n\tthis.operand_exprs.forEach(operand_expr => emitter.grouped_expr(operand_expr, 'force'));\n    }\n\n    visit(fn) {\n\tfn(this);\n\tthis.operand_exprs.forEach(operand_expr => operand_expr.visit(fn));\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new CommandExpr(\n\t    this.command_name,\n\t    this.operand_exprs.map(operand_expr => operand_expr.substitute_expr(old_expr, new_expr)),\n\t    this.options\n\t);\n    }\n}\n\n\n// Represents one expression in front of another.\n// This is mainly used to keep track of whether an expression starts with a unary '-',\n// so that we can automatically reverse the sign when combining it with another expression\n// with infix '+', etc.\nclass PrefixExpr extends Expr {\n    constructor(base_expr, prefix_expr) {\n\tsuper();\n\tthis.base_expr = base_expr;\n\tthis.prefix_expr = prefix_expr;\n    }\n\n    expr_type() { return 'prefix'; }\n\n    json_keys() { return ['base_expr', 'prefix_expr']; }\n\n    emit_latex(emitter) {\n\temitter.expr(this.prefix_expr);\n\temitter.expr(this.base_expr);\n    }\n\n    visit(fn) {\n\tthis.prefix_expr.visit(fn);\n\tfn(this);\n\tthis.base_expr.visit(fn);\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new PrefixExpr(\n\t    this.base_expr.substitute_expr(old_expr, new_expr),\n\t    this.prefix_expr.substitute_expr(old_expr, new_expr));\n    }\n}\n\n\n// Two expressions joined by textual infix (something like + or \\wedge).\n// This is similar to concatenated TextNodes, but using InfixExpr lets things like ArrayExpr\n// automatically detect where to put alignments when the contents are InfixExprs.\n// NOTE: it's possible for left_expr or right_expr to be null; in that case, the corresponding\n// \"side\" isn't rendered.\nclass InfixExpr extends Expr {\n    constructor(operator_expr, left_expr, right_expr) {\n        super();\n        this.operator_expr = operator_expr;\n        this.left_expr = left_expr;\n        this.right_expr = right_expr;\n    }\n\n    expr_type() { return 'infix'; }\n\n    json_keys() { return ['operator_expr', 'left_expr', 'right_expr']; }\n\n    // If the infix operator is a simple command like '+' or '\\cap', return it\n    // (without the initial \\ if it has one).  If it's anything more complex, return null.\n    operator_text() {\n        const op_expr = this.operator_expr;\n        if(op_expr.expr_type() === 'command' && op_expr.operand_count() === 0)\n            return op_expr.command_name;\n        else if(op_expr.expr_type() === 'text')\n            return op_expr.text;\n        else\n            return null;\n    }\n\n    // Check if this is a low-precedence infix expression like x+y\n    // This is mostly for convenience so it doesn't need to be that precise.\n    needs_autoparenthesization() {\n        const op = this.operator_text();\n        return op && (op === '+' || op === '-');\n    }\n\n    emit_latex(emitter) {\n\tif(this.left_expr) emitter.expr(this.left_expr);\n\temitter.expr(this.operator_expr);\n        if(this.right_expr) emitter.expr(this.right_expr);\n    }\n\n    visit(fn) {\n\tif(this.left_expr) this.left_expr.visit(fn);\n\tfn(this);\n\tif(this.right_expr) this.right_expr.visit(fn);\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new InfixExpr(\n\t    this.operator_expr.substitute_expr(old_expr, new_expr),\n\t    this.left_expr.substitute_expr(old_expr, new_expr),\n\t    this.right_expr.substitute_expr(old_expr, new_expr));\n    }\n}\n\n\n// Represents a \"defer marker\" that can be used with the 'substitute_defer' command.\nclass DeferExpr extends Expr {\n    expr_type() { return 'defer'; }\n    json_keys() { return []; }\n\n    emit_latex(emitter) {\n\t// TODO: Maybe use KaTeX HTML support to give it a CSS class to color it\n\t// according to the current color theme.\n\t// const expr = new CommandExpr('circledast');\n\tconst expr = new CommandExpr('htmlClass', [new TextExpr('defer_expr'), new CommandExpr('circledast')]);\n\temitter.expr(expr);\n    }\n}\n\n\n// Represents a snippet of LaTeX code; these are the \"leaves\" of Expr-trees.\nclass TextExpr extends Expr {\n    constructor(text) {\n        super();\n        this.text = text;\n    }\n\n    expr_type() { return 'text'; }\n    json_keys() { return ['text']; }\n\n    emit_latex(emitter) { emitter.text(this.text); }\n}\n\n\n// Represents a sequence of expressions all concatenated together.\n// Adjacent SequenceExprs can be merged together; see Expr.combine_pair().\nclass SequenceExpr extends Expr {\n    constructor(exprs) {\n        super();\n        this.exprs = exprs;\n    }\n\n    expr_type() { return 'sequence'; }\n    json_keys() { return ['exprs']; }\n\n    emit_latex(emitter) {\n\tthis.exprs.forEach(expr => emitter.expr(expr));\n    }\n\n    visit(fn) {\n\tfn(this);\n\tthis.exprs.forEach(expr => expr.visit(fn));\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new SequenceExpr(\n\t    this.exprs.map(expr => expr.substitute_expr(old_expr, new_expr)));\n    }\n}\n\n\n// \\left( ... \\right)\n// If there is more than one inner_expr, they'll be separated with this.middle_type\n// e.g.: \\left( x \\middle| y \\right)\nclass DelimiterExpr extends Expr {\n    static parenthesize(expr) {\n        return new DelimiterExpr('(', ')', null, [expr]);\n    }\n\n    // Parenthesize 'expr' only if it's a low-precedence InfixExpr like 'x+y'.\n    static autoparenthesize(expr) {\n        if(expr.expr_type() === 'infix' && expr.needs_autoparenthesization())\n            return DelimiterExpr.parenthesize(expr);\n        else\n            return expr;\n    }\n    \n    constructor(left_type, right_type, middle_type, inner_exprs) {\n        super();\n        this.left_type = left_type;\n        this.right_type = right_type;\n        this.middle_type = middle_type || null;  // to avoid 'undefined's in the JSON\n        this.inner_exprs = inner_exprs || [];\n    }\n\n    expr_type() { return 'delimiter'; }\n    json_keys() { return ['left_type', 'right_type', 'middle_type', 'inner_exprs']; }\n\n    emit_latex(emitter) {\n\temitter.command('left');\n\temitter.text_or_command(this.left_type);\n\tthis.inner_exprs.forEach((expr, index) => {\n\t    if(index > 0) {\n\t\temitter.command('middle');\n\t\temitter.text_or_command(this.middle_type || '|');\n\t    }\n\t    emitter.expr(expr);\n\t});\n\temitter.command('right');\n\temitter.text_or_command(this.right_type);\n    }\n\n    visit(fn) {\n\tfn(this);\n\tthis.inner_exprs.forEach(expr => expr.visit(fn));\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new DelimiterExpr(\n\t    this.left_type, this.right_type, this.middle_type,\n\t    this.inner_exprs.map(expr => expr.substitute_expr(old_expr, new_expr)));\n    }\n}\n\n\n// The base expression may have a subscript, a superscript, or both.\n// This needs special handling in LaTeX.\nclass SubscriptSuperscriptExpr extends Expr {\n    constructor(base_expr, subscript_expr, superscript_expr) {\n        super();\n        this.base_expr = base_expr;\n        this.subscript_expr = subscript_expr;\n        this.superscript_expr = superscript_expr;\n    }\n\n    expr_type() { return 'subscriptsuperscript'; }\n    json_keys() { return ['base_expr', 'subscript_expr', 'superscript_expr']; }\n\n    emit_latex(emitter) {\n\t// If the base_expr is a command, don't put it inside grouping braces.\n\t// This accounts for attaching subscripts or superscripts to commands\n\t// with arguments such as \\underbrace{xyz}_{abc}.\n\tif(this.base_expr.expr_type() === 'command')\n\t    emitter.expr(this.base_expr);\n\telse\n\t    emitter.grouped_expr(this.base_expr);\n\tif(this.subscript_expr) {\n\t    emitter.text('_');\n\t    // 'force_commands' ensures that single LaTeX commands are still grouped, even\n\t    // though single-letter super/subscripts are still OK to leave ungrouped.\n\t    // e.g.: x^{\\sum} instead of x^\\sum, but x^2 is fine.\n\t    emitter.grouped_expr(this.subscript_expr, 'force_commands');\n\t}\n\tif(this.superscript_expr) {\n\t    emitter.text('^');\n\t    emitter.grouped_expr(this.superscript_expr, 'force_commands');\n\t}\n    }\n\n    visit(fn) {\n\tfn(this);\n\tthis.base_expr.visit(fn);\n\tif(this.subscript_expr) this.subscript_expr.visit(fn);\n\tif(this.superscript_expr) this.superscript_expr.visit(fn);\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\treturn new SubscriptSuperscriptExpr(\n\t    this.base_expr.substitute_expr(old_expr, new_expr),\n\t    this.subscript_expr ? this.subscript_expr.substitute_expr(old_expr, new_expr) : null,\n\t    this.superscript_expr ? this.superscript_expr.substitute_expr(old_expr, new_expr) : null);\n    }\n}\n\n\n// \\begin{bmatrix} ... etc\nclass ArrayExpr extends Expr {\n    // split_mode:  (for placing alignment markers automatically for \"\\cases\" and such)\n    //    'none': do nothing, just put each entry_expr in its own row\n    //    'infix': place alignment markers before infix, if any\n    //    'colon': if there is a ':' infix, remove it and place alignment marker where it was\n    static split_elements(exprs, split_mode) {\n\treturn exprs.map(expr => ArrayExpr._split_expr(expr, split_mode));\n    }\n\n    // Split up 'expr' into separately-aligned 'columns'.\n    static _split_expr(expr, split_mode) {\n        switch(split_mode) {\n        case 'none':\n            return [expr];\n        case 'infix':\n            if(expr.expr_type() === 'infix')\n                return [expr.left_expr, new InfixExpr(expr.operator_expr, null, expr.right_expr)];\n            else\n                return [expr, null];\n        case 'colon':\n            if(expr.expr_type() === 'infix' && expr.operator_text() === ':')\n                return [expr.left_expr, expr.right_expr];\n            else\n                return [expr, null];\n        default:\n            return [expr];\n        }\n    }\n    \n    constructor(array_type, row_count, column_count, element_exprs) {\n\tsuper();\n\tthis.array_type = array_type;\n\tthis.row_count = row_count;\n\tthis.column_count = column_count;\n\tthis.element_exprs = element_exprs;\n    }\n\n    expr_type() { return 'array'; }\n    json_keys() { return ['array_type', 'row_count', 'column_count']; }\n\n    is_matrix() {\n\tconst t = this.array_type;\n\t// TODO: t.endsWith('matrix')?\n\treturn (t === 'bmatrix' || t === 'Bmatrix' || t === 'matrix' ||\n\t\tt === 'pmatrix' || t === 'vmatrix' || t === 'Vmatrix');\n    }\n\n    to_json() {\n\tlet json = super.to_json();\n\tjson.element_exprs = this.element_exprs.map(\n\t    row_exprs => row_exprs.map(expr => expr.to_json()));\n\treturn json;\n    }\n\n    // Return a new ArrayExpr like this one, but with ellipses inserted before the\n    // last row and column, and along the diagonal.\n    // NOTE: is_matrix() should be true before calling this.\n    with_ellipses() {\n        if(this.row_count <= 1 || this.column_count <= 1)\n            return this;\n        const make_cell = (content) => new TextExpr(content);\n        let new_element_exprs = this.element_exprs.map((row_exprs, index) => [\n            ...row_exprs.slice(0, -1),\n            make_cell((index === 0 || index === this.row_count-1) ? \"\\\\cdots\" : ''),\n            row_exprs[this.column_count-1]\n        ]);\n        let inserted_row_exprs = [make_cell(\"\\\\vdots\")];\n        for(let i = 0; i < this.column_count-2; i++)\n            inserted_row_exprs.push(make_cell(''));\n        inserted_row_exprs.push(make_cell(\"\\\\ddots\"));\n        inserted_row_exprs.push(make_cell(\"\\\\vdots\"));\n        new_element_exprs.splice(this.row_count-1, 0, inserted_row_exprs);\n        return new ArrayExpr(this.array_type, this.row_count+1, this.column_count+1, new_element_exprs);\n    }\n\n    // Return a new ArrayExpr with rows and columns interchanged.\n    // NOTE: is_matrix() should be true before calling this.\n    transposed() {\n        let new_element_exprs = [];\n        for(let i = 0; i < this.column_count; i++)\n            new_element_exprs.push(this.element_exprs.map(\n                row_exprs => this._transpose_cell(row_exprs[i])));\n        return new ArrayExpr(this.array_type, this.column_count, this.row_count, new_element_exprs);\n    }\n\n    // When transposing a matrix, we generally want to flip vertical and horizontal ellipses\n    // within the cells.\n    _transpose_cell(cell_expr) {\n        if(cell_expr.expr_type() === 'text') {\n            switch(cell_expr.text) {\n            case \"\\\\vdots\": return new TextExpr(\"\\\\cdots\");\n            case \"\\\\cdots\": return new TextExpr(\"\\\\vdots\");\n            default: break;\n            }\n        }\n        return cell_expr;\n    }\n\n    // Return an array of 1xN ArrayExprs, one for each row in this matrix.\n    // NOTE: is_matrix() should be true before calling this.\n    split_rows() {\n        return this.element_exprs.map(\n            row_exprs => new ArrayExpr(this.array_type, 1, this.column_count, [row_exprs]));\n    }\n\n    emit_latex(emitter) {\n\temitter.begin_environment(this.array_type);\n\tthis.element_exprs.forEach((row_exprs, row_index) => {\n\t    if(row_index > 0) emitter.row_separator();\n\t    row_exprs.forEach((expr, col_index) => {\n\t\tif(col_index > 0) emitter.align_separator();\n\t\tif(expr) emitter.expr(expr);\n\t    });\n\t});\n\temitter.end_environment(this.array_type);\n    }\n\n    visit(fn) {\n\tfn(this);\n\tthis.element_exprs.forEach(\n\t    row_exprs => row_exprs.forEach(expr => expr.visit(fn)));\n    }\n\n    substitute_expr(old_expr, new_expr) {\n\tif(this === old_expr) return new_expr;\n\tconst new_element_exprs = this.element_exprs.map(\n\t    row_exprs => row_exprs.map(\n\t\texpr => expr.substitute_expr(old_expr, new_expr)));\n\treturn new ArrayExpr(this.array_type, this.row_count, this.column_count, new_element_exprs);\n    }\n}\n\n\n// Accumulate text character-by-character into a string.\n// accumulator_type can be:\n//    latex: turns into a \\arbitrarylatexcommand\n//    text: turns into a TextExpr\nclass AccumulatorExpr extends Expr {\n    constructor(accumulator_type, text) {\n        super();\n        this.accumulator_type = accumulator_type;\n        this.text = text;\n    }\n\n    expr_type() { return 'accumulator'; }\n    json_keys() { return ['accumulator_type', 'text']; }\n\n    with_extra_character(c) {\n        return new AccumulatorExpr(this.accumulator_type, this.text + c);\n    }\n\n    without_last_character() {\n        return new AccumulatorExpr(this.accumulator_type, this.text.slice(0, -1));\n    }\n\n    is_valid_character(ch) {\n        if(this.accumulator_type === 'latex') {\n\t    // LaTeX commands can only contain upper/lowercase letters,\n\t    // with the exception of single-character commands like \\:\n\t    const alpha_regex = /^[a-zA-Z]$/;\n\t    if(this.text.length === 0 && ch.length === 1)\n\t\treturn true;\n\t    else if(this.text.length === 1 && !alpha_regex.test(this.text))\n\t\treturn false;\n\t    else\n\t\treturn alpha_regex.test(ch);\n\t}\n        else {\n\t    // Allow anything in 'normal' text, but suppress multi-character\n\t    // strings like \"Alt\" that can come in from keyboard events.\n            return ch.length === 1;\n\t}\n    }\n\n    is_empty() { return this.text.length === 0; }\n\n    // Create an Expr for this accumulator assuming it's finished.\n    // Returns null if empty.\n    finished_expr() {\n        const text = this.text.trim();\n        if(text.length === 0) return null;\n        switch(this.accumulator_type) {\n        case 'latex': return new CommandExpr(text);\n        case 'text': return new TextExpr(this._latex_escape(text));\n        default: return null;\n        }\n    }\n\n    // TODO: may want to make this a general utility method, but it's only used here so far.\n    _latex_escape(text) {\n\tconst replacements = {\n\t    '_': \"\\\\_\",\n\t    '^': \"\\\\wedge\",\n\t    '%': \"\\\\%\",\n\t    \"'\": \"\\\\prime\",\n\t    \"`\": \"\\\\backprime\",\n\t    ' ': \"\\\\,\",\n\t    '$': \"\\\\$\",\n\t    '&': \"\\\\&\",\n\t    '#': \"\\\\#\",\n\t    '}': \"\\\\}\",\n\t    '{': \"\\\\{\",\n\t    '~': \"\\\\sim\",\n\t    \"\\\\\": \"\\\\backslash\",\n\t};\n\treturn text.replaceAll(/[_^%'` $&#}{~\\\\]/g, match => replacements[match]);\n    }\n\n    emit_latex(emitter) {\n\temitter.expr(this._to_display_expr());\n    }\n\n    // Return an Expr used to display this accumulator while it's being edited.\n    _to_display_expr() {\n\tswitch(this.accumulator_type) {\n\tcase 'latex':\n\t    return new SequenceExpr([\n\t\tnew CommandExpr('backslash'),\n\t\tnew CommandExpr('mathrm', [\n\t\t    this.is_empty() ? new CommandExpr('thinspace') : new TextExpr(this._latex_escape(this.text))\n\t\t])]);\n\tcase 'text':\n\t    return new CommandExpr('boxed', [\n\t\tnew SequenceExpr([\n\t\t    new CommandExpr('vphantom', [new TextExpr('I')]),\n\t\t    this.is_empty() ? new CommandExpr(',') : new TextExpr(this._latex_escape(this.text))\n\t\t])]);\n\tdefault:\n\t    return new TextExpr('???');\n\t}\n    }\n}\n\n\n// Represents an entry in the stack or document.\nclass Item {\n    // Used for React collection keys.  Each entry in a React component list is\n    // supposed to have a unique ID.\n    // NOTE: iOS Safari doesn't seem to like static variables like this?\n    // As a workaround, this will be initialized after the class definition instead.\n    //static serial_number = 1;\n    static next_serial() { return Item.serial_number++; }\n\n    static from_json(json) {\n        switch(json.item_type) {\n        case 'expr': return new ExprItem(\n\t    Expr.from_json(json.expr),\n\t    json.tag_expr ? Expr.from_json(json.tag_expr) : null);\n        case 'markdown':\n\t    return new MarkdownItem(json.source_text);\n        default:\n\t    return new MarkdownItem('invalid item type ' + json.item_type);\n        }\n    }\n\n    // Create an appropriate Item subclass instance for the given string.\n    // If string is wrapped in $$ pairs, it's treated as an ExprItem containing raw LaTeX code.\n    // Otherwise, it's treated as Markdown text.\n    static from_string(string) {\n        string = (string || '').trim();\n\t// NOTE: .slice(2) here is to avoid pathological cases '$$', '$$$'\n        if(string.startsWith('$$') && string.slice(2).endsWith('$$')) {\n            const latex = string.slice(2, -2);\n            return new ExprItem(new TextExpr(latex));\n        }\n        else\n            return new MarkdownItem(string);\n    }\n    \n    constructor() {\n        this.serial = Item.next_serial();\n    }\n\n    react_key(prefix) { return prefix + '_' + this.serial; }\n\n    // Subclasses need to override these:\n    item_type() { return '???'; }\n    to_json() { return {}; }\n    to_text() { return '???'; }\n}\n\n// iOS Safari workaround\nItem.serial_number = 1;\n\n\n// Represents a math expression (Expr instance) in the stack or document.\nclass ExprItem extends Item {\n    // tag_expr is an optional tag shown to the right of the item.\n    constructor(expr, tag_expr) {\n        super()\n        this.expr = expr;\n\tthis.tag_expr = tag_expr;\n    }\n\n    item_type() { return 'expr'; }\n\n    to_json() {\n\tlet json = {item_type: 'expr', expr: this.expr.to_json()};\n\tif(this.tag_expr) json.tag_expr = this.tag_expr.to_json();\n\treturn json;\n    }\n\n    to_text() { return this.expr.to_text(); }\n}\n\n\n// Represents a Markdown text object in the stack or document.\nclass MarkdownItem extends Item {\n    constructor(source_text) {\n        super();\n        this.source_text = source_text;\n        // this.setup_tokenizer();\n        this.rendered_html = this.render_markdown(this.source_text);\n    }\n\n    is_empty() { return this.source_text.trim().length === 0; }\n\n    render_markdown(source_text) {\n\t// Replace $ by ` before sending it to Marked.\n\t// This isn't ideal but the custom tokenizer code below doesn't seem to work.\n\tsource_text = source_text.replaceAll('$', '`');\n        return marked.parse(source_text);\n    }\n\n    // TODO: this doesn't work even though it's what's in the documentation\n    // setup_tokenizer() {\n    //  if(MarkdownItem.tokenizer_initialized) return;\n    //  const tokenizer = {\n    //      codespan(src) {\n    //          const match = src.match(/\\$+([^\\$\\n]+?)\\$+/);\n    //          if (match) {\n    //              return {\n    //                  type: 'codespan',\n    //                  raw: match[0],\n    //                  text: match[1].trim()\n    //              };\n    //          }\n    //          return false;\n    //      }\n    //  };\n    //  marked.use({tokenizer});\n    //  MarkdownItem.tokenizer_initialized = true;\n    // }\n\n    item_type() { return 'markdown'; }\n\n    to_json() {\n        return {item_type: 'markdown', source_text: this.source_text};\n    }\n\n    // TODO: convert Markdown syntax to something LaTeX-compatible\n    to_text() { return this.source_text; }\n}\n\n\n// NOTE: All stack operations return a new Stack with the modified\n// items, leaving the original untouched.\nclass Stack {\n    static from_json(json) {\n        const items = json.items.map(item_json => Item.from_json(item_json));\n        return new Stack(items);\n    }\n    \n    constructor(items) {\n        this.items = items;\n    }\n\n    depth() { return this.items.length; }\n    check(n) { return this.depth() >= n; }\n\n    // Check that at least n items are available and that they are all ExprItems\n    check_exprs(n) {\n        if(!this.check(n)) return false;\n        for(let i = 0; i < n; i++)\n            if(this.items[this.items.length-1-i].item_type() !== 'expr')\n                return false;\n        return true;\n    }\n\n    // Fetch item at position n (stack top = 1, next = 2, etc)\n    peek(n) {\n        if(!this.check(1)) this.underflow();\n        return this.items[this.items.length - n];\n    }\n\n    // Returns [new_stack, item1, item2, ...]\n    pop(n) {\n        if(n === undefined) n = 1;\n        if(!this.check(n)) this.underflow();\n        return this._unchecked_pop(n);\n    }\n\n    // Like pop(n) but all the items have to be ExprItems.\n    pop_exprs(n) {\n        if(!this.check(n)) this.underflow();\n        if(!this.check_exprs(n)) this.type_error();\n        const [new_stack, ...items] = this._unchecked_pop(n);\n        return [new_stack, ...items.map(item => item.expr)];\n    }\n\n    // n >= 1\n    pop_positive_integer() {\n        const [new_stack, expr] = this.pop_exprs(1);\n        if(expr.expr_type() === 'text') {\n            const value = parseInt(expr.text);\n            if(value >= 1) return [new_stack, value];\n        }\n        this.type_error();\n    }\n\n    pop_matrices(n) {\n\tconst [new_stack, ...exprs] = this.pop_exprs(n);\n\tif(exprs.every(expr => expr.expr_type() === 'array' && expr.is_matrix()))\n\t    return [new_stack, ...exprs];\n\telse\n\t    this.type_error();\n    }\n\n    _unchecked_pop(n) {\n        return [new Stack(this.items.slice(0, -n))].concat(this.items.slice(-n));\n    }\n    \n    push_all(items) {\n        if(!items.every(item => item instanceof Item))\n            throw new Error('pushing invalid item onto stack');\n        return new Stack(this.items.concat(items));\n    }\n    \n    push_all_exprs(exprs) { return this.push_all(exprs.map(expr => new ExprItem(expr))); }\n    push(item) { return this.push_all([item]); }\n    push_expr(expr) { return this.push_all_exprs([expr]); }\n\n    underflow() { throw new Error('stack_underflow'); }\n    type_error() { throw new Error('stack_type_error'); }\n\n    to_json() {\n        return {\n            object_type: 'stack',\n            items: this.items.map(item => item.to_json())\n        };\n    }\n}\n\n\nclass Document {\n    static from_json(json) {\n        return new Document(\n\t    json.items.map(item_json => Item.from_json(item_json)),\n\t    json.selection_index || 0);\n    }\n\n    // NOTE: selection_index can be in the range 0..items.length (inclusive).\n    constructor(items, selection_index) {\n        this.items = items || [];\n        this.selection_index = selection_index;\n    }\n\n    selected_item() {\n        if(this.selection_index > 0)\n            return this.items[this.selection_index-1];\n        else\n            return null;\n    }\n\n    // Insert a new item below the current selection, and select the inserted item.\n    // Returns a modified Document; does not alter this one.\n    insert_item(new_item) {\n        const index = this.selection_index;\n        const new_items = this.items.slice(0, index).concat([new_item], this.items.slice(index));\n        return new Document(new_items, index+1);\n    }\n\n    // Return the new Document if the selection was deleted successfully.\n    // Selects the item that was before this one (or select the 'document top' if this was the first).\n    // Return null if the selection is \"invalid\" (e.g., empty document).\n    delete_selection() {\n        const index = this.selection_index;\n        if(index > 0) {\n            const new_items = this.items.slice(0, index-1).concat(this.items.slice(index));\n            return new Document(new_items, index-1);\n        }\n        else\n            return null;\n    }\n\n    move_selection_by(offset) {\n        let new_index = this.selection_index + offset;\n        if(new_index < 0) new_index = 0;\n        if(new_index > this.items.length) new_index = this.items.length;\n        return new Document(this.items, new_index);\n    }\n\n    // If there is a current selection, move it by the given offset.\n    // Returns the changed document if anything was done.\n    shift_selection_by(offset) {\n        const item = this.selected_item();\n        if(!item ||\n           this.selection_index + offset <= 0 ||\n           this.selection_index + offset > this.items.length)\n            return null;\n\telse\n\t    return this.delete_selection().move_selection_by(offset).insert_item(item);\n    }\n\n    to_json() {\n        return {\n            object_type: 'document',\n            items: this.items.map(item => item.to_json()),\n\t    selection_index: this.selection_index\n        };\n    }\n\n    to_text() {\n\treturn this.items.map(item => item.to_text()).join(\"\\n\\n\");\n    }\n}\n\n\nexport {\n    Keymap, Settings, AppState, UndoStack, DocumentStorage, ImportExportState, FileManagerState,\n    Expr, CommandExpr, PrefixExpr, InfixExpr, DeferExpr, TextExpr, SequenceExpr,\n    DelimiterExpr, SubscriptSuperscriptExpr, ArrayExpr,\n    AccumulatorExpr, Item, ExprItem, MarkdownItem, Stack, Document\n};\n\n","\nimport {\n    /*Settings, */ AppState,\n    Expr, CommandExpr, PrefixExpr, InfixExpr, DeferExpr, TextExpr, SequenceExpr,\n    DelimiterExpr, SubscriptSuperscriptExpr, ArrayExpr,\n    AccumulatorExpr,\n    Item, ExprItem, MarkdownItem, Stack /*, Document*/\n} from './Models';\n\n\n// This acts as a sort of extension to the main App component.\n// TODO: rename -> EditorActions or something\nclass InputContext {\n    constructor(app_component, settings) {\n\tthis.app_component = app_component;\n        this.mode = 'base';\n        this.new_mode = null;\n        this.new_document = null;\n\tthis.files_changed = false;\n\tthis.file_saved = false;\n\tthis.settings = settings;\n\n\t// If set, this will be displayed as a transient notification in\n\t// the stack area.  Cleared after every keypress.\n\tthis.notification_text = null;\n\n        // Special indicator to help control the undo stack:\n        //    null - save state to undo stack after this action as normal\n        //    'undo' - request an undo\n        //    'redo' - request a redo of saved undo states\n        //    'suppress' - perform action as normal, but don't save state to the undo state\n        //                 (used for 'minor' actions that don't warrant undo tracking)\n        //    'clear' - undo stack will be reset (e.g. when loading a new document)\n        this.perform_undo_or_redo = null;\n\n        // Tracks minieditor state for editing the stack-top.\n        this.minieditor = {active: false};\n\n        // Tracks multi-part custom_delimiters commands\n        this.custom_delimiters = {};\n    }\n\n    // Returns [was_handled, new_app_state]\n    // NOTE: was_handled just indicates that a keybinding was found; it doesn't necessarily mean\n    // that the command succeeded without error.\n    handle_key(app_state, key) {\n        if(key === 'Shift' || key === 'Alt' || key === 'Control')\n\t    return [false, app_state];\n\n        // Special case: if stack top is an AccumulatorExpr, make sure we're in 'accumulate' input mode.\n        if(app_state.stack.depth() > 0 && app_state.stack.peek(1).item_type() === 'expr' &&\n           app_state.stack.peek(1).expr.expr_type() === 'accumulator')\n            this.mode = 'accumulate';\n\n\t// If the popup panel is active, always use its dedicated keymap.\n\tconst effective_mode = this.settings.popup_mode || this.mode;\n        const command = this.settings.current_keymap.lookup_binding(effective_mode, key);\n        if(command) {\n            this.last_keypress = key;\n            const new_app_state = this.process_command(command, app_state);\n            return [true, new_app_state || app_state];\n        }\n        else\n            return [false, app_state];\n    }\n\n    // Returns the new AppState, or null if anything failed.\n    process_command(command, app_state) {\n\t// Command strings are of the form:\n\t//   'piece1;piece2;piece3'\n\t// where the pieces are subcommands to be executed as a batch.\n\t// Each piece in turn is a space-separated list where the first item\n\t// is the command name and the remainder are arguments to the command.\n\t// To put a literal semicolon into a command, write out 'semicolon'.\n\tconst commands = command.split(';').map(\n\t    piece => piece.split(' ').map(\n\t\ttoken => token.replaceAll('semicolon', ';')));\n        return this.process_command_batch(commands, app_state);\n    }\n\n    // Process a batch of commands as a unit, returning the new AppState (or null if any of them failed).\n    // Each command is of the form [command_name, param1, param2, ...]\n    process_command_batch(commands, app_state) {\n        this.perform_undo_or_redo = null;\n        for(let i = 0; i < commands.length; i++) {\n            const [command_name, ...parameters] = commands[i];\n            const handler_function = this['do_' + command_name];\n            if(!handler_function)\n                return null;\n            try {\n                // Set up context variables for the handler functions to use:\n                this.app_state = app_state;\n\n\t\t// TODO: maybe have this.changed.mode, this.changed.document etc.\n\n                // Watch to see if the handler sets new_mode.  If it does, switch to that\n                // mode after the command is finished, but otherwise switch back to base mode.\n                this.new_mode = null;\n\n                // The handler function will set this if the document changes.\n                // (Stack changes are expected to be returned by the handler function.)\n                this.new_document = null;\n\n\t\t// Likewise this will be set to true if anything changed about the file list / file selection.\n\t\tthis.files_changed = false;  // TODO: rename -> selected_file_changed\n\n\t\t// This will be set to true if the current file was saved by this action.\n\t\t// This indicates that the app state's dirty flag should be cleared.\n\t\tthis.file_saved = false;\n\n\t\tthis.notification_text = null;\n\n                // Execute the handler and assemble the new state.\n                const new_stack = (handler_function.bind(this))(app_state.stack, ...parameters);\n                let new_app_state = new AppState(\n                    new_stack || app_state.stack,\n                    this.new_document || app_state.document\n                );\n\t\tnew_app_state.is_dirty = app_state.is_dirty || !new_app_state.same_as(app_state);\n\t\tif(this.file_saved)  // Current file was saved; explicitly clear the dirty flag.\n\t\t    new_app_state.is_dirty = false;\n\t\tapp_state = new_app_state;\n\n                // Switch back into base mode if the mode was not explicitly set by the handler.\n                this.mode = this.new_mode || 'base';\n            } catch(e) {\n                if(e.message === 'stack_underflow' || e.message === 'stack_type_error') {\n                    this.error_flash_stack();\n                    this.perform_undo_or_redo = null;\n                    this.mode = 'base';\n                    return null;\n                }\n                else throw e;\n            }\n            finally {\n                // Avoid holding references longer than needed.\n                this.app_state = null;\n                this.new_document = null;\n            }\n        }\n        return app_state;\n    }\n\n    switch_to_mode(new_mode) {\n\tthis.new_mode = new_mode;\n    }\n\n    error_flash_element(dom_element) {\n        dom_element.classList.remove('errorflash');\n        // eslint-disable-next-line no-unused-expressions\n        dom_element.offsetWidth;  // force reflow\n        dom_element.classList.add('errorflash');\n    }\n    error_flash_stack() { return this.error_flash_element(document.getElementById('stack_panel')); }\n    error_flash_document() { return this.error_flash_element(document.getElementById('document_panel')); }\n    clear_all_flashes() {\n        const elt_ids = ['stack_panel', 'document_panel'];\n        for(let elt_id = 0; elt_id < elt_ids.length; elt_id++) {\n            let elt = document.getElementById(elt_ids[elt_id]);\n            elt.classList.remove('errorflash');\n        }\n    }\n\n    notify(text) { this.notification_text = text; }\n\n    // If the base already has a subscript, and is_superscript is true, the superscript\n    // is placed into the existing base.  Otherwise, a new subscript/superscript node\n    // is created.  A similar rule applies if is_superscript is false.\n    _build_subscript_superscript(base_expr, child_expr, is_superscript) {\n        // Check to see if we can slot the child into an empty sub/superscript \"slot\".\n        if(base_expr.expr_type() === 'subscriptsuperscript' &&\n           ((base_expr.subscript_expr === null && !is_superscript) ||\n            (base_expr.superscript_expr === null && is_superscript))) {\n            // There's \"room\" for it in this expr.\n            return new SubscriptSuperscriptExpr(\n                base_expr.base_expr,\n                (is_superscript ? base_expr.subscript_expr : child_expr),\n                (is_superscript ? child_expr : base_expr.superscript_expr));\n        }\n        else {\n            // Create a new expr instead.  The base will be parenthesized if\n            // it's a low-precedence infix expression.\n            base_expr = DelimiterExpr.autoparenthesize(base_expr);\n            return new SubscriptSuperscriptExpr(\n                base_expr,\n                (is_superscript ? null : child_expr),\n                (is_superscript ? child_expr : null));\n        }\n    }\n\n    // Second-to-top stack item becomes the base, while the stack top becomes the\n    // subscript or superscript depending on 'is_superscript'.\n    make_subscript_superscript(stack, is_superscript) {\n        const [new_stack, base_expr, child_expr] = stack.pop_exprs(2);\n\tconst new_expr = this._build_subscript_superscript(base_expr, child_expr, is_superscript);\n        return new_stack.push_expr(new_expr);\n    }\n\n    do_subscript(stack) { return this.make_subscript_superscript(stack, false); }\n    do_superscript(stack) { return this.make_subscript_superscript(stack, true); }\n\n    // Add a \\prime to the stack top; this is almost like do_superscript with \\prime\n    // but needs some special handling to coalesce multiple \\prime into a single superscript.\n    do_prime(stack) {\n\tconst [new_stack, base_expr] = stack.pop_exprs(1);\n\tconst new_prime_expr = new CommandExpr('prime', []);\n\n\t// Check whether the base expr is already of the form x^{\\prime}, x^{\\prime\\prime}, etc.\n\t// If so, add an extra \\prime into the superscript.\n\tif(base_expr.expr_type() === 'subscriptsuperscript' && base_expr.superscript_expr) {\n\t    const s = base_expr.superscript_expr;\n\t    const is_prime_command = expr =>\n\t\t  expr.expr_type() === 'command' &&\n\t\t  expr.operand_count() === 0 && expr.command_name === 'prime';\n\t    let new_superscript_expr;\n\t    if(is_prime_command(s))\n\t\tnew_superscript_expr = new SequenceExpr([s, new_prime_expr]);\n\t    else if(s.expr_type() === 'sequence' && s.exprs.every(is_prime_command))\n\t\tnew_superscript_expr = new SequenceExpr(s.exprs.concat([new_prime_expr]));\n\t    else\n\t\tnew_superscript_expr = null;\n\t    if(new_superscript_expr) {\n\t\tconst new_expr = new SubscriptSuperscriptExpr(\n\t\t    base_expr.base_expr, base_expr.subscript_expr, new_superscript_expr);\n\t\treturn new_stack.push_expr(new_expr);\n\t    }\n\t}\n\n\t// Otherwise, adding a prime works just like adding a \\prime superscript.\n\tconst new_expr = this._build_subscript_superscript(base_expr, new_prime_expr, true);\n\treturn new_stack.push_expr(new_expr);\n    }\n\n    do_mode(stack, new_mode) { this.switch_to_mode(new_mode); }\n\n    do_undo() { this.perform_undo_or_redo = 'undo'; }\n    do_redo() { this.perform_undo_or_redo = 'redo'; }\n\n    do_dup(stack) {\n        const [new_stack, item] = stack.pop(1);\n        return new_stack.push_all([item, item]);\n    }\n    do_pop(stack) {\n        // eslint-disable-next-line no-unused-vars\n        const [new_stack, popped_item] = stack.pop(1);\n        return new_stack;\n    }\n    // a b -> b\n    do_nip(stack) {\n        // eslint-disable-next-line no-unused-vars\n        const [new_stack, a, b] = stack.pop(2);\n        return new_stack.push(b);\n    }\n    do_swap(stack) {\n        const [new_stack, a, b] = stack.pop(2);\n        return new_stack.push_all([b, a]);\n    }\n    // a b -> b a b\n    do_tuck(stack) {\n        const [new_stack, a, b] = stack.pop(2);\n        return new_stack.push_all([b, a, b]);\n    }\n    // a b -> a b a\n    do_over(stack) {\n        const [new_stack, a, b] = stack.pop(2);\n        return new_stack.push_all([a, b, a]);\n    }\n    // a b c -> b c a\n    do_rot(stack) {\n        const [new_stack, a, b, c] = stack.pop(3);\n        return new_stack.push_all([b, c, a]);\n    }\n    // a b c -> c a b\n    do_unrot(stack) {\n        const [new_stack, a, b, c] = stack.pop(3);\n        return new_stack.push_all([c, a, b]);\n    }\n    // a_1 a_2 ... a_n N -> a_n ... a_2 a_1\n    do_reverse_n(stack) {\n\tconst [new_stack, item_count] = stack.pop_positive_integer();\n\tconst [new_stack_2, ...items] = new_stack.pop(item_count);\n\titems.reverse();\n\treturn new_stack_2.push_all(items);\n    }\n    do_reverse_all(stack) {\n\tconst [new_stack, ...items] = stack.pop(stack.depth());\n\titems.reverse();\n\treturn new_stack.push_all(items);\n    }\n    do_clear_stack() {\n        return new Stack([]);\n    }\n\n    do_change_document_selection(stack, amount_string) {\n        const amount = parseInt(amount_string);\n        this.new_document = this.app_state.document.move_selection_by(amount);\n\t// this.perform_undo_or_redo = 'suppress';\n    }\n\n    do_shift_document_selection(stack, amount_string) {\n        const amount = parseInt(amount_string);\n        const new_document = this.app_state.document.shift_selection_by(amount);\n        if(new_document)\n            this.new_document = new_document;\n        else\n            this.error_flash_document();\n    }\n\n    do_save_file(stack) {\n\tconst file_manager_state = this.app_component.state.file_manager_state;\n        const filename = file_manager_state.current_filename;\n\tif(!filename)\n\t    return this.do_save_file_as(stack);\n\tthis.app_component.state.document_storage.save_state(\n\t    this.app_state, filename,\n\t    () => {\n\t\tthis.notify('Saved: ' + filename);\n\t\tthis.settings.last_opened_filename = filename;\n\t\tthis.settings.save();\n\t\tthis.perform_undo_or_redo = 'clear';\n\t\tthis.app_component.request_file_list();\n\t    },\n\t    () => this.notify('Error saving:' + filename)\n\t);\n\tthis.file_saved = true;\n    }\n\n    // TODO: factor with do_save_file\n    do_save_file_as(stack) {\n        let new_filename = window.prompt('Enter the filename to save as', this.settings.current_filename);\n        if(!new_filename)\n            return;\n\tlet document_storage = this.app_component.state.document_storage;\n        new_filename = document_storage.sanitize_filename(new_filename);\n        document_storage.save_state(\n\t    this.app_state, new_filename,\n\t    () => {\n\t\tthis.notify('Saved as: ' + new_filename);\n\t\tlet file_manager_state = this.app_component.state.file_manager_state;\n\t\tfile_manager_state.selected_filename = file_manager_state.current_filename = new_filename;\n\t\tthis.settings.last_opened_filename = new_filename;\n\t\tthis.settings.save();\n\t\tthis.perform_undo_or_redo = 'clear';\n\t\tthis.app_component.request_file_list();\n\t    },\n\t    () => this.notify('Error saving: ' + new_filename)\n\t);\n\tthis.file_saved = true;\n    }\n\n    do_load_selected_file(stack) {\n\tconst selected_filename = this.app_component.state.file_manager_state.selected_filename;\n        if(!selected_filename)\n\t    return this.error_flash_document();\n\n\t// Save current document first.\n\t// TODO: This creates a bit of a race condition, may want to revisit.\n\tthis.do_save_file(stack);\n\t\n\tthis.app_component.start_loading_filename(selected_filename);\n    }\n\n    do_start_new_file(stack) {\n\tlet file_manager_state = this.app_component.state.file_manager_state;\n\tlet document_storage = this.app_component.state.document_storage;\n        let new_filename = file_manager_state.generate_unused_filename(file_manager_state.current_filename || 'untitled');\n        new_filename = window.prompt('Enter a filename for the new document', new_filename);\n        if(!new_filename) return;\n        new_filename = document_storage.sanitize_filename(new_filename || '');\n\tif(!new_filename) {\n\t    alert('Invalid filename (must only contain letters, numbers and underscores)');\n\t    return;\n\t}\n\n\t// Save the current document if needed first.\n\tif(file_manager_state.current_filename) {\n\t    // NOTE: don't put up the notification flash here, unlike with an explicit save_document.\n\t    document_storage.save_state(this.app_state, file_manager_state.current_filename);\n\t}\n\n        // This basically works like loading from a blank file\n        let new_state = new AppState();\n        this.new_document = new_state.document;\n\tfile_manager_state.selected_filename = file_manager_state.current_filename = new_filename;\n\tthis.settings.last_opened_filename = new_filename;\n\tthis.settings.save();\n        this.perform_undo_or_redo = 'clear';\n        this.notify('Started new file: ' + new_filename);\n\tthis.files_changed = true;\n\tthis.file_saved = true;\n\tthis.do_toggle_popup(new_state.stack, 'files');  // close file manager\n\treturn new_state.stack;\n    }\n\n    do_select_adjacent_file(stack, offset_string) {\n        const offset = parseInt(offset_string);\n\tlet file_manager_state = this.app_component.state.file_manager_state;\n\tconst new_filename = file_manager_state.find_adjacent_filename(file_manager_state.selected_filename, offset);\n        if(new_filename) {\n\t    file_manager_state.selected_filename = new_filename;\n\t    this.files_changed = true;\n\t}\n    }\n\n    do_delete_selected_file(stack) {\n\tlet file_manager_state = this.app_component.state.file_manager_state;\n\tlet document_storage = this.app_component.state.document_storage;\n\tconst filename = file_manager_state.selected_filename;\n\tif(!filename) return this.error_flash_document();\n        if(!window.confirm(\"Really delete \\\"\" + filename + \"\\\"?\")) return;\n\tdocument_storage.delete_state(\n\t    filename,\n\t    () => {\n\t\tthis.notify('Deleted: ' + filename);\n\t\tconst new_filename = file_manager_state.find_adjacent_filename(filename, 1);\n\t\t// TODO: might need this.files_changed = true\n\t\tfile_manager_state.selected_filename = new_filename;\n\t\tthis.settings.last_opened_filename = new_filename;\n\t\tthis.settings.save();\n\t\tthis.app_component.request_file_list();\n\t    },\n\t    () => this.notify('Error deleting: ' + filename)\n\t);\n    }\n\n    do_pop_to_document(stack, arg) {\n        const [new_stack, item] = stack.pop(1);\n        this.new_document = this.app_state.document.insert_item(item);\n        return new_stack;\n    }\n\n    do_copy_to_document(stack, arg) {\n        const item = stack.peek(1);\n        this.new_document = this.app_state.document.insert_item(item);\n    }\n\n    do_recall_from_document(stack, arg) {\n        const item = this.app_state.document.selected_item();\n        if(item)\n            return stack.push(item);\n        else\n            this.error_flash_document();\n    }\n\n    do_extract_from_document(stack, arg) {\n        const item = this.app_state.document.selected_item();\n        if(item) {\n            this.new_document = this.app_state.document.delete_selection();\n            return stack.push(item);\n        }\n        else\n            this.error_flash_document();\n    }\n\n    do_edit_stack_top(stack) {\n        const item = stack.peek(1);\n        let source_text;\n        switch(item.item_type()) {\n        case 'markdown': source_text = item.source_text; break;\n        case 'expr': source_text = ['$$', item.expr.to_latex(), '$$'].join(''); break;\n        default: source_text = '???'; break;\n        }\n        this.switch_to_mode('editor');\n        this.minieditor = {active: true, text: source_text};\n    }\n\n    // Start editing a new blank item on the stack.\n    do_edit_new_item(stack) {\n\tconst new_stack = this.do_insert_markdown(stack, '');\n        this.do_edit_stack_top(new_stack);\n        return new_stack;\n    }\n\n    // Pull the item below the stack top (i.e. below the item currently being edited)\n    // into the current editor.\n    // If the imported item is a Markdown item, its text is integrated directly;\n    // otherwise an inline LaTeX fragment is created.\n    do_import_item_into_editor(stack) {\n        this.switch_to_mode('editor');\n        const [new_stack, item, edited_item] = stack.pop(2);\n        let inserted_text;\n        switch(item.item_type()) {\n        case 'markdown': inserted_text = item.source_text; break;\n        case 'expr': inserted_text = '$' + item.expr.to_latex() + '$'; break;\n        default: inserted_text = '???'; break;\n        }\n        this._insert_text_into_minieditor(inserted_text);\n        return new_stack.push(edited_item);\n    }\n\n    // Attempt to insert a text string into the active minieditor.\n    _insert_text_into_minieditor(text) {\n        if(!this.minieditor.active) return false;\n        let editor_elt = this.minieditor.ref.current;\n        if(!editor_elt) return false;\n        if(editor_elt.setRangeText)\n            editor_elt.setRangeText(text, editor_elt.selectionStart, editor_elt.selectionEnd, \"end\");\n        else {\n            // Fallback method for older browsers\n            editor_elt.focus();\n            document.execCommand('insertText', false, text);\n        }\n        return true;\n    }\n\n    do_finish_editing(stack) {\n        if(!this.minieditor.active) return;\n\tlet editor_elt = this.minieditor.ref.current;\n\tconst content = ((editor_elt ? editor_elt.value : null) || '').trim();\n        const [new_stack, old_item] = stack.pop(1);\n        this.minieditor = {active: false};\n        if(content.length > 0) {\n\t    const new_item = Item.from_string(content);\n\t    // If no textual changes were made to an Expr, just keep the old one instead of\n\t    // building a new TextExpr.  This preserves any expression structure that was there.\n\t    if(new_item.item_type() === 'expr' && old_item.item_type() === 'expr' &&\n\t       old_item.expr.to_latex() === new_item.expr.to_latex())\n\t\treturn new_stack.push(old_item);\n\t    else\n\t\treturn new_stack.push(Item.from_string(content));\n\t}\n        else\n            return new_stack;\n    }\n\n    do_cancel_editing(stack) {\n        const [new_stack, old_item] = stack.pop(1);\n        this.minieditor = {active: false};\n\n        // If the item that was being edited was an empty Markdown item, drop it from the stack now.\n        // Otherwise, leave it untouched.\n        if(old_item.item_type() === 'markdown' && old_item.is_empty())\n            return new_stack;\n        else \n            return new_stack.push(old_item);\n    }\n\n    do_insert_markdown(stack, text) {\n\treturn stack.push(new MarkdownItem(text));\n    }\n\n    do_insert(stack, text) {\n        // TODO: handle this better\n\ttext = text || '';  // handle 'insert nothing' case\n        if(text.startsWith(\"\\\\\"))\n            return stack.push_expr(new CommandExpr(text.slice(1)));\n        else\n            return stack.push_expr(new TextExpr(text));\n    }\n\n    do_self_insert(stack) {\n\treturn this.do_insert(stack, this.last_keypress);\n    }\n\n    do_insert_defer(stack) {\n\treturn stack.push_expr(new DeferExpr());\n    }\n\n    // Used for \\mathscr / \\mathcal, which only have uppercase glyphs.\n    // case_type: 'uppercase', 'lowercase'\n    // Stack top can be a ExprItem with a simple TextExpr, or else a MarkdownItem.\n    do_to_case(stack, case_type) {\n\tconst convert_fn = string => {\n\t    switch(case_type) {\n\t    case 'uppercase': return string.toUpperCase();\n\t    case 'lowercase': return string.toLowerCase();\n\t    default: return string;\n\t    }\n\t};\n\tconst [new_stack, item] = stack.pop(1);\n\tswitch(item.item_type()) {\n\tcase 'markdown':\n\t    return new_stack.push(new MarkdownItem(convert_fn(item.source_text)));\n\tcase 'expr':\n\t    {   let new_expr;\n\t\tif(item.expr.expr_type() === 'text')\n\t\t    new_expr = new TextExpr(convert_fn(item.expr.text));\n\t\telse new_expr = item.expr;\n\t\treturn new_stack.push_expr(new_expr);\n\t    }\n\tdefault:\n\t    return stack.type_error();\n\t}\n    }\n\n    // Pop arity_string items (default 1) and turn them into an Command expr.\n    do_operator(stack, opname, arity_string = '1') {\n\tconst arity = parseInt(arity_string);\n        const [new_stack, ...popped_exprs] = stack.pop_exprs(arity);\n        const result_expr = new CommandExpr(opname, popped_exprs)\n        return new_stack.push_expr(result_expr);\n    }\n\n    // \\sin{x} etc.  Works like do_operator except the argument is autoparenthesized.\n    // If superscript_text is given, the text is applied as a superscript to the function\n    // itself (not to the argument).\n    do_named_function(stack, funcname, superscript_text) {\n\tconst [new_stack, arg_expr] = stack.pop_exprs(1);\n\tlet expr;\n        // Special cases for \\sech and \\csch which are missing in LaTeX for some reason.\n\tif(funcname === 'sech' || funcname === 'csch')\n\t    expr = new CommandExpr('operatorname', [new TextExpr(funcname)]);\n\telse\n\t    expr = new CommandExpr(funcname);\n\tif(superscript_text !== undefined)\n\t    expr = new SubscriptSuperscriptExpr(expr, null, new TextExpr(superscript_text));\n\tconst result_expr = Expr.combine_pair(expr, DelimiterExpr.autoparenthesize(arg_expr));\n\treturn new_stack.push_expr(result_expr);\n    }\n\n    // Same as do_operator, except if the object the hat is being added to is a literal 'i' or 'j',\n    // or bolded i/j, it's first converted into a \\imath or \\jmath to remove the dot.\n    do_apply_hat(stack, hat_op) {\n\tlet [new_stack, expr] = stack.pop_exprs(1);\n\tif(expr.expr_type() === 'text' &&\n\t   (expr.text === 'i' || expr.text === 'j'))\n\t    expr = new CommandExpr(expr.text === 'i' ? 'imath' : 'jmath');\n\telse if(expr.expr_type() === 'command' && expr.operand_count() === 1 &&\n\t\t(expr.command_name === 'boldsymbol' || expr.command_name === 'mathbf')) {\n\t    const inner_expr = expr.operand_exprs[0];\n\t    if(inner_expr.expr_type() === 'text' &&\n\t       (inner_expr.text === 'i' || inner_expr.text === 'j'))\n\t\texpr = new CommandExpr(\n\t\t    expr.command_name,\n\t\t    [new CommandExpr(inner_expr.text === 'i' ? 'imath' : 'jmath')]);\n\t}\n\tconst result_expr = new CommandExpr(hat_op, [expr]);\n\treturn new_stack.push_expr(result_expr);\n    }\n\n    do_color(stack, colorname) {\n        let [new_stack, expr] = stack.pop_exprs(1);\n\n        // Strip off any existing \\textcolor\n        if(expr.expr_type() === 'command' &&\n           expr.command_name === 'textcolor' && expr.operand_count() === 2)\n            expr = expr.operand_exprs[1];\n\n\tconst new_expr = new CommandExpr('textcolor', [new TextExpr(colorname), expr]);\n        return new_stack.push_expr(new_expr);\n    }\n\n    do_accumulate(stack, accumulate_type) {\n        this.switch_to_mode('accumulate');\n        this.perform_undo_or_redo = 'suppress';  // (minor action)\n        return stack.push_expr(new AccumulatorExpr(accumulate_type, ''));\n    }\n\n    do_custom_delimiter(stack, delimiter_type) {\n        this.switch_to_mode('custom_delimiters');\n        if(!delimiter_type) {\n            // Start new sequence\n            this.custom_delimiters = {arity: 1};\n            return;\n        }\n        if(!this.custom_delimiters.left) {\n            this.custom_delimiters.left = delimiter_type;\n            return;\n        }\n        if(!this.custom_delimiters.right) {\n            this.custom_delimiters.right = delimiter_type;\n            if(this.custom_delimiters.arity === 1)\n                return this._finish_custom_delimiters(stack);\n            else return;\n        }\n        this.custom_delimiters.middle = delimiter_type;\n        return this._finish_custom_delimiters(stack);\n    }\n\n    do_custom_delimiter_arity(stack, arity_string) {\n        this.switch_to_mode('custom_delimiters');\n        this.custom_delimiters.arity = parseInt(arity_string);\n    }\n\n    _finish_custom_delimiters(stack) {\n        this.switch_to_mode('base');\n        const d = this.custom_delimiters;\n        const [new_stack, ...exprs] = stack.pop_exprs(d.arity);\n        const new_expr = new DelimiterExpr(d.left, d.right, d.middle, exprs);\n        this.custom_delimiters = {};\n        return new_stack.push_expr(new_expr);\n    }\n\n    // opname can be either a \\latex_command or a regular string like '+'\n    do_infix(stack, opname) {\n        const [new_stack, left_expr, right_expr] = stack.pop_exprs(2);\n        let operator_expr;\n        if(opname.startsWith(\"\\\\\"))  // TODO: handle this better\n            operator_expr = new CommandExpr(opname.slice(1));\n        else\n            operator_expr = new TextExpr(opname);\n        return new_stack.push_expr(new InfixExpr(operator_expr, left_expr, right_expr));\n    }\n\n    // Similar to do_infix but only takes 1 item from the stack and makes a PrefixExpr.\n    do_prefix(stack, opname) {\n\tconst [new_stack, base_expr] = stack.pop_exprs(1);\n\tlet operator_expr;\n        if(opname.startsWith(\"\\\\\"))  // TODO: handle this better\n            operator_expr = new CommandExpr(opname.slice(1));\n        else\n            operator_expr = new TextExpr(opname);\n\treturn new_stack.push_expr(new PrefixExpr(base_expr, operator_expr));\n    }\n\n    // Same as do_infix(..., '+'/'-') but automatically converts to infix minus/plus if the\n    // right hand side starts with a unary -.\n    do_infix_plus_or_minus(stack, opname) {\n\tlet [new_stack, left_expr, right_expr] = stack.pop_exprs(2);\n\tlet operator_expr;\n\tif(right_expr.expr_type() === 'prefix' &&\n\t   right_expr.prefix_expr.expr_type() === 'text' && right_expr.prefix_expr.text === '-') {\n\t    operator_expr = new TextExpr(opname === '-' ? '+' : '-');\n\t    right_expr = right_expr.base_expr;\n\t}\n\telse\n\t    operator_expr = new TextExpr(opname);\n\treturn new_stack.push_expr(new InfixExpr(operator_expr, left_expr, right_expr));\n    }\n\n    // Take an infix expression and another expression from the stack.\n    // Turn it into an \\overset or \\underset infix expression that stacks the expression\n    // above or below the original infix operator.\n    do_stackrel(stack, overset_op) {\n        const [new_stack, infix_expr, stacked_expr] = stack.pop_exprs(2);\n        if(infix_expr.expr_type() !== 'infix') {\n            this.error_flash_stack();\n            return;\n        }\n        const new_op_expr = new CommandExpr(overset_op, [stacked_expr, infix_expr.operator_expr]);\n        const new_expr = new InfixExpr(new_op_expr, infix_expr.left_expr, infix_expr.right_expr);\n        return new_stack.push_expr(new_expr);\n    }\n\n    do_cancel() {}\n\n    // Dummy 'command' to give explicit names to non-obvious commands for the keymap editor.\n    do_name() {}\n\n    // Concatenate two Exprs, or two Markdown texts.\n    // TODO: possibly allow Expr+Markdown too\n    do_concat(stack, concat_mode) {\n\tlet [new_stack, left_item, right_item] = stack.pop(2);\n\tif(left_item.item_type() === 'expr' && right_item.item_type() === 'expr') {\n\t    let left_expr = left_item.expr, right_expr = right_item.expr;\n            if(concat_mode === 'autoparenthesize') {\n\t\t// Parenthesize left and right arguments if they're low-precedence\n\t\t// infix expressions.  e.g.:  x+y x-y -> (x+y)(x-y)\n\t\tleft_expr = DelimiterExpr.autoparenthesize(left_expr);\n\t\tright_expr = DelimiterExpr.autoparenthesize(right_expr);\n            }\n            const new_expr = Expr.combine_pair(left_expr, right_expr);\n            return new_stack.push_expr(new_expr);\n\t}\n\telse if(left_item.item_type() === 'markdown' && right_item.item_type() === 'markdown') {\n\t    // TODO: maybe add a newline separator in between if needed.\n\t    const new_text = left_item.source_text + right_item.source_text;\n\t    return new_stack.push(new MarkdownItem(new_text));\n\t}\n\telse\n\t    return stack.type_error();\n    }\n\n    do_substitute_defer(stack) {\n\tlet [new_stack, original_expr, substitution_expr] = stack.pop_exprs(2);\n\tconst defer_expr = original_expr.find_defer();\n\tif(defer_expr) {\n\t    const new_expr = original_expr.substitute_expr(defer_expr, substitution_expr);\n\t    return new_stack.push_expr(new_expr);\n\t}\n\telse\n\t    return stack.type_error();\n    }\n\n    do_append_text_input(stack) {\n        const key = this.last_keypress;\n        const [new_stack, expr] = stack.pop_exprs(1);\n        let new_expr;\n        if(expr.expr_type() === 'accumulator') {\n\t    if(expr.is_valid_character(key))\n\t\tnew_expr = expr.with_extra_character(key);\n\t    else if(expr.accumulator_type === 'latex' && key === ' ') {\n\t\t// Special case: Space key will finish latex accumulation.\n\t\treturn this.do_finish_text_input(stack);\n\t    }\n\t    else\n\t\tnew_expr = expr;\n\t}\n        else\n            new_expr = expr;\n        this.switch_to_mode('accumulate');  // stay in text accumulation mode\n        this.perform_undo_or_redo = 'suppress';  // (minor action)\n        return new_stack.push_expr(new_expr);\n    }\n\n    do_backspace_text_input(stack) {\n        this.switch_to_mode('accumulate');  // stay in text accumulation mode\n        this.perform_undo_or_redo = 'suppress';  // (minor action)\n        const [new_stack, expr] = stack.pop_exprs(1);\n        let new_expr;\n        if(expr.expr_type() === 'accumulator') {\n            if(expr.is_empty()) {\n                // Backspace on an already-empty accumulator just drops it from the stack.\n                this.switch_to_mode('base');\n                return new_stack;\n            }\n            new_expr = expr.without_last_character();\n        }\n        else\n            new_expr = expr;\n        return new_stack.push_expr(new_expr);\n    }\n\n    // If textstyle is supplied, apply the given text style to the entered text.\n    // (currently only \"roman\" allowed)\n    do_finish_text_input(stack, textstyle) {\n        const [new_stack, expr] = stack.pop_exprs(1);\n        if(expr.expr_type() === 'accumulator') {\n            let new_expr = expr.finished_expr();\n\t    if(!new_expr)\n\t\treturn new_stack;\n\t    if(textstyle === 'roman')\n\t\tnew_expr = new CommandExpr('mathrm', [new_expr]);\n\t    return new_stack.push_expr(new_expr);\n\t}\n\telse\n\t    return new_stack;  // shouldn't normally happen\n    }\n\n    // expr_count is the number of items to pop from the stack to put inside the delimiters.\n    // It defaults to 1, but if it's 2 or more, 'middle' is used to separate each item within\n    // the delimiters.\n    do_delimiters(stack, left, right, middle, expr_count_string) {\n        const expr_count = (expr_count_string === undefined) ? 1 : parseInt(expr_count_string);\n        const [new_stack, ...inner_exprs] = stack.pop_exprs(expr_count);\n        const new_expr = new DelimiterExpr(left, right, middle, inner_exprs);\n        return new_stack.push_expr(new_expr);\n    }\n\n    // Wrap stack top in parentheses if it's not already in delimiters.\n    do_parenthesize(stack) {\n        let [new_stack, expr] = stack.pop_exprs(1);\n\n\t// Special case: \\left. X \\middle| \\right. style delimiters\n\t// are treated as a kind of pseudo-infix expression here.\n\t// This is to make things like Pr(x | y) work better when | is a\n\t// flex-size delimiter.\n\tif(expr.expr_type() === 'delimiter' && expr.left_type === '.' &&\n\t   expr.right_type === '.' && expr.inner_exprs.length > 1)\n\t    expr = new DelimiterExpr('(', ')', expr.middle_type, expr.inner_exprs);\n        else if(expr.expr_type() !== 'delimiter')\n            expr = DelimiterExpr.parenthesize(expr);\n\n        return new_stack.push_expr(expr);\n    }\n\n    do_autoparenthesize(stack) {\n\tlet [new_stack, expr] = stack.pop_exprs(1);\n\treturn new_stack.push_expr(DelimiterExpr.autoparenthesize(expr));\n    }\n\n    // Combine arguments and command name from the stack into a CommandExpr\n    do_apply_operator(stack, arg_count_string) {\n        const arg_count = parseInt(arg_count_string);\n        const [new_stack, ...exprs] = stack.pop_exprs(arg_count+1);\n        const command_expr = exprs[exprs.length-1], operand_exprs = exprs.slice(0, arg_count);\n        if(command_expr.expr_type() === 'command' && command_expr.operand_count() === 0)\n            return new_stack.push_expr(\n                new CommandExpr(command_expr.command_name, operand_exprs));\n        else\n            this.error_flash_stack();\n    }\n\n    // Take (left, right, operator) from the stack and create an InfixExpr.\n    do_apply_infix(stack) {\n        const [new_stack, left_expr, right_expr, operator_expr] = stack.pop_exprs(3);\n        const new_expr = new InfixExpr(operator_expr, left_expr, right_expr);\n        return new_stack.push_expr(new_expr);\n    }\n\n    do_toggle_popup(stack, mode_string) {\n\t// Hack: save help panel scroll position so we can restore it next\n\t// time the help is displayed.\n\tif(this.settings.popup_mode === 'help') {\n\t    const elt = document.getElementById('popup_panel');\n\t    if(elt && elt.scrollTop)\n\t\tthis.settings.help_scroll_top = elt.scrollTop;\n\t}\n\t\n\tthis.settings.popup_mode =\n\t    (this.settings.popup_mode === mode_string) ? null : mode_string;\n\tthis.settings.save();\n\tthis.app_component.apply_layout_to_dom();\n    }\n\n    // Set various configuration options.\n    do_config(stack, config_option, value) {\n\tlet settings = this.settings;\n\tlet layout = settings.layout;\n\tswitch(config_option) {\n\tcase 'zoom_factor':\n\t    switch(value) {\n\t    case '0': layout.zoom_factor = 0; break;\n\t    case '+': layout.zoom_factor++; break;\n\t    case '-': layout.zoom_factor--; break;\n\t    default: break;\n\t    }\n\t    break;\n\tcase 'math_align':\n\t    switch(value) {\n\t    case 'toggle_document':\n\t\tlayout.document_rightalign_math = !layout.document_rightalign_math;\n\t\tbreak;\n\t    case 'toggle_stack':\n\t\tlayout.stack_rightalign_math = !layout.stack_rightalign_math;\n\t\tbreak;\n\t    default:\n\t\tbreak;\n\t    }\n\t    break;\n\tcase 'stack_side':\n\t    layout.stack_side = value;\n\t    break;\n\tcase 'stack_split':\n\t    layout.stack_split = parseInt(value);\n\t    break;\n\tcase 'theme':\n\t    settings.selected_theme = value;\n\t    break;\n\tcase 'reset_layout':\n\t    settings.layout = settings.default_layout();\n\t    break;\n\tdefault:\n\t    break;\n\t}\n\tsettings.save();\n\tthis.app_component.apply_layout_to_dom();\n\tthis.clear_all_flashes();\n    }\n\n    // item1, item2, ..., N => {item1, item2, ...}\n    do_build_matrix_row(stack, matrix_type) {\n        const [new_stack, expr_count] = stack.pop_positive_integer();\n        const [new_stack_2, ...exprs] = new_stack.pop_exprs(expr_count);\n        const matrix_expr = new ArrayExpr(\n            (matrix_type || 'bmatrix'),\n            1, expr_count,\n            [exprs]\n        );\n        return new_stack_2.push_expr(matrix_expr);\n    }\n\n    // Stack two ArrayExprs on top of each other.\n    // The type of the matrix on the stack-top takes precedence if there's a conflict.\n    // The two matrices have to have the same number of columns.\n    do_stack_matrices(stack) {\n\t// TODO: allow stacking 'align' exprs, etc (where is_matrix isn't necessarily true)\n        const [new_stack, m1, m2] = stack.pop_matrices(2);\n        if(m1.column_count !== m2.column_count)\n            new_stack.type_error();\n        const new_array = new ArrayExpr(\n            m2.array_type,\n            m1.row_count + m2.row_count,\n            m1.column_count,\n            m1.element_exprs.concat(m2.element_exprs)\n\t);\n        return new_stack.push_expr(new_array);\n    }\n\n    // Split an ArrayExpr into its component rows and put them on the stack.\n    do_split_matrix(stack) {\n\t// TODO: allow non-matrix arrays here\n        const [new_stack, array_expr] = stack.pop_matrices(1);\n        return new_stack.push_all_exprs(array_expr.split_rows());\n    }\n\n    // Take apart an ArrayExpr and put all its elements on the stack (in row-major order).\n    do_dissolve_matrix(stack) {\n\t// TODO: allow non-matrix arrays here\n        const [new_stack, matrix_expr] = stack.pop_matrices(1);\n        let dissolved_exprs = [].concat(...matrix_expr.element_exprs);\n        return new_stack.push_all_exprs(dissolved_exprs);\n    }\n\n    do_insert_matrix_ellipses(stack) {\n        const [new_stack, matrix_expr] = stack.pop_matrices(1);\n        return new_stack.push_expr(matrix_expr.with_ellipses());\n    }\n\n    do_matrix_transpose(stack) {\n        const [new_stack, matrix_expr] = stack.pop_matrices(1);\n        return new_stack.push_expr(matrix_expr.transposed());\n    }\n\n    do_build_align(stack, align_type) {\n        // NOTE: if align_type = 'cases' or 'rcases', align on ':' infix if there is one, and then remove the infix\n        const [new_stack, expr_count] = stack.pop_positive_integer();\n        const [new_stack_2, ...exprs] = new_stack.pop_exprs(expr_count);\n\n        let split_mode;\n        switch(align_type) {\n        case 'gathered': case 'gather': split_mode = 'none'; break;\n        case 'cases': case 'rcases': split_mode = 'colon'; break;\n        default: split_mode = 'infix'; break;\n        }\n\n\tconst element_exprs = ArrayExpr.split_elements(exprs, split_mode)\n\tconst array_expr = new ArrayExpr(\n\t    align_type, element_exprs.length, element_exprs[0].length, element_exprs);\n        return new_stack_2.push_expr(array_expr);\n    }\n\n    // item1, item2, ..., N => \"item1, item2, ...\"\n    // (concatenate N items from the stack with separator_text between each one)\n    do_build_list(stack, separator_text, final_separator_text) {\n        const [new_stack, expr_count] = stack.pop_positive_integer();\n        const [new_stack_2, ...exprs] = new_stack.pop_exprs(expr_count);\n        let expr = exprs[0];\n        for(let i = 1; i < expr_count; i++) {\n\t    const s = (final_separator_text && i === expr_count-1) ? final_separator_text : separator_text;\n            expr = Expr.combine_pair(expr, new TextExpr(s));\n            expr = Expr.combine_pair(expr, exprs[i]);\n        }\n        return new_stack_2.push_expr(expr);\n    }\n\n    // Take [x_1,...,x_n, infix_operator, item_count] from the stack\n    // and build a nested InfixExpr.  'final_separator_text' is used as\n    // the next to last item if provided.\n    do_build_infix_list(stack, final_separator_text) {\n\tconst [new_stack, expr_count] = stack.pop_positive_integer();\n\tconst [new_stack_2, infix_operator_expr] = new_stack.pop_exprs(1);\n\tconst [new_stack_3, ...exprs] = new_stack_2.pop_exprs(expr_count);\n\tlet expr = exprs[expr_count-1];\n\tif(final_separator_text && expr_count > 1)\n\t    expr = new InfixExpr(infix_operator_expr, new TextExpr(final_separator_text), expr);\n\tfor(let i = expr_count-2; i >= 0; i--)\n\t    expr = new InfixExpr(infix_operator_expr, exprs[i], expr);\n\treturn new_stack_3.push_expr(expr);\n    }\n\n    // Take [x_1, ..., x_n, item_count] from the stack and build\n    // a \\substack{...} command.  This \"cheats\" by converting the stacked items\n    // to LaTeX and concatenating with \\\\ so any structure in the stacked items\n    // will be lost, same as do_build_list(), etc.\n    do_build_substack(stack) {\n\tconst [new_stack, expr_count] = stack.pop_positive_integer();\n\tconst [new_stack_2, ...exprs] = new_stack.pop_exprs(expr_count);\n\tconst content = exprs.map(expr => expr.to_latex()).join(\"\\\\\\\\\");\n\tconst new_expr = new CommandExpr('substack', [new TextExpr(content)]);\n\treturn new_stack_2.push_expr(new_expr);\n    }\n\n    do_apply_tag(stack) {\n\tlet [new_stack, tagged_item, tag_item] = stack.pop(2);\n\tif(tagged_item.item_type() !== 'expr')\n\t    return stack.type_error();\n\tlet tag_expr;\n\tif(tag_item.item_type() === 'markdown')\n\t    tag_expr = new CommandExpr('text', [new TextExpr(tag_item.source_text.trim())]);\n\telse if(tag_item.item_type() === 'expr')\n\t    tag_expr = tag_item.expr;\n\telse\n\t    return stack.type_error();\n\treturn new_stack.push(new ExprItem(tagged_item.expr, tag_expr));\n    }\n\n    do_copy_to_clipboard(stack) {\n\tconst [new_stack, item] = stack.pop(1);\n\tthis.app_component.state.clipboard_item = item;\n\tthis.notify(\"Copied to clipboard\");\n\treturn new_stack.push(item);\n    }\n\n    do_paste_from_clipboard(stack) {\n\tconst item = this.app_component.state.clipboard_item;\n\tif(item)\n\t    return stack.push(item);\n\telse\n\t    this.error_flash_stack();\n    }\n\n    // screen_percentage=0 means try to scroll so that the top of the selection is flush with the top of the document panel.\n    // screen_percentage=100 tries to make the bottom of the selection flush with the bottom of the panel.\n    // Anything in between is a linear interpolation between the two.\n    do_recenter_document(stack, screen_percentage_string) {\n\tconst screen_percentage = parseInt(screen_percentage_string);\n\tthis.perform_undo_or_redo = 'suppress';\n\t\n\t// TODO: Accessing the DOM elements directly like this is a hack but there's not an easy\n\t// way to get it properly from React here.  May want to restructure things to make this cleaner.\n\tlet container = document.getElementById('document_container');\n\tif(!container) return;\n\tconst selected_elts = container.getElementsByClassName('selected')\n\tif(selected_elts.length === 0) return;\n\tconst selected_elt = selected_elts[0];\n\tconst top_scrolltop = selected_elt.offsetTop;\n\tconst bottom_scrolltop = selected_elt.offsetTop + selected_elt.offsetHeight - container.clientHeight;\n\tconst ratio = screen_percentage/100;\n\tconst new_scrolltop = Math.round(top_scrolltop*(1-ratio) + bottom_scrolltop*ratio);\n\tcontainer.scrollTop = new_scrolltop;\n    }\n\n    do_scroll_popup_panel(stack, percentage_string) {\n\tlet panel_elt = document.getElementById('popup_panel');\n\tif(!panel_elt) return;\n\tconst percentage = parseInt(percentage_string || '50') / 100.0;\n\tpanel_elt.scrollTop += Math.round(panel_elt.clientHeight * percentage);\n    }\n\n    do_export_document_as_text(stack) {\n\tconst exported_text = this.app_state.document.to_text();\n\tnavigator.clipboard.writeText(exported_text);\n\tthis.notify(\"Copied document to clipboard\");\n    }\n\n    do_export_stack_top_as_text(stack) {\n\tconst [new_stack, item] = stack.pop(1);\n\tconst exported_text = item.to_text();\n\tnavigator.clipboard.writeText(exported_text);\n\tthis.notify(\"Copied stack top to clipboard\");\n\treturn new_stack.push(item)\n    }\n}\n\n\nexport default InputContext;\n\n","\n\nimport './katex.css';  // Must be imported before App.css\nimport './App.css';\n\nimport React from 'react';\n//import ReactDOM from 'react-dom';\nimport katex from 'katex';\nimport {\n    Settings, AppState, UndoStack, DocumentStorage,\n    ImportExportState, FileManagerState\n} from './Models';\nimport InputContext from './Actions';\nimport KeybindingTable from './Keymap';\n\n\nconst $e = React.createElement;\n\n\nclass App extends React.Component {\n    constructor(props) {\n        super(props);\n\n\t// NOTE: settings are stored in the localStorage, but documents use indexedDB.\n\t// This is mainly because we need the settings before the indexedDB may be ready.\n\tlet settings = Settings.load_from_local_storage();\n\n        this.state = {\n            app_state: new AppState(),\n            settings: settings,\n\t    file_manager_state: new FileManagerState(),\n\t    import_export_state: new ImportExportState(),\n\t    document_storage: new DocumentStorage(),\n            input_context: new InputContext(this, settings),\n            undo_stack: new UndoStack(),\n\t    clipboard_item: null\n        };\n        this.state.undo_stack.clear(this.state.app_state);\n\tthis.state.import_export_state.document_storage = this.state.document_storage;\n\tthis.state.import_export_state.onstatechange = () => this.import_export_state_changed();\n\n        this.handleKeyDown = this.handleKeyDown.bind(this);\n        this.handleBeforeUnload = this.handleBeforeUnload.bind(this);\n\tthis.handleVisibilityChange = this.handleVisibilityChange.bind(this);\n\n\tthis.state.document_storage.open_database(this.on_open_database.bind(this));\n    }\n\n    // Database has been opened; request the list of documents, and try to load the last-opened file.\n    on_open_database() {\n\tthis.request_file_list();\n\tif(this.state.settings.last_opened_filename)\n\t    this.start_loading_filename(this.state.settings.last_opened_filename);\n\telse {\n\t    let file_manager_state = this.state.file_manager_state;\n\t    let settings = this.state.settings;\n\t    const filename = 'untitled';\n\t    file_manager_state.current_filename = file_manager_state.selected_filename = filename;\n\t    settings.last_opened_filename = filename;\n\t    settings.save();\n\t}\n    }\n\n    file_manager_state_changed() {\n\tthis.setState({file_manager_state: this.state.file_manager_state});\n    }\n\n    import_export_state_changed() {\n\tconst import_export_state = this.state.import_export_state;\n\tthis.setState({import_export_state: import_export_state});\n\tif(import_export_state.file_list_needs_update) {\n\t    import_export_state.file_list_needs_update = false;\n\t    this.request_file_list();\n\t}\n    }\n\n    // Start loading the current list of documents from the IndexedDB database.\n    request_file_list() {\n\tthis.state.document_storage.fetch_file_list(\n\t    this.file_list_request_finished.bind(this),\n\t    this.file_list_request_error.bind(this));\n    }\n\n    file_list_request_finished(file_list) {\n\tlet file_manager_state = this.state.file_manager_state;\n\tfile_manager_state.unavailable = false;\n\tfile_manager_state.file_list = file_list;\n\tfile_manager_state.sort_file_list('filename', true);\n\tthis.setState({file_manager_state: file_manager_state});\n    }\n\n    file_list_request_error() {\n\tlet file_manager_state = this.state.file_manager_state;\n\tfile_manager_state.unavailable = true;\n\tthis.setState({file_manager_state: file_manager_state});\n    }\n\n    start_loading_filename(filename) {\n\tthis.state.document_storage.load_state(\n\t    filename,\n\t    this.file_load_finished.bind(this),\n\t    this.file_load_error.bind(this));\n    }\n\n    file_load_finished(filename, new_app_state) {\n\tconst file_manager_state = this.state.file_manager_state;\n\tconst settings = this.state.settings;\n\tfile_manager_state.selected_filename = file_manager_state.current_filename = filename;\n\tsettings.last_opened_filename = filename;\n\tsettings.save();\n\tthis.setState({app_state: new_app_state, file_manager_state: file_manager_state});\n\tthis.state.undo_stack.clear(new_app_state);\n\tthis.state.input_context.notify('Loaded: ' + filename);\n    }\n\n    // TODO: It's not necessarily an error if the file doesn't exist,\n    // but we should make sure to clear stack/document in that case\n    // (same as do_start_new_file).\n    file_load_error(filename, error) {\n\t//alert(\"Unable to load file \\\"\" + filename + \"\\\".\");\n    }\n\n    componentDidMount() {\n\tthis.apply_layout_to_dom();\n        window.addEventListener('keydown', this.handleKeyDown);\n        window.addEventListener('beforeunload', this.handleBeforeUnload);\n\twindow.addEventListener('visibilitychange', this.handleVisibilityChange);\n//\twindow.addEventListener('pageshow', this.handleVisibilityChange);\n//\twindow.addEventListener('focus', this.handleVisibilityChange);\n\tthis.request_file_list();\n    }\n\n    apply_layout_to_dom() {\n\tif(this.stack_panel_ref.current && this.document_panel_ref.current &&\n\t   this.popup_panel_ref.current) {\n\t    this.state.settings.apply_layout_to_dom(\n\t\tthis.stack_panel_ref.current, this.document_panel_ref.current,\n\t\tthis.popup_panel_ref.current);\n\t}\n    }\n\n    componentWillUnmount() {\n        window.removeEventListener('keydown', this.handleKeyDown);\n        window.removeEventListener('beforeunload', this.handleBeforeUnload);\n\twindow.removeEventListener('visibilitychange', this.handleVisibilityChange);\n//\twindow.removeEventListener('pageshow', this.handleVisibilityChange);\n//\twindow.removeEventListener('focus', this.handleVisibilityChange);\n    }\n\n    render() {\n        let app_state = this.state.app_state;\n\n\tthis.stack_panel_ref = React.createRef();\n\tthis.document_panel_ref = React.createRef();\n\tthis.popup_panel_ref = React.createRef();\n\n        return $e(\n            'div', {id: 'panel_layout', className: 'theme_' + this.state.settings.selected_theme},\n            $e('div', {className: 'panel stack_panel', id: 'stack_panel', ref: this.stack_panel_ref},\n               $e(ModeIndicatorComponent, {app_state: app_state, input_context: this.state.input_context}),\n               $e(StackItemsComponent, {\n\t\t   settings: this.state.settings,\n\t\t   stack: app_state.stack,\n\t\t   input_context: this.state.input_context\n\t       })),\n            $e('div', {className: 'panel document_panel', id: 'document_panel', ref: this.document_panel_ref},\n\t       $e('div', {id: 'document_container'},\n\t\t  $e(DocumentComponent, {\n\t\t      settings: this.state.settings,\n\t\t      document: app_state.document,\n\t\t      filename: this.state.file_manager_state.current_filename,\n\t\t      is_dirty: app_state.is_dirty  /* TODO: revisit, maybe remove this */\n\t\t  }))),\n\t    $e(PopupPanelComponent, {\n\t\tsettings: this.state.settings,\n\t\tpopup_panel_ref: this.popup_panel_ref,\n\t    \timport_export_state: this.state.import_export_state,\n\t    \tdocument_storage: this.state.document_storage,\n\t    \tfile_manager_state: this.state.file_manager_state\n\t    })\n\t);\n    }\n\n    handleKeyDown(event) {\n\t// No Alt/Meta key combinations are handled.\n\tif(event.altKey || event.metaKey)\n\t    return;\n        const key = this._keyname_from_event(event);\n        let app_state = this.state.app_state;\n        let [was_handled, new_app_state] = this.state.input_context.handle_key(app_state, key);\n        if(was_handled) {\n            event.preventDefault();\n            // TODO: event.stopPropagation();\n            const scratch = this.manage_undo_state(new_app_state);\n            if(scratch)\n                new_app_state = scratch;\n            else   // undo/redo \"failed\"\n                this.state.input_context.error_flash_stack();\n\n\t    let state_updates = {app_state: new_app_state};\n\t    if(this.state.input_context.files_changed) {\n\t\tthis.request_file_list();\n\t\tstate_updates.file_manager_state = this.state.file_manager_state;  // TODO: revisit\n\t    }\n            this.setState(state_updates);\n\t}\n    }\n\n    _keyname_from_event(event) {\n        let key = event.key;\n\n        if((key.startsWith('Arrow') || key === 'Enter' || key === 'Backspace') && event.shiftKey)\n            key = 'Shift+' + key;\n        if(event.ctrlKey)\n            key = 'Ctrl+' + key;\n\n        // NOTE: none of the Alt stuff works on Firefox for some reason.  Chromium seems ok.\n        // if(event.metaKey || event.altKey || event.getModifierState('Alt') || event.getModifierState('Meta'))\n\t//     key = 'Alt+' + key;\n\n        return key;\n    }\n\n    // Auto-save when window is being closed.\n    handleBeforeUnload(event) {\n\tconst filename = this.state.file_manager_state.current_filename;\n        if(filename)\n\t    this.state.document_storage.save_state(this.state.app_state, filename);\n        return null;\n    }\n\n    // On iOS Safari, this event is triggered when resuming the tab.\n    // When this happens, the scroll positions are reset, but a re-render takes care of that\n    // via DocumentComponent.ensure_selection_visible().\n    handleVisibilityChange(event) {\n\tthis.setState({});  // force React to re-render\n    }\n\n    // Returns 'new' new_app_state.\n    manage_undo_state(new_app_state) {\n        let undo_stack = this.state.undo_stack;\n        switch(this.state.input_context.perform_undo_or_redo) {\n        case 'undo': return undo_stack.undo_state();\n        case 'redo': return undo_stack.redo_state();\n        case 'suppress': return new_app_state;  // Normal action, but don't remember undo state.\n        case 'clear':\n            undo_stack.clear(new_app_state);\n            return new_app_state;\n        default:\n            // Normal action; save undo state\n            undo_stack.push_state(new_app_state);\n            return new_app_state;\n        }\n    }\n}\n\n\n// Shows current input mode in top-right corner of stack display\nclass ModeIndicatorComponent extends React.Component {\n    render() {\n\tlet indicator_item = undefined;\n\tconst notification_text = this.props.input_context.notification_text;\n\tif(notification_text) {\n\t    // Auto-highlight anything after the colon in the notification message.\n\t    const colon = notification_text.indexOf(':');\n\t    if(colon >= 0)\n\t\tindicator_item = $e(\n\t\t    'span', {className: 'notification'},\n\t\t    $e('span', {}, notification_text.slice(0, colon+1)),\n\t\t    $e('span', {className: 'highlighted'}, notification_text.slice(colon+1)));\n\t    else\n\t\tindicator_item = $e('span', {className: 'notification'}, notification_text);\n\t}\n\telse if(this.props.input_context.mode !== 'base')\n            indicator_item = $e(\n\t\t'span', {className: 'mode'},\n\t\tthis.props.input_context.mode.replaceAll('_', ' '));\n\treturn $e('div', {className: 'indicator'}, indicator_item);\n    }\n}\n\n\nclass StackItemsComponent extends React.Component {\n    render() {\n        let input_context = this.props.input_context;\n        const minieditor_active = input_context.minieditor.active;\n        const minieditor_index = this.props.stack.items.length-1;\n        const item_components = this.props.stack.items.map((item, index) => {\n            if(minieditor_active && index === minieditor_index) {\n                // This is the item currently being edited; display a textarea instead of the item itself.\n                // We need access to the textarea DOM node later (for setting the focus).\n                input_context.minieditor.ref = React.createRef();\n                return $e(\n\t\t    MiniEditorComponent, {\n\t\t\ttextarea_ref: input_context.minieditor.ref,\n\t\t\tinput_context: input_context,\n\t\t\tkey: 'minieditor'\n                    });\n            }\n            else {\n                return $e(\n                    ItemComponent, {\n                        item: item,\n                        selected: false,  // TODO (selecting stack items not implemented yet)\n\t\t\titem_ref: React.createRef(),\n                        key: item.react_key(index)\n                    });\n            }\n        });\n\tlet class_names = ['stack_items'];\n\tif(this.props.settings.layout.stack_rightalign_math)\n\t    class_names.push('rightalign_math');\n        return $e('div', {className: class_names.join(' ')}, item_components);\n    }\n}\n\n\nclass DocumentComponent extends React.Component {\n    render() {\n        const document = this.props.document;\n        const subcomponents = document.items.map((item, index) => {\n\t    let item_ref = React.createRef();\n            const is_selected = document.selection_index === index+1;\n\t    if(is_selected) this.selected_item_ref = item_ref;\n            return $e(\n                ItemComponent, {\n                    item: item,\n                    selected: is_selected,\n                    item_ref: item_ref,\n                    key: item.react_key(index)\n                });\n        });\n\n\t// \"Spacer\" after the last document item.  This enables the document view to scroll\n\t// a little past the end so that we don't force the last document item to be flush\n\t// against the bottom of the screen.\n\tsubcomponents.push(\n\t    $e('div', {className: 'bottom_spacer', key: 'bottom_spacer'}));\n\n        // Top of document selection indicator.\n\tconst top_is_selected = document.selection_index === 0;\n        const class_name = 'selection_indicator' + (top_is_selected ? ' visible' : '');\n\tconst filename = (this.props.filename || '???') + (this.props.is_dirty ? '*' : '');\n\tif(top_is_selected)\n\t    this.selected_item_ref = React.createRef();\n        const selection_indicator = $e(\n\t    'div', {\n\t\tclassName: class_name,\n\t\tkey: 'selection_indicator',\n\t\tref: top_is_selected ? this.selected_item_ref : null\n\t    },\n\t    this.props.filename && $e('span', {}, '[ '),\n\t    this.props.filename && $e('span', {className: 'filename'}, filename),\n\t    this.props.filename && $e('span', {}, ' ]')\n\t);\n        \n\tlet class_names = ['document_items'];\n\tif(this.props.settings.layout.document_rightalign_math)\n\t    class_names.push('rightalign_math');\n        return $e('div', {className: class_names.join(' ')},\n\t\t  [selection_indicator].concat(subcomponents));\n    }\n\n    componentDidUpdate() {\n\tthis.ensure_selection_visible();\n    }\n\n    ensure_selection_visible() {\n\tif(!this.selected_item_ref) return;\n        const item = this.selected_item_ref.current;\n\tif(!item) return;\n        let container = document.getElementById('document_container');\n        const extra_space = item.offsetHeight/2;\n        if(item.offsetTop < container.scrollTop)\n            container.scrollTop = item.offsetTop - extra_space;\n        if(item.offsetTop + item.offsetHeight > container.scrollTop + container.offsetHeight)\n            container.scrollTop = item.offsetTop + item.offsetHeight - container.offsetHeight + extra_space;\n    }\n}\n\n\nclass MiniEditorComponent extends React.Component {\n    render() {\n        return $e('textarea', {\n            className: 'minieditor',\n            onInput: this.handleOnInput.bind(this),\n\t    spellCheck: 'false',\n            ref: this.props.textarea_ref\n        });\n    }\n\n    handleOnInput(event) {\n        const content = this.props.textarea_ref.current.value;\n        this.props.input_context.minieditor.text = content;\n    }\n\n    componentDidMount() {\n        let textarea = this.props.textarea_ref.current;\n        const initial_text = this.props.input_context.minieditor.text;\n        if(initial_text) textarea.value = initial_text; \n        textarea.focus();\n    }\n}\n\n\nclass FileManagerComponent extends React.Component {\n    render() {\n\tconst show_import_export = !this.props.file_manager_state.unavailable;\n\tthis.file_input_ref = React.createRef();\n        return $e(\n            'div', {className: 'file_header', id: 'files_panel'},\n\t    $e('h2', {}, 'File Manager'),\n            this.render_file_table(),\n\t    this.render_shortcuts(),\n\t    show_import_export && $e('h2', {}, 'Export/Import'),\n\t    show_import_export && this.render_export_import_section()\n        );\n    }\n\n    render_export_import_section() {\n\tconst import_export_state = this.props.import_export_state;\n\tlet subcomponents = [];\n\n\tsubcomponents.push(\n\t    $e('p', {}, 'This section lets you download the internal browser document storage as a .zip file, or restore the internal storage from a previously downloaded export.'));\n\n\tsubcomponents.push(\n\t    $e('p', {},\n\t       $e('strong', {}, import_export_state.textual_state())));\n\n\tif(import_export_state.state === 'idle')\n\t    subcomponents.push(\n\t\t$e('p', {},\n\t\t   $e('a', {\n\t\t       href: '#',\n\t\t       onClick: this.start_exporting.bind(this)\n\t\t   }, 'Prepare Export')));\n\tif(import_export_state.download_available()) {\n\t    const export_filename = import_export_state.generate_download_filename();\n\t    subcomponents.push(\n\t\t$e('p', {},\n\t\t   $e('a', {href: import_export_state.download_url, download: export_filename},\n\t\t      'Download: ' + export_filename)));\n\t}\n\n\t// Show file upload element if ready to accept uploads.\n\tif(import_export_state.state === 'idle') {\n\t    subcomponents.push(\n\t\t$e('p', {},\n\t\t   $e('span', {}, 'Import Zip File: '),\n\t\t   $e('input', {\n\t\t       type: 'file',\n\t\t       ref: this.file_input_ref\n\t\t   }),\n\t\t   $e('input', {\n\t\t       type: 'button',\n\t\t       value: 'Upload',\n\t\t       onClick: this.handle_file_upload.bind(this)\n\t\t   })));\n\t}\n\n\t// Show import results when import finished.\n\tif(import_export_state.state === 'idle' && import_export_state.import_result_string)\n\t    subcomponents.push(\n\t\t$e('p', {},\n\t\t   $e('span', {style: {fontWeight: 'bold'}}, 'Import result: '),\n\t\t   $e('span', {}, import_export_state.import_result_string)));\n\t\n\treturn $e('div', {}, ...subcomponents);\n    }\n\n    render_file_table() {\n\tconst file_manager_state = this.props.file_manager_state;\n\tif(file_manager_state.unavailable)\n\t    return $e('p', {}, 'IndexedDB support unavailable in your browser.  You will be unable to save or load documents.  Note that Firefox disables IndexedDB when in Private Browsing mode.');\n\telse if(file_manager_state.file_list && file_manager_state.file_list.length > 0) {\n\t    return $e(\n\t\t'div', {},\n\t\t$e('table', {className: 'file_table'},\n\t\t   $e('thead', {},\n\t\t      $e('tr', {},\n\t\t\t $e('th', {className: 'filename'}, 'Filename'),\n\t\t\t $e('th', {className: 'filesize', colSpan: '2'}, 'Size'),\n\t\t\t $e('th', {className: 'timestamp', colSpan: '2'}, 'Last Modified'))),\n\t\t   $e('tbody', {},\n\t\t      file_manager_state.file_list.map(\n\t\t\t  (file, index) => this._render_file_list_row(file, index)))));\n\t}\n\telse if(file_manager_state.file_list)\n\t    return $e('p', {}, 'No files created yet.');\n\telse\n\t    return $e('p', {}, 'Fetching file list...');\n    }\n\n    _render_file_list_row(file, index) {\n\tconst file_manager_state = this.props.file_manager_state;\n\tlet class_names = [];\n\tif(file.filename === file_manager_state.selected_filename) class_names.push('selected_file');\n\tif(file.filename === file_manager_state.current_filename) class_names.push('current_file');\n\tconst item_count = file.document_item_count + file.stack_item_count;\n\treturn $e(\n\t    'tr', {className: class_names.join(' '), key: 'file_' + file.filename},\n\t    $e('td', {className: 'filename'}, file.filename),\n\t    $e('td', {className: 'filesize'},\n\t       Math.floor((file.filesize+1023)/1024) + ' kb'),\n\t    $e('td', {className: 'filesize'},\n\t       item_count + ' object' + (item_count === 1 ? '' : 's')),\n\t    $e('td', {className: 'timestamp'}, file.timestamp.toLocaleDateString()),\n\t    $e('td', {className: 'timestamp'}, file.timestamp.toLocaleTimeString()));\n    }\n\n    render_shortcuts() {\n\tconst current_filename = this.props.file_manager_state.current_filename;\n\tconst help_specs = [\n\t    ['Escape', 'Close file manager'],\n\t    ['Arrows', 'Select next/previous file'],\n\t    ['Enter', 'Open selected file'],\n\t    ['d', 'Delete selected file'],\n\t    ['n', 'Start a new empty file'],\n\t    ['s', 'Save current file' + (current_filename ? (' (' + current_filename + ')') : '')],\n\t    ['S', 'Save as...']\n\t];\n\tconst keyhelp_elements = help_specs.map(spec => {\n\t    const [keyname, helptext] = spec;\n\t    return $e(\n\t\t'li', {},\n\t\t$e('span', {className: 'keybinding'}, keyname),\n\t\t$e('span', {}, ' ' + helptext));\n\t});\n\treturn $e('ul', {className: 'keybindings'}, ...keyhelp_elements);\n    }\n\n    handle_file_upload(event) {\n\tconst file_input_elt = this.file_input_ref.current;\n\tif(!file_input_elt) return;\n\tconst file_list = file_input_elt.files;\n\tif(file_list.length === 1)\n\t    this.start_importing(file_list[0]);\n\telse if(file_list.length > 1)\n\t    alert('Please select a single .zip file to import.');\n\telse\n\t    alert('Please select a .zip file to import.');\n    }\n\n    start_importing(file) {\n\tconst import_export_state = this.props.import_export_state;\n\tif(import_export_state.state === 'idle')\n\t    import_export_state.start_importing(file);\n    }\n\n    start_exporting() {\n\tconst import_export_state = this.props.import_export_state;\n\tif(import_export_state.state === 'idle')\n\t    import_export_state.start_exporting();\n    }\n}\n\n\n// Displays an Item instance in any context (stack/document).\n// Props: {item: Item, selected: Bool}\nclass ItemComponent extends React.Component {\n    render() {\n        let item = this.props.item;\n        let ref = this.props.item_ref;\n        const className = this.props.selected ? 'selected ' : '';\n        switch(item.item_type()) {\n        case 'expr':\n\t    if(item.tag_expr) {\n\t\tthis.tag_ref = React.createRef();\n\t\treturn $e(\n\t\t    'div', {className: 'expr_item'},\n\t\t    $e('div', {className: 'tag_expr', ref: this.tag_ref}, ''),\n\t\t    $e('div', {className: className + 'latex_fragment', ref: ref}, ''));\n\t    }\n\t    else \n\t\treturn $e(\n\t\t    'div', {className: 'expr_item'},\n\t\t    $e('div', {className: className + 'latex_fragment', ref: ref}, ''));\n        case 'markdown':\n            return $e('div', {\n                className: className + 'markdown',\n                dangerouslySetInnerHTML: { __html: item.rendered_html },\n                ref: ref\n            });\n        default:\n            return $e('div', {}, '????');\n        }\n    }\n\n    componentDidMount() {\n        let item = this.props.item;\n\tlet node = this.props.item_ref.current;\n\tif(!node) return;  // shouldn't happen\n        if(item.item_type() === 'expr') {\n            // Render math with KaTeX\n            this._render_with_katex(item.expr.to_latex(), node, true);\n\t    if(item.tag_expr && this.tag_ref.current)\n\t\tthis._render_with_katex(item.tag_expr.to_latex(), this.tag_ref.current, false);\n        }\n        else if(item.item_type() === 'markdown') {\n            // Render <code> elements with KaTeX\n            let children = node.getElementsByTagName('code');\n            for(let i = 0; i < children.length; i++) {\n                let codespan = children[i];\n                const latex_code = codespan.textContent || '';\n                this._render_with_katex(latex_code, codespan, false);\n            }\n        }\n    }\n\n    _render_with_katex(latex_code, node, display_mode) {\n        if(latex_code === '' || latex_code === \"\\\\,\") {\n            // Empty/blank latex expression - fake it with something so that it's visible.\n            latex_code = \"\\\\htmlClass{defer_expr}{\\\\square}\";\n        }\n\ttry {\n\t    // NOTE: trust: true here allows the use of \\htmlClass etc.\n            katex.render(\n\t\tlatex_code, node,\n\t\t{ throwOnError: false, displayMode: display_mode, fleqn: true, trust: true });\n\t}\n\tcatch(e) {\n\t    // KaTeX throws actual errors for some inputs, even if throwOnError is false.\n\t    // Example: \\texttt{\\textbf{test}}\n\t    const msg = e.toString();\n\t    node.innerHTML = '<div style=\"color:red;\">' + msg + '</div>';\n\t}\n    }\n}\n\n\nclass PopupPanelComponent extends React.Component {\n    render() {\n\tthis.refs = {\n\t    help: React.createRef(),\n\t    help_content: React.createRef()\n\t};\n\tconst popup_mode = this.props.settings.popup_mode;\n\tlet subcomponent = null;\n\tif(popup_mode === 'files') {\n\t    subcomponent = $e(\n\t\t'div', {id: 'files_container'},\n\t\t$e(FileManagerComponent, {\n\t\t    import_export_state: this.props.import_export_state,\n\t\t    document_storage: this.props.document_storage,\n\t\t    file_manager_state: this.props.file_manager_state\n\t\t}));\n\t}\n\telse if(popup_mode === 'keymap') {\n\t    subcomponent = $e(\n\t\t'div', {id: 'keymap_container'},\n\t\t$e(KeymapTableComponent, {keymap: KeybindingTable})\n\t    );\n\t}\n\treturn $e(\n\t    'div', {id: 'popup_panel', ref: this.props.popup_panel_ref},\n\t    subcomponent,\n\t    $e('div', {id: 'help_container', ref: this.refs.help},\n\t       $e('div', {className: 'help', ref: this.refs.help_content})));\n    }\n\n    componentDidMount() {\n\tlet help_source_elt = document.getElementById('helptext');\n\tlet help_dest_elt = this.refs.help_content.current;\n\tif(help_source_elt) {\n\t    help_source_elt.style.display = 'block';\n\t    this._render_help_latex(help_source_elt);\n\t    help_source_elt.parentNode.removeChild(help_source_elt);\n\t    help_dest_elt.appendChild(help_source_elt);\n\t}\n    }\n\n    componentDidUpdate() {\n\tconst mode = this.props.settings.popup_mode;\n\tif(this.refs.help.current)\n\t    this.refs.help.current.style.display = (mode === 'help' ? 'block' : 'none');\n\tif(mode === 'help' &&\n\t   this.props.settings.help_scroll_top !== undefined &&\n\t   this.props.popup_panel_ref.current) {\n\t    // Restore helptext scroll position previously saved by 'do_toggle_popup'.\n\t    this.props.popup_panel_ref.current.scrollTop = this.props.settings.help_scroll_top;\n\t    this.props.settings.help_scroll_top = undefined;\n\t}\n    }\n\n    // Render any <code>...</code> spans in the help text with KaTeX.\n    _render_help_latex(help_elt) {\n        let children = help_elt.getElementsByTagName('code');\n        for(let i = 0; i < children.length; i++) {\n            let code_elt = children[i];\n            const latex_code = code_elt.textContent;\n            if(latex_code)\n                katex.render(latex_code, code_elt,\n                             { throwOnError: false, displayMode: false });\n        }\n    }\n}\n\n\nclass KeymapTableComponent extends React.Component {\n    render() {\n\treturn $e(\n\t    'table', {className: 'keymap'},\n\t    $e('thead', {},\n\t       $e('tr', {},\n\t\t  $e('th', {className: 'mode'}, 'Mode'),\n\t\t  $e('th', {className: 'keyname'}, 'Key'),\n\t\t  $e('th', {className: 'command'}, 'Command'))),\n\t    $e('tbody', {}, this.render_rows()));\n    }\n\n    render_rows() {\n\tconst modes = this.get_sorted_mode_names();\n\tconst sections = modes.map(mode => this.rows_for_mode(mode));\n\treturn [].concat(...sections);\n    }\n\n    get_sorted_mode_names() {\n\tconst keymap = this.props.keymap;\n\tlet modes = [...Object.keys(keymap)];\n\tmodes.sort();\n\treturn modes;\n    }\n\n    rows_for_mode(mode) {\n\tconst entries = this.props.keymap[mode];\n\tlet keys = [...Object.keys(entries)];\n\tkeys.sort();\n\treturn keys.map(key => this.row_for_mode_and_key(mode, key, entries[key]));\n    }\n\n    row_for_mode_and_key(mode, key, command) {\n\tconst react_key = mode + '_' + key;\n\n\t// If command starts with 'name ...', show the given name in italics instead of the actual command sequence.\n\tlet command_elt;\n\tif(command.startsWith('name ') && command.indexOf(';'))\n\t    command_elt = $e('em', {}, command.slice(5, command.indexOf(';')));\n\telse\n\t    command_elt = $e('span', {}, command);\n\t\n\treturn $e(\n\t    'tr', {key: react_key},\n\t    $e('td', {className: 'mode'}, mode),\n\t    $e('td', {className: 'keyname'},\n\t       $e('span', {className: 'keybinding'}, key)),\n\t    $e('td', {className: 'command'}, command_elt));\n    }\n}\n\n\n// ReactDOM.render(\n//     $e(App, {}),\n//     document.getElementById('root')\n// );\n    \n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://cra.link/PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://cra.link/PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://cra.link/PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log('No internet connection found. App is running in offline mode.');\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then((registration) => {\n        registration.unregister();\n      })\n      .catch((error) => {\n        console.error(error.message);\n      });\n  }\n}\n","\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\n\nimport * as serviceWorkerRegistration from './serviceWorkerRegistration';\n\n\n//import reportWebVitals from './reportWebVitals';\n\n// ReactDOM.render(\n//   <React.StrictMode>\n//     <App />\n//   </React.StrictMode>,\n//   document.getElementById('root')\n// );\n\nReactDOM.render(\n  <App />,\n  document.getElementById('root')\n);\n\nserviceWorkerRegistration.register();\n\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\n//reportWebVitals();\n"],"sourceRoot":""}